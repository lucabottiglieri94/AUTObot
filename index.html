<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Auto News</title>
  <style>
    :root{
      --bg:#0b0f1a;
      --panel:#111827;
      --line:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#3b82f6;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    header{
      position:sticky;
      top:0;
      background:rgba(11,15,26,.9);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
      z-index:10;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{font-weight:800;letter-spacing:.2px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{
      border:1px solid var(--line);
      background:var(--panel);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-size:14px;
      transition:all 0.2s;
    }
    .btn:hover{
      border-color:rgba(59,130,246,.6);
      background:rgba(17,24,39,.9);
    }
    .btn.primary{
      border-color:rgba(59,130,246,.5);
      background:rgba(37,99,235,.15);
    }
    .btn.primary:hover{
      background:rgba(37,99,235,.25);
    }
    .btn:disabled{opacity:.6;cursor:not-allowed}
    main .card{
      margin-top:16px;
      background:rgba(17,24,39,.75);
      border:1px solid var(--line);
      border-radius:16px;
      padding:16px;
    }
    .muted{color:var(--muted)}
    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(17,24,39,.35);
      font-size:12px;
    }
    #newsList{display:grid;gap:12px;margin-top:12px}
    .newsItem{
      display:block;
      padding:14px;
      border:1px solid var(--line);
      border-radius:14px;
      text-decoration:none;
      color:inherit;
      background:rgba(17,24,39,.35);
      transition:all 0.2s;
    }
    .newsItem:hover{
      border-color:rgba(59,130,246,.6);
      background:rgba(17,24,39,.55);
    }
    .newsTitle{font-weight:800;margin-bottom:8px}
    .newsMeta{opacity:.75;font-size:12px;margin-top:6px}
    .newsDate{opacity:.75;font-size:12px;margin-top:6px;font-style:italic}
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="row">
        <div class="brand">
          <span>üöó Auto News</span>
          <button id="fiatBtn" class="btn">Fiat</button>
          <button id="jeepBtn" class="btn">Jeep</button>
        </div>

        <div class="row" style="gap:10px">
          <span id="userPill" class="pill muted">Non autenticato</span>
          <button id="loginBtn" class="btn primary">Login Google</button>
          <button id="logoutBtn" class="btn" style="display:none">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="row">
        <div>
          <div style="font-weight:800;font-size:18px">üì∞ Ultime News</div>
          <div class="muted" style="margin-top:6px">Visibili solo dopo login.</div>
        </div>
        <button id="refreshBtn" class="btn" disabled>üîÑ Aggiorna</button>
      </div>

      <div id="status" class="muted" style="margin-top:12px">
        Effettua il login per caricare le news.
      </div>
      <div id="newsList"></div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth,
      setPersistence,
      browserLocalPersistence,
      browserSessionPersistence,
      GoogleAuthProvider,
      signInWithPopup,
      signInWithRedirect,
      getRedirectResult,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    // ================== CONFIGURAZIONE ==================
    const BACKEND_NEWS = "/api/news";

    const BRAND_LINKS = {
      Fiat: "https://www.fiat.it/omni/configuratore/#/",
      Jeep: "https://www.jeep-official.it/omni/configuratore"
    };

    const firebaseConfig = {
      apiKey: "AIzaSyALsFF_dpL39GlPfMyKBFIKtZi5coOk9I8",
      authDomain: "auto-1af60.firebaseapp.com",
      projectId: "auto-1af60",
      storageBucket: "auto-1af60.firebasestorage.app",
      messagingSenderId: "498320258984",
      appId: "1:498320258984:web:bac67d7634273d10464f9d",
      measurementId: "G-WYM78KQWQJ"
    };

    // ================== UTILITY FUNCTIONS ==================
    const $ = (id) => document.getElementById(id);
    const setStatus = (t) => { $("status").textContent = t; };

    function escapeHtml(s = "") {
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function safeHost(url) {
      try { return new URL(url).hostname; } catch { return ""; }
    }

    function fmtDate(d) {
      if (!d) return "";
      const dt = new Date(d);
      if (Number.isNaN(dt.getTime())) return String(d);
      return dt.toLocaleString("it-IT", { 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit' 
      });
    }

    function renderItems(items) {
      const box = $("newsList");
      if (!items || !items.length) {
        box.innerHTML = '<div class="muted" style="padding:20px;text-align:center">Nessuna news disponibile.</div>';
        setStatus("Nessuna news trovata.");
        return;
      }
      
      box.innerHTML = items.map(n => {
        const link = n.url || n.link || "";
        const title = n.title || "Senza titolo";
        const date = fmtDate(n.date || n.pubDate || "");
        const host = safeHost(link);
        
        return `
          <a class="newsItem" href="${escapeHtml(link)}" target="_blank" rel="noopener noreferrer">
            <div class="newsTitle">${escapeHtml(title)}</div>
            ${host ? `<div class="newsMeta">üìç ${escapeHtml(host)}</div>` : ''}
            ${date ? `<div class="newsDate">üïê ${escapeHtml(date)}</div>` : ""}
          </a>
        `;
      }).join("");
      
      setStatus(`‚úÖ ${items.length} news caricate - ${new Date().toLocaleString("it-IT")}`);
    }

    // ================== FIREBASE INITIALIZATION ==================
    console.log("üî• Inizializzazione Firebase...");
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    
    // Provider Google
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ 
      prompt: "select_account",
      // Forza il popup su alcuni browser
      display: 'popup'
    });

    // Variabile per tracciare se stiamo usando popup o redirect
    let usePopup = false;

    // ================== SETUP ASYNC ==================
    (async function initApp() {
      console.log("üì± URL corrente:", window.location.href);
      
      // Test storage disponibilit√†
      try {
        localStorage.setItem('__test', 'test');
        localStorage.removeItem('__test');
        console.log("‚úÖ localStorage disponibile");
      } catch(e) {
        console.error("‚ùå localStorage NON disponibile:", e);
        alert("‚ö†Ô∏è Il browser sta bloccando localStorage. Controlla le impostazioni dei cookie/privacy.");
      }

      // Imposta persistenza
      try {
        await setPersistence(auth, browserLocalPersistence);
        console.log("‚úÖ Persistenza configurata: LOCAL");
      } catch (e) {
        console.error("‚ö†Ô∏è Errore persistenza LOCAL, provo SESSION:", e);
        try {
          await setPersistence(auth, browserSessionPersistence);
          console.log("‚úÖ Persistenza configurata: SESSION");
        } catch (e2) {
          console.error("‚ùå Errore persistenza:", e2);
          setStatus("‚ö†Ô∏è Login potrebbe non persistere: " + (e2.code || e2.message));
        }
      }

      // Gestisci risultato redirect
      try {
        console.log("üîç Controllo redirect result...");
        const result = await getRedirectResult(auth);
        if (result?.user) {
          console.log("‚úÖ Login completato da redirect:", result.user.email);
          console.log("User UID:", result.user.uid);
          setStatus("‚úÖ Login riuscito! Benvenuto " + result.user.email);
        } else {
          console.log("‚ÑπÔ∏è Nessun redirect result (normale se non hai appena fatto login)");
        }
      } catch (e) {
        console.error("‚ùå Errore redirect:", e);
        console.error("Codice errore:", e.code);
        console.error("Messaggio:", e.message);
        setStatus("‚ùå Errore login: " + (e.code || e.message));
        
        // Se errore √® legato al redirect, prova con popup la prossima volta
        if (e.code === 'auth/unauthorized-domain' || 
            e.code === 'auth/operation-not-allowed' ||
            e.code === 'auth/cancelled-popup-request') {
          console.log("‚ö†Ô∏è Errore redirect, user√≤ popup al prossimo tentativo");
          usePopup = true;
        }
      }

      // Controlla stato iniziale
      const currentUser = auth.currentUser;
      if (currentUser) {
        console.log("‚úÖ Utente gi√† autenticato:", currentUser.email);
      } else {
        console.log("‚ÑπÔ∏è Nessun utente autenticato");
      }
    })();

    // ================== CARICAMENTO NEWS ==================
    async function loadNews() {
      const user = auth.currentUser;
      if (!user) {
        $("newsList").innerHTML = "";
        setStatus("üîí Effettua il login per vedere le news.");
        return;
      }

      console.log("üì° Caricamento news per:", user.email);
      setStatus("‚è≥ Caricamento news...");
      $("refreshBtn").disabled = true;

      try {
        const response = await fetch(BACKEND_NEWS, {
          method: "GET",
          headers: { 'Cache-Control': 'no-cache' },
          cache: "no-store"
        });

        console.log("üì° Response status:", response.status);

        if (!response.ok) {
          const errorText = await response.text().catch(() => "");
          throw new Error(`HTTP ${response.status}${errorText ? ' - ' + errorText : ''}`);
        }

        const data = await response.json();
        console.log("‚úÖ Dati ricevuti:", data);
        
        if (data.items && Array.isArray(data.items)) {
          renderItems(data.items);
        } else if (Array.isArray(data)) {
          renderItems(data);
        } else {
          throw new Error("Formato dati non valido");
        }
      } catch (err) {
        console.error("‚ùå Errore caricamento news:", err);
        $("newsList").innerHTML = '<div class="muted" style="padding:20px;text-align:center">‚ùå Errore caricamento news</div>';
        setStatus("‚ùå Errore: " + (err?.message || err));
      } finally {
        $("refreshBtn").disabled = !auth.currentUser;
      }
    }

    // ================== EVENT LISTENERS ==================
    $("loginBtn").addEventListener("click", async () => {
      console.log("üîê Tentativo login...");
      
      try {
        setStatus("üîê Apertura login Google...");
        
        // PROVA PRIMA CON POPUP (pi√π affidabile su alcuni browser)
        try {
          console.log("ü™ü Tentativo con POPUP...");
          const result = await signInWithPopup(auth, provider);
          console.log("‚úÖ Login popup riuscito:", result.user.email);
          setStatus("‚úÖ Login riuscito! Benvenuto " + result.user.email);
        } catch (popupError) {
          console.warn("‚ö†Ô∏è Popup fallito:", popupError.code);
          
          // Se il popup √® bloccato o fallisce, usa redirect
          if (popupError.code === 'auth/popup-blocked' || 
              popupError.code === 'auth/popup-closed-by-user' ||
              popupError.code === 'auth/cancelled-popup-request') {
            console.log("üîÑ Fallback a REDIRECT...");
            setStatus("üîÑ Reindirizzamento in corso...");
            await signInWithRedirect(auth, provider);
          } else {
            throw popupError;
          }
        }
      } catch (e) {
        console.error("‚ùå Errore login:", e);
        console.error("Codice:", e.code);
        console.error("Messaggio:", e.message);
        
        let errorMsg = "Errore sconosciuto";
        if (e.code === 'auth/unauthorized-domain') {
          errorMsg = "Dominio non autorizzato in Firebase Console";
        } else if (e.code === 'auth/popup-blocked') {
          errorMsg = "Popup bloccato dal browser";
        } else {
          errorMsg = e.code || e.message;
        }
        
        setStatus("‚ùå " + errorMsg);
      }
    });

    $("logoutBtn").addEventListener("click", async () => {
      console.log("üëã Logout...");
      try {
        const email = auth.currentUser?.email;
        await signOut(auth);
        console.log("‚úÖ Logout completato:", email);
        $("newsList").innerHTML = "";
        setStatus("üëã Logout effettuato.");
      } catch (e) {
        console.error("‚ùå Errore logout:", e);
        setStatus("‚ùå Errore logout: " + (e.code || e.message));
      }
    });

    $("refreshBtn").addEventListener("click", () => {
      console.log("üîÑ Refresh manuale");
      loadNews();
    });

    $("fiatBtn").addEventListener("click", () => {
      window.open(BRAND_LINKS.Fiat, "_blank", "noopener,noreferrer");
    });

    $("jeepBtn").addEventListener("click", () => {
      window.open(BRAND_LINKS.Jeep, "_blank", "noopener,noreferrer");
    });

    // ================== GESTIONE STATO AUTENTICAZIONE ==================
    onAuthStateChanged(auth, (user) => {
      console.log("üîî Auth state changed:", user ? user.email : "NO USER");
      
      if (user) {
        console.log("‚úÖ UTENTE AUTENTICATO");
        console.log("   Email:", user.email);
        console.log("   UID:", user.uid);
        console.log("   Provider:", user.providerData[0]?.providerId);
        
        $("userPill").textContent = "‚úÖ " + (user.email || "Utente");
        $("userPill").classList.remove("muted");
        $("userPill").style.borderColor = "rgba(34, 197, 94, 0.5)";
        $("userPill").style.background = "rgba(34, 197, 94, 0.1)";
        
        $("loginBtn").style.display = "none";
        $("logoutBtn").style.display = "inline-block";
        $("refreshBtn").disabled = false;
        
        loadNews();
      } else {
        console.log("‚ÑπÔ∏è Nessun utente autenticato");
        
        $("userPill").textContent = "üîí Non autenticato";
        $("userPill").classList.add("muted");
        $("userPill").style.borderColor = "";
        $("userPill").style.background = "";
        
        $("loginBtn").style.display = "inline-block";
        $("logoutBtn").style.display = "none";
        $("refreshBtn").disabled = true;
        $("newsList").innerHTML = "";
        setStatus("üîí Effettua il login per caricare le news.");
      }
    });

    console.log("‚úÖ App inizializzata");
  </script>
</body>
</html>
