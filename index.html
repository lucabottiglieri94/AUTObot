<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>AI BOTT Automotive</title>

  <style>
    :root{
      --bgTop:#07080b;
      --bgMid:#101216;
      --bgBot:#1a1d23;

      --panel: rgba(17,24,39,.78);
      --line:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;

      --blue:#3b82f6;
      --blue2:#60a5fa;

      /* ORANGE MODERNO */
      --orange:#f97316;      /* primary */
      --orange2:#fb923c;     /* gradient */
      --orangeSoft: rgba(249,115,22,.18);
      --orangeLine: rgba(249,115,22,.45);
    }

    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(1200px 700px at 18% -12%, rgba(59,130,246,.18), transparent 58%),
        radial-gradient(1000px 600px at 78% 8%, rgba(249,115,22,.10), transparent 62%),
        linear-gradient(180deg, var(--bgTop) 0%, var(--bgMid) 48%, var(--bgBot) 100%);
    }

    header{
      position:relative; top:0; z-index:10;
      background:rgba(10,10,12,.72);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
    }

    .wrap{max-width:1200px;margin:0 auto;padding:16px}

    .row{
      display:flex; gap:12px; align-items:center;
      justify-content:space-between; flex-wrap:wrap;
    }

    .brand{
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
      min-width: 320px;
    }

    .brandMark{display:flex;align-items:center;gap:10px;user-select:none}
    .brandLogo{
      width:4cm; height:4cm; object-fit:contain;
      background:transparent;border:none;outline:none;filter:none;
      mix-blend-mode: screen;
    }
    .brandName{
      font-weight:950; letter-spacing:.2px; font-size:18px; line-height:1;
      background:linear-gradient(135deg, var(--blue) 0%, var(--blue2) 100%);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      white-space:nowrap;
    }
    .brandSub{opacity:.75;white-space:nowrap}

    .btn{
      border:1px solid var(--line);
      background:rgba(17,24,39,.75);
      color:var(--text);
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-size:14px;
      transition:all .2s;
      font-weight:650;
      font-family:inherit;
    }
    .btn:hover{
      border-color:rgba(59,130,246,.6);
      background:rgba(17,24,39,.92);
      transform:translateY(-1px);
    }
    .btn.primary{
      border-color:rgba(59,130,246,.55);
      background:rgba(37,99,235,.16);
    }
    .btn.primary:hover{background:rgba(37,99,235,.26)}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}

    .btn.brand-fiat:hover{border-color:rgba(220,38,38,.6);background:rgba(220,38,38,.1)}
    .btn.brand-jeep:hover{border-color:rgba(34,197,94,.6);background:rgba(34,197,94,.1)}
    .btn.brand-alfa:hover{border-color:rgba(239,68,68,.6);background:rgba(239,68,68,.1)}
    .btn.brand-lancia:hover{border-color:rgba(59,130,246,.6);background:rgba(59,130,246,.1)}

    .centroAutoLink{
      display:inline-flex; align-items:center;
      padding:6px 12px;
      border:2px solid rgba(34,197,94,.4);
      background:rgba(34,197,94,.08);
      border-radius:12px;
      transition:all .3s ease;
      text-decoration:none;
      box-shadow:0 2px 8px rgba(34,197,94,.15);
    }
    .centroAutoLink:hover{
      border-color:rgba(34,197,94,.7);
      background:rgba(34,197,94,.18);
      transform:translateY(-2px);
      box-shadow:0 4px 16px rgba(34,197,94,.3);
    }
    .centroAutoLogo{
      height:42px; width:auto; object-fit:contain;
      filter:drop-shadow(0 1px 3px rgba(0,0,0,.2));
    }

    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(17,24,39,.35);
      font-size:12px;
      white-space:nowrap;
    }
    .muted{color:var(--muted)}

    .layout{
      margin-top:16px;
      display:grid;
      grid-template-columns: 420px 1fr; /* NEWS | CONTENUTO */
      gap:16px;
      align-items:start;
    }

    .panel{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
    }
    .panelHeader{
      padding:14px 14px 10px 14px;
      border-bottom:1px solid rgba(31,41,55,.75);
      background:rgba(10,12,18,.35);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .panelTitle{font-weight:950;font-size:18px}
    .panelSub{margin-top:6px}

    .newsScroll{
      max-height: calc(100vh - 140px);
      overflow:auto;
      padding:12px;
    }
    .newsScroll::-webkit-scrollbar{width:10px}
    .newsScroll::-webkit-scrollbar-thumb{
      background:rgba(59,130,246,.25);
      border:2px solid rgba(17,24,39,.7);
      border-radius:999px;
    }
    .newsScroll::-webkit-scrollbar-track{background:rgba(0,0,0,.12)}

    #status{margin:10px 0 0 0}
    #newsList{display:grid;gap:12px}

    .newsItem{
      display:block;
      padding:14px;
      border:1px solid var(--line);
      border-radius:14px;
      text-decoration:none;
      color:inherit;
      background:rgba(17,24,39,.35);
      transition:all .2s;
    }
    .newsItem:hover{
      border-color:rgba(59,130,246,.6);
      background:rgba(17,24,39,.55);
      transform:translateX(4px);
    }
    .newsTitle{font-weight:850;margin-bottom:8px}
    .newsMeta{opacity:.75;font-size:12px;margin-top:6px}
    .newsDate{opacity:.75;font-size:12px;margin-top:6px;font-style:italic}

    /* ===== COLONNE A DESTRA ===== */
    .rightGrid{
      display:grid;
      grid-template-columns: 1fr 420px;  /* SINISTRA GRANDE | DESTRA STRETTA */
      gap:16px;
      align-items:start;
    }

    /* ===== WIDGET BASE ===== */
    .widgetPanel{
      background:rgba(17,24,39,.78);
      border:1px solid #1f2937;
      border-radius:16px;
      overflow:hidden;
    }
    .widgetHeader{
      padding:14px 16px;
      border-bottom:1px solid rgba(31,41,55,.75);
      background:rgba(10,12,18,.35);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .widgetTitle{font-weight:950;font-size:18px}
    .widgetSub{color:#9ca3af;font-size:13px;margin-top:4px}
    .widgetBody{padding:14px 16px;}
    .smallNote{margin-top:10px;color:#9ca3af;font-size:12px}

    .formRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .field{
      flex:1;
      min-width:260px;
      background:rgba(31,41,55,.6);
      border:1px solid #1f2937;
      border-radius:12px;
      padding:10px 14px;
      color:#e5e7eb;
      font-size:13px;
      outline:none;
      font-family:inherit;
      transition:border-color .2s, background .2s;
    }
    .field:focus{border-color:var(--orangeLine);background:rgba(31,41,55,.8)}

    /* ===== TOGGLE (SEGMENTED) ORANGE MODERNO ===== */
    .seg{
      display:inline-flex;
      border:1px solid rgba(31,41,55,.9);
      background:rgba(17,24,39,.35);
      border-radius:999px;
      overflow:hidden;
    }
    .seg button{
      border:none;
      background:transparent;
      color:#cbd5e1;
      padding:8px 11px;
      font-size:12px;
      cursor:pointer;
      transition:all .18s;
      font-family:inherit;
      font-weight:800;
      white-space:nowrap;
    }
    .seg button:hover{
      background:rgba(249,115,22,.10);
      color:#fff;
    }
    .seg button.active{
      color:#111827;
      background:linear-gradient(135deg, var(--orange) 0%, var(--orange2) 100%);
      box-shadow:0 10px 24px rgba(249,115,22,.18);
    }

    /* ===== AGENDA 3 COLONNE ===== */
    .split3{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
      margin-top:14px;
      align-items:start;
    }
    .dayCol{
      background:rgba(31,41,55,.35);
      border:1px solid rgba(31,41,55,.75);
      border-radius:14px;
      overflow:hidden;
      min-width:0;
    }
    .dayHead{
      padding:12px 14px;
      font-weight:950;
      font-size:13px;
      border-bottom:1px solid rgba(31,41,55,.65);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:rgba(249,115,22,.10); /* ORANGE */
    }
    .dayMeta{color:#9ca3af;font-weight:800;font-size:12px}

    .list{
      padding:10px 12px;
      display:grid;
      gap:8px;
      max-height:260px;
      overflow:auto;
    }
    .list::-webkit-scrollbar{width:8px}
    .list::-webkit-scrollbar-thumb{background:rgba(249,115,22,.25);border-radius:999px}
    .list::-webkit-scrollbar-track{background:rgba(0,0,0,.12)}

    .item{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:10px 10px;
      border:1px solid rgba(31,41,55,.7);
      border-radius:12px;
      background:rgba(17,24,39,.35);
      min-width:0;
    }
    .itemMain{flex:1;min-width:0;}
    .itemText{
      font-size:13px;
      line-height:1.35;
      min-width:0;
      word-break: normal;
      overflow-wrap:anywhere;
      white-space: normal;
    }
    .itemText.done{text-decoration:line-through;opacity:.65}

    .itemActions{display:flex;gap:6px;align-items:center}
    .iconBtn{
      width:32px;height:32px;
      border-radius:10px;
      border:1px solid rgba(31,41,55,.9);
      background:rgba(17,24,39,.45);
      color:#e5e7eb;
      cursor:pointer;
      transition:all .18s;
      display:flex;align-items:center;justify-content:center;
      font-size:14px;
      font-weight:950;
    }
    .iconBtn:hover{
      border-color:var(--orangeLine);
      background:rgba(17,24,39,.7);
      transform:translateY(-1px);
    }

    /* matita ORANGE */
    .iconBtn.pencil{
      border-color:rgba(249,115,22,.35);
      background:rgba(249,115,22,.10);
    }
    .iconBtn.pencil:hover{
      border-color:rgba(249,115,22,.70);
      background:rgba(249,115,22,.18);
    }

    .chk{
      width:18px;height:18px;flex:0 0 auto;
      accent-color: var(--orange);
      margin-top:2px;
      cursor:pointer;
    }

    .memoArea{width:100%;min-height:110px;resize:vertical}

    .syncBadge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(31,41,55,.9);
      background:rgba(17,24,39,.35);
      color:#9ca3af;
      white-space:nowrap;
    }
    .syncBadge.ok{
      border-color:rgba(249,115,22,.55);
      background:rgba(249,115,22,.12);
      color:#fed7aa;
    }
    .syncBadge.warn{
      border-color:rgba(251,191,36,.5);
      background:rgba(251,191,36,.10);
      color:#fde68a;
    }

    /* ===== CALENDARIO SETTIMANALE ===== */
    #weekGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;}
    .weekDay{
      border:1px solid rgba(31,41,55,.75);
      background:rgba(17,24,39,.35);
      border-radius:14px;
      padding:10px;
      cursor:pointer;
      transition:all .18s;
      min-height:110px;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .weekDay:hover{
      border-color:rgba(249,115,22,.55);
      background:rgba(17,24,39,.55);
      transform:translateY(-1px)
    }
    .weekDayTop{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
    .weekDow{font-weight:950;font-size:12px;color:#e5e7eb}
    .weekDate{font-size:12px;color:#9ca3af;font-weight:800}
    .weekBadge{
      font-size:11px;padding:3px 8px;border-radius:999px;
      border:1px solid rgba(31,41,55,.9);
      background:rgba(0,0,0,.12);
      color:#9ca3af;
      white-space:nowrap;
    }
    .weekBadge.has{
      border-color:rgba(249,115,22,.55);
      background:rgba(249,115,22,.12);
      color:#fed7aa;
    }
    .weekList{margin-top:2px;display:grid;gap:5px;font-size:12px;color:#d1d5db;min-width:0}
    .weekLine{opacity:.85;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:0}
    .weekDay.today{
      border-color:rgba(34,197,94,.55);
      background:rgba(34,197,94,.08);
    }
    .weekDay.selected{
      outline:2px solid rgba(249,115,22,.55);
      outline-offset:1px;
    }

    /* ===== COMPARATORE ===== */
    .cmpSuggest{
      background:rgba(249,115,22,.10);
      border:1px solid rgba(249,115,22,.28);
      border-radius:999px;
      padding:4px 10px;
      color:#fed7aa;
      font-size:11px;
      cursor:pointer;
      transition:all .18s;
      font-family:inherit;
      font-weight:800;
    }
    .cmpSuggest:hover{
      background:rgba(249,115,22,.18);
      border-color:rgba(249,115,22,.55)
    }

    /* ===== CHAT AGENT ===== */
    .chatTrigger{
      position:fixed; bottom:24px; right:24px;
      width:70px; height:70px; border-radius:50%;
      background:transparent; border:none; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 8px 24px rgba(0,0,0,.3);
      transition:all .25s ease;
      z-index:1000;
    }
    .chatTrigger:hover{transform:scale(1.08);box-shadow:0 12px 32px rgba(0,0,0,.5)}
    .chatTrigger img{width:70px;height:70px;object-fit:contain}

    .chatBox{
      position:fixed; bottom:24px; right:24px;
      width:420px; max-width:calc(100vw - 32px);
      height:600px; max-height:calc(100vh - 48px);
      background:rgba(17,24,39,.95);
      border:1px solid rgba(31,41,55,.9);
      border-radius:20px;
      display:none;
      flex-direction:column;
      box-shadow:0 20px 60px rgba(0,0,0,.6);
      z-index:1001;
      overflow:hidden;
      backdrop-filter:blur(20px);
    }
    .chatBox.open{display:flex}
    .chatHeader{
      background:linear-gradient(135deg, rgba(249,115,22,.90), rgba(251,146,60,.90));
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.15);
    }
    .chatHeaderLeft{display:flex;align-items:center;gap:10px}
    .chatHeaderLogo{width:38px;height:38px;border-radius:50%;background:rgba(255,255,255,.15);padding:4px}
    .chatHeaderTitle{font-weight:950;font-size:15px;color:#fff}
    .chatHeaderSub{font-size:11px;color:rgba(255,255,255,.75);margin-top:2px}
    .chatHeaderBtns{display:flex;gap:8px}
    .chatHeaderBtn{
      width:32px;height:32px;border-radius:8px;
      background:rgba(255,255,255,.15);
      border:none;color:#fff;cursor:pointer;font-size:18px;
      display:flex;align-items:center;justify-content:center;
      transition:all .18s;font-weight:950;
    }
    .chatHeaderBtn:hover{background:rgba(255,255,255,.25);transform:scale(1.05)}
    .chatMessages{
      flex:1; overflow-y:auto; padding:16px;
      background:linear-gradient(180deg, rgba(26,29,35,.95) 0%, rgba(16,18,22,.95) 100%);
      display:flex; flex-direction:column; gap:12px;
    }
    .message{display:flex;gap:8px}
    .message.user{flex-direction:row-reverse}
    .messageBubble{
      max-width:85%;
      padding:12px 16px;
      border-radius:18px;
      font-size:14px;
      line-height:1.55;
      word-wrap:break-word;
      white-space:pre-line;
    }
    .message.ai .messageBubble{
      background:linear-gradient(135deg, rgba(249,115,22,.85) 0%, rgba(251,146,60,.85) 100%);
      color:#fff; border-bottom-left-radius:4px;
    }
    .message.user .messageBubble{
      background:rgba(255,255,255,.92);
      color:#111827; border-bottom-right-radius:4px;
    }
    .chatInput{
      padding:14px; background:rgba(10,12,18,.95);
      border-top:1px solid rgba(31,41,55,.9);
      display:flex; gap:10px;
    }
    .chatInputField{
      flex:1;
      background:rgba(31,41,55,.6);
      border:1px solid rgba(31,41,55,.9);
      border-radius:12px;
      padding:12px 14px;
      color:#e5e7eb;
      font-size:14px;
      outline:none;
      transition:all .18s;
      font-family:inherit;
    }
    .chatInputField:focus{border-color:rgba(249,115,22,.9);background:rgba(31,41,55,.8)}
    .chatInputField::placeholder{color:#9ca3af}
    .chatSendBtn{
      width:48px;height:48px;border-radius:12px;
      background:linear-gradient(135deg, rgba(249,115,22,.95), rgba(251,146,60,.95));
      border:none;color:#fff;cursor:pointer;font-size:20px;
      display:flex;align-items:center;justify-content:center;
      transition:all .18s;
    }
    .chatSendBtn:hover:not(:disabled){transform:scale(1.05)}
    .chatSendBtn:disabled{opacity:.5;cursor:not-allowed}

    /* RESPONSIVE */
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
      .newsScroll{max-height:60vh}
      .brand{min-width: unset}
      .rightGrid{grid-template-columns:1fr}
      .split3{grid-template-columns:1fr}
      #weekGrid{grid-template-columns:repeat(2,1fr) !important;}
      .chatBox{
        width:100%;max-width:100%;
        height:100vh;max-height:100vh;
        bottom:0;right:0;border-radius:0;
      }
      .chatTrigger{bottom:16px;right:16px;width:60px;height:60px}
      .chatTrigger img{width:60px;height:60px}
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="row">
        <div class="brand">
          <div class="brandMark">
            <img class="brandLogo"
              src="https://image2url.com/r2/default/images/1770729951588-711e8f2c-9f48-4ef1-9af3-be4b1f7b5d9f.png"
              alt="AI BOTT logo" />
            <div>
              <div class="brandName">AI BOTT</div>
              <div class="brandSub">Automotive</div>
            </div>
          </div>

          <button id="fiatBtn" class="btn brand-fiat">Fiat</button>
          <button id="jeepBtn" class="btn brand-jeep">Jeep</button>
          <button id="alfaBtn" class="btn brand-alfa">Alfa Romeo</button>
          <button id="lanciaBtn" class="btn brand-lancia">Lancia</button>

          <a href="https://www.centroautovt.it/" target="_blank" rel="noopener noreferrer" class="centroAutoLink">
            <img src="https://image2url.com/r2/default/images/1770805237740-1db65b1e-5553-4b5b-b28a-750e3520a0a2.png"
              alt="CentroAuto VT" class="centroAutoLogo" />
          </a>
        </div>

        <div class="row" style="gap:10px">
          <span id="userPill" class="pill muted">Non autenticato</span>
          <button id="loginBtn" class="btn primary">Login Google</button>
          <button id="logoutBtn" class="btn" style="display:none">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="layout">
      <!-- NEWS -->
      <aside class="panel">
        <div class="panelHeader">
          <div>
            <div class="panelTitle">üì∞ Ultime News</div>
            <div class="muted panelSub">Visibili solo dopo login.</div>
            <div id="status" class="muted">Effettua il login per caricare le news.</div>
          </div>
          <button id="refreshBtn" class="btn" disabled>üîÑ</button>
        </div>
        <div class="newsScroll">
          <div id="newsList"></div>
        </div>
      </aside>

      <!-- CONTENUTO A DESTRA -->
      <section style="padding:0;border:none;background:none;">
        <div class="rightGrid">
          <!-- SINISTRA GRANDE -->
          <div style="display:grid;gap:16px;">
            <!-- CALENDARIO SETTIMANALE (zona freccia) -->
            <div class="widgetPanel" id="weekPanel">
              <div class="widgetHeader">
                <div>
                  <div class="widgetTitle">üóì Calendario settimanale</div>
                  <div class="widgetSub">Click su un giorno: i nuovi task vanno l√¨.</div>
                </div>
                <span id="weekSelectedPill" class="pill muted">Selezione: oggi</span>
              </div>
              <div class="widgetBody">
                <div id="weekGrid"></div>
                <div class="smallNote">Sincronizzato con Agenda e Firebase (anche telefono).</div>
              </div>
            </div>

            <!-- COMPARATORE (in basso a sinistra) -->
            <div class="widgetPanel" id="comparatorPanel">
              <div class="widgetHeader">
                <div>
                  <div class="widgetTitle">‚öî Comparatore Auto</div>
                  <div class="widgetSub">Inserisci 2 modelli. (Puoi collegare il tuo /api/search dopo.)</div>
                </div>
                <button id="cmpResetBtn" class="btn" style="font-size:12px;padding:7px 12px;">‚Ü© Reset</button>
              </div>

              <div class="widgetBody" style="border-bottom:1px solid rgba(31,41,55,.5);">
                <div class="formRow">
                  <input id="cmpInput1" class="field" type="text" placeholder="Es: Grande Panda, Compass, Stelvio..." />
                  <div style="display:flex;align-items:center;color:#9ca3af;font-size:18px;font-weight:950;">VS</div>
                  <input id="cmpInput2" class="field" type="text" placeholder="Es: Junior, Avenger, Ypsilon..." />
                  <button id="cmpBtn" class="btn primary" type="button">üîé Confronta</button>
                </div>

                <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
                  <span style="color:#9ca3af;font-size:12px;align-self:center;">Rapido:</span>
                  <button class="cmpSuggest" data-s1="Grande Panda" data-s2="Junior">Grande Panda vs Junior</button>
                  <button class="cmpSuggest" data-s1="Compass" data-s2="Tonale">Compass vs Tonale</button>
                  <button class="cmpSuggest" data-s1="Ypsilon" data-s2="Avenger">Ypsilon vs Avenger</button>
                </div>
              </div>

              <div id="cmpResults" class="widgetBody">
                <div class="muted" style="text-align:center;padding:18px 0;font-size:13px;">
                  Scrivi due modelli e premi Confronta.
                </div>
              </div>
            </div>
          </div>

          <!-- DESTRA STRETTA -->
          <div style="display:grid;gap:16px;">
            <!-- AGENDA 3 GIORNI -->
            <div class="widgetPanel" id="agendaPanel">
              <div class="widgetHeader">
                <div>
                  <div class="widgetTitle">üìÖ Agenda 3 giorni</div>
                  <div class="widgetSub">Oggi, domani, +2. Scorre ogni giorno.</div>
                </div>
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                  <span id="syncBadge" class="syncBadge warn">Sync: non attivo</span>
                  <button id="agendaClearDoneBtn" class="btn" style="font-size:12px;padding:7px 12px;">Pulisci fatti</button>
                </div>
              </div>

              <div class="widgetBody">
                <div class="formRow">
                  <input id="taskInput" class="field" type="text" placeholder="Scrivi un task..." />
                  <div class="seg" aria-label="Giorno task (se NON selezioni nel calendario)">
                    <button id="dayBtn0" class="active" type="button">Oggi</button>
                    <button id="dayBtn1" type="button">Domani</button>
                    <button id="dayBtn2" type="button">+2</button>
                  </div>
                  <button id="addTaskBtn" class="btn primary" type="button">Aggiungi</button>
                </div>

                <div class="split3">
                  <div class="dayCol">
                    <div class="dayHead">
                      <span>Oggi</span>
                      <span id="dayDate0" class="dayMeta"></span>
                    </div>
                    <div id="taskList0" class="list"></div>
                  </div>

                  <div class="dayCol">
                    <div class="dayHead" style="background:rgba(249,115,22,.08);">
                      <span>Domani</span>
                      <span id="dayDate1" class="dayMeta"></span>
                    </div>
                    <div id="taskList1" class="list"></div>
                  </div>

                  <div class="dayCol">
                    <div class="dayHead" style="background:rgba(249,115,22,.06);">
                      <span>+2</span>
                      <span id="dayDate2" class="dayMeta"></span>
                    </div>
                    <div id="taskList2" class="list"></div>
                  </div>
                </div>

                <div class="smallNote">Selezione calendario attiva: priorit√† sui 3 pulsanti.</div>
              </div>
            </div>

            <!-- MEMO -->
            <div class="widgetPanel" id="memoPanel">
              <div class="widgetHeader">
                <div>
                  <div class="widgetTitle">üìù Memo</div>
                  <div class="widgetSub">Matita: barra/risbarra. Sync Firebase.</div>
                </div>
                <button id="memoClearDoneBtn" class="btn" style="font-size:12px;padding:7px 12px;">Pulisci barrate</button>
              </div>

              <div class="widgetBody">
                <div class="formRow" style="align-items:stretch;">
                  <textarea id="memoInput" class="field memoArea" placeholder="Scrivi una memo..."></textarea>
                  <button id="addMemoBtn" class="btn primary" type="button" style="align-self:flex-start;">Aggiungi</button>
                </div>

                <div style="margin-top:14px;">
                  <div id="memoList" class="list" style="max-height:320px;"></div>
                </div>

                <div class="smallNote">Ctrl+Enter nella memo = aggiungi.</div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- CHAT AGENT -->
  <button class="chatTrigger" id="chatTrigger" aria-label="Apri chat">
    <img src="https://image2url.com/r2/default/images/1770729951588-711e8f2c-9f48-4ef1-9af3-be4b1f7b5d9f.png" alt="AI Agent"/>
  </button>

  <div class="chatBox" id="chatBox" aria-label="Chat AI">
    <div class="chatHeader">
      <div class="chatHeaderLeft">
        <img class="chatHeaderLogo" src="https://image2url.com/r2/default/images/1770729951588-711e8f2c-9f48-4ef1-9af3-be4b1f7b5d9f.png" alt="AI"/>
        <div>
          <div class="chatHeaderTitle">AI BOTT Assistant</div>
          <div class="chatHeaderSub">Supporto rapido</div>
        </div>
      </div>
      <div class="chatHeaderBtns">
        <button class="chatHeaderBtn" id="closeBtn" title="Chiudi">√ó</button>
      </div>
    </div>

    <div class="chatMessages" id="chatMessages">
      <div class="message ai"><div class="messageBubble">Dimmi cosa ti serve.</div></div>
    </div>

    <div class="chatInput">
      <input type="text" class="chatInputField" id="chatInputField" placeholder="Scrivi..." autocomplete="off" />
      <button class="chatSendBtn" id="chatSendBtn" aria-label="Invia">‚û§</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth,
      setPersistence,
      browserLocalPersistence,
      browserSessionPersistence,
      GoogleAuthProvider,
      signInWithPopup,
      signInWithRedirect,
      getRedirectResult,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    import {
      getFirestore,
      doc,
      onSnapshot,
      setDoc,
      enableIndexedDbPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const BACKEND_NEWS = "/api/news";

    const BRAND_LINKS = {
      Fiat:     "https://www.fiat.it/omni/configuratore/#/",
      Jeep:     "https://www.jeep-official.it/omni/configuratore",
      AlfaRomeo:"https://www.alfaromeo.it/omni/configuratore",
      Lancia:   "https://www.lancia.it/omni/configuratore"
    };

    const firebaseConfig = {
      apiKey: "AIzaSyALsFF_dpL39GlPfMyKBFIKtZi5coOk9I8",
      authDomain: "auto-1af60.firebaseapp.com",
      projectId: "auto-1af60",
      storageBucket: "auto-1af60.firebasestorage.app",
      messagingSenderId: "498320258984",
      appId: "1:498320258984:web:bac67d7634273d10464f9d",
      measurementId: "G-WYM78KQWQJ"
    };

    const $ = (id) => document.getElementById(id);
    const setStatus = (t) => { $("status").textContent = t; };

    function escapeHtml(s = "") {
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }
    function safeHost(url) { try { return new URL(url).hostname; } catch { return ""; } }
    function fmtDate(d) {
      if (!d) return "";
      const dt = new Date(d);
      if (Number.isNaN(dt.getTime())) return String(d);
      return dt.toLocaleString("it-IT",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});
    }

    function renderNews(items) {
      const box = $("newsList");
      if (!items || !items.length) {
        box.innerHTML = '<div class="muted" style="padding:20px;text-align:center">Nessuna news disponibile.</div>';
        setStatus("Nessuna news trovata.");
        return;
      }
      box.innerHTML = items.map(n => {
        const link  = n.url || n.link || "";
        const title = n.title || "Senza titolo";
        const date  = fmtDate(n.date || n.pubDate || "");
        const host  = safeHost(link);
        return `
          <a class="newsItem" href="${escapeHtml(link)}" target="_blank" rel="noopener noreferrer">
            <div class="newsTitle">${escapeHtml(title)}</div>
            ${host ? `<div class="newsMeta">üîó ${escapeHtml(host)}</div>` : ""}
            ${date ? `<div class="newsDate">üïí ${escapeHtml(date)}</div>` : ""}
          </a>`;
      }).join("");
      setStatus("‚úÖ " + items.length + " news caricate ‚Ä¢ " + new Date().toLocaleString("it-IT"));
    }

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    enableIndexedDbPersistence(db).catch(()=>{});

    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt:"select_account", display:"popup" });

    (async function initAuth(){
      try { await setPersistence(auth, browserLocalPersistence); }
      catch { try { await setPersistence(auth, browserSessionPersistence); } catch {} }
      try { await getRedirectResult(auth); } catch {}
    })();

    async function loadNews() {
      const user = auth.currentUser;
      if (!user) { $("newsList").innerHTML = ""; setStatus("Effettua il login per vedere le news."); return; }
      setStatus("Caricamento news...");
      $("refreshBtn").disabled = true;
      try {
        const response = await fetch(BACKEND_NEWS, { method:"GET", headers:{"Cache-Control":"no-cache"}, cache:"no-store" });
        if (!response.ok) throw new Error("HTTP " + response.status);
        const data = await response.json();
        if (data.items && Array.isArray(data.items)) renderNews(data.items);
        else if (Array.isArray(data)) renderNews(data);
        else renderNews([]);
      } catch(err) {
        $("newsList").innerHTML = '<div class="muted" style="padding:20px;text-align:center">Errore caricamento news</div>';
        setStatus("Errore: " + (err?.message || err));
      } finally {
        $("refreshBtn").disabled = !auth.currentUser;
      }
    }

    $("loginBtn").addEventListener("click", async () => {
      try {
        setStatus("Apertura login Google...");
        try {
          const result = await signInWithPopup(auth, provider);
          setStatus("Login riuscito! " + (result.user.email || ""));
        } catch(popupError) {
          if (["auth/popup-blocked","auth/popup-closed-by-user","auth/cancelled-popup-request"].includes(popupError.code)) {
            setStatus("Reindirizzamento in corso...");
            await signInWithRedirect(auth, provider);
          } else { throw popupError; }
        }
      } catch(e) {
        setStatus("Errore: " + (e.code || e.message || "login"));
      }
    });

    $("logoutBtn").addEventListener("click", async () => {
      try { await signOut(auth); $("newsList").innerHTML = ""; setStatus("Logout effettuato."); }
      catch(e) { setStatus("Errore logout: " + (e.code || e.message)); }
    });

    $("refreshBtn").addEventListener("click", loadNews);
    $("fiatBtn").addEventListener("click",  () => window.open(BRAND_LINKS.Fiat,      "_blank","noopener,noreferrer"));
    $("jeepBtn").addEventListener("click",  () => window.open(BRAND_LINKS.Jeep,      "_blank","noopener,noreferrer"));
    $("alfaBtn").addEventListener("click",  () => window.open(BRAND_LINKS.AlfaRomeo, "_blank","noopener,noreferrer"));
    $("lanciaBtn").addEventListener("click",() => window.open(BRAND_LINKS.Lancia,    "_blank","noopener,noreferrer"));

    /* =========================
       COMPARATORE (base)
    ========================= */
    function setSuggest(a,b){ $("cmpInput1").value=a; $("cmpInput2").value=b; }
    document.querySelectorAll(".cmpSuggest").forEach(btn=>{
      btn.addEventListener("click", ()=>setSuggest(btn.dataset.s1, btn.dataset.s2));
    });
    $("cmpResetBtn").addEventListener("click", ()=>{
      $("cmpInput1").value=""; $("cmpInput2").value="";
      $("cmpResults").innerHTML = '<div class="muted" style="text-align:center;padding:18px 0;font-size:13px;">Scrivi due modelli e premi Confronta.</div>';
    });

    function guessBrand(model){
      const s = (model||"").toLowerCase();
      const fiat = ["panda","500","tipo","ducato","dobl","doblo","600","grande panda","punto"];
      const jeep = ["avenger","renegade","compass","wrangler","grand cherokee","cherokee"];
      const alfa = ["giulia","stelvio","tonale","junior","giulietta","mito"];
      const lancia = ["ypsilon"];
      if (alfa.some(x=>s.includes(x))) return "AlfaRomeo";
      if (jeep.some(x=>s.includes(x))) return "Jeep";
      if (lancia.some(x=>s.includes(x))) return "Lancia";
      if (fiat.some(x=>s.includes(x))) return "Fiat";
      return null;
    }

    $("cmpBtn").addEventListener("click", ()=>{
      const a = $("cmpInput1").value.trim();
      const b = $("cmpInput2").value.trim();
      if(!a || !b){
        $("cmpResults").innerHTML = '<div class="muted" style="text-align:center;padding:18px 0;font-size:13px;">Inserisci 2 modelli.</div>';
        return;
      }
      const ba = guessBrand(a);
      const bb = guessBrand(b);
      const linkA = ba ? BRAND_LINKS[ba] : null;
      const linkB = bb ? BRAND_LINKS[bb] : null;

      $("cmpResults").innerHTML = `
        <div style="display:grid;gap:12px;">
          <div style="display:grid;gap:6px;padding:12px;border:1px solid rgba(31,41,55,.7);border-radius:14px;background:rgba(17,24,39,.35);">
            <div style="font-weight:950;">${escapeHtml(a)}</div>
            <div class="muted" style="font-size:12px;">Marca stimata: ${escapeHtml(ba || "non riconosciuta")}</div>
            ${linkA ? `<a class="btn" style="display:inline-flex;width:max-content;text-decoration:none;" target="_blank" rel="noopener noreferrer" href="${linkA}">Apri configuratore</a>` : ""}
          </div>
          <div style="display:grid;gap:6px;padding:12px;border:1px solid rgba(31,41,55,.7);border-radius:14px;background:rgba(17,24,39,.35);">
            <div style="font-weight:950;">${escapeHtml(b)}</div>
            <div class="muted" style="font-size:12px;">Marca stimata: ${escapeHtml(bb || "non riconosciuta")}</div>
            ${linkB ? `<a class="btn" style="display:inline-flex;width:max-content;text-decoration:none;" target="_blank" rel="noopener noreferrer" href="${linkB}">Apri configuratore</a>` : ""}
          </div>
          <div class="muted" style="font-size:12px;">
            Per collegare il tuo backend search: dimmi endpoint e JSON di risposta.
          </div>
        </div>
      `;
    });

    /* =========================
       FIRESTORE SYNC (TASK + MEMO)
    ========================= */
    const SYNC = { unsub:null, docRef:null, data:{ tasks:{}, memos:{} }, ready:false };

    function setSyncBadge(state){
      const b = $("syncBadge");
      if(state === "ok"){ b.className = "syncBadge ok"; b.textContent = "Sync: attivo"; }
      else if(state === "warn"){ b.className = "syncBadge warn"; b.textContent = "Sync: non attivo"; }
      else { b.className = "syncBadge"; b.textContent = "Sync: ..."; }
    }

    function todayMidnight(d=new Date()){ const x = new Date(d); x.setHours(0,0,0,0); return x; }
    function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
    function dateKey(d){
      const x = todayMidnight(d);
      const y = x.getFullYear();
      const m = String(x.getMonth()+1).padStart(2,'0');
      const dd = String(x.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    }
    function prettyDay(d){ return d.toLocaleDateString("it-IT",{weekday:"short",day:"2-digit",month:"2-digit"}); }
    function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

    function normalizePlanner(p){
      const tasks = (p && typeof p.tasks === "object" && p.tasks) ? p.tasks : {};
      const memos = (p && typeof p.memos === "object" && p.memos) ? p.memos : {};
      return { tasks, memos };
    }

    function cleanupOldTasks(data){
      const keepAfter = todayMidnight(addDays(new Date(), -30));
      const limitKey = dateKey(keepAfter);
      const out = { tasks: { ...data.tasks }, memos: { ...data.memos } };
      for(const [id,t] of Object.entries(out.tasks)){
        if(!t?.dateKey) continue;
        if(String(t.dateKey) < limitKey) delete out.tasks[id];
      }
      return out;
    }

    async function writePlanner(nextData){
      if(!SYNC.docRef) return;
      await setDoc(SYNC.docRef, nextData, { merge:false });
    }

    async function safeWrite(mutatorFn){
      if(!SYNC.docRef) return;
      const current = JSON.parse(JSON.stringify(SYNC.data));
      let next = mutatorFn(current);
      next = cleanupOldTasks(next);
      SYNC.data = next;
      renderTasksAndMemos();
      renderWeekCalendar();
      try{ await writePlanner(next); }catch{}
    }

    /* =========================
       AGENDA 3 GIORNI
    ========================= */
    let selectedOffset = 0;
    function setDayOffset(n){
      selectedOffset = n;
      $("dayBtn0").classList.toggle("active", n===0);
      $("dayBtn1").classList.toggle("active", n===1);
      $("dayBtn2").classList.toggle("active", n===2);
    }
    $("dayBtn0").addEventListener("click", ()=>setDayOffset(0));
    $("dayBtn1").addEventListener("click", ()=>setDayOffset(1));
    $("dayBtn2").addEventListener("click", ()=>setDayOffset(2));
    setDayOffset(0);

    function refreshDayHeaders(){
      const base = todayMidnight(new Date());
      $("dayDate0").textContent = prettyDay(base);
      $("dayDate1").textContent = prettyDay(addDays(base,1));
      $("dayDate2").textContent = prettyDay(addDays(base,2));
      renderTasksAndMemos();
      renderWeekCalendar();
    }

    (function scheduleMidnightRefresh(){
      const now = new Date();
      const next = new Date(now);
      next.setHours(24,0,0,0);
      const ms = next.getTime() - now.getTime();
      setTimeout(() => {
        refreshDayHeaders();
        scheduleMidnightRefresh();
      }, Math.max(1000, ms));
    })();

    /* =========================
       CALENDARIO SETTIMANALE
    ========================= */
    let manualTargetDateKey = null;

    function startOfWeekMonday(d=new Date()){
      const x = todayMidnight(d);
      const day = x.getDay(); // 0=dom
      const diff = (day === 0) ? -6 : (1 - day); // luned√¨
      x.setDate(x.getDate() + diff);
      return x;
    }
    function shortDow(d){ return d.toLocaleDateString("it-IT",{weekday:"short"}).replace(".",""); }
    function formatDM(d){ return d.toLocaleDateString("it-IT",{day:"2-digit",month:"2-digit"}); }

    function setWeekSelected(dateKeyStr){
      manualTargetDateKey = dateKeyStr || null;
      const pill = $("weekSelectedPill");
      if(!manualTargetDateKey){
        pill.textContent = "Selezione: oggi";
        pill.classList.add("muted");
      } else {
        const dt = new Date(manualTargetDateKey + "T00:00:00");
        pill.textContent = "Selezione: " + shortDow(dt) + " " + formatDM(dt);
        pill.classList.remove("muted");
      }
      renderWeekCalendar();
    }

    function renderWeekCalendar(){
      const grid = $("weekGrid");
      if(!grid) return;

      if(!auth.currentUser){
        grid.innerHTML = '<div class="muted" style="grid-column:1/-1;padding:10px 6px;font-size:12px;">Login richiesto.</div>';
        return;
      }

      const base = startOfWeekMonday(new Date());
      const todayKey = dateKey(new Date());
      const allTasks = Object.values(SYNC.data.tasks || {});
      const days = Array.from({length:7}, (_,i)=> addDays(base,i));

      grid.innerHTML = days.map(d=>{
        const k = dateKey(d);
        const items = allTasks
          .filter(t => t && t.dateKey === k)
          .sort((a,b)=> (Number(a.done) - Number(b.done)) || ((a.createdAt||0)-(b.createdAt||0)));

        const top3 = items.slice(0,3);
        const badge = items.length
          ? `<span class="weekBadge has">${items.length} task</span>`
          : `<span class="weekBadge">0</span>`;

        const lines = top3.length
          ? top3.map(t=>`<div class="weekLine">${escapeHtml(t.done ? "‚úì " : "‚Ä¢ ")}${escapeHtml(t.text||"")}</div>`).join("")
          : `<div class="weekLine muted">‚Äî</div>`;

        const cls = [
          "weekDay",
          (k === todayKey) ? "today" : "",
          (manualTargetDateKey === k) ? "selected" : ""
        ].join(" ").trim();

        return `
          <div class="${cls}" data-datekey="${escapeHtml(k)}">
            <div class="weekDayTop">
              <div>
                <div class="weekDow">${escapeHtml(shortDow(d))}</div>
                <div class="weekDate">${escapeHtml(formatDM(d))}</div>
              </div>
              ${badge}
            </div>
            <div class="weekList">${lines}</div>
          </div>
        `;
      }).join("");

      grid.querySelectorAll(".weekDay").forEach(el=>{
        el.addEventListener("click", ()=>{
          const k = el.getAttribute("data-datekey");
          setWeekSelected(k === manualTargetDateKey ? null : k);
          $("taskInput")?.focus();
        });
      });
    }

    /* =========================
       RENDER TASK + MEMO
    ========================= */
    function renderTasksAndMemos(){
      if(!auth.currentUser){
        const msg = '<div class="muted" style="padding:10px 6px;font-size:12px;">Login richiesto.</div>';
        $("taskList0").innerHTML = msg;
        $("taskList1").innerHTML = msg;
        $("taskList2").innerHTML = msg;
        $("memoList").innerHTML  = msg;
        return;
      }

      const base = todayMidnight(new Date());
      const keys = [dateKey(base), dateKey(addDays(base,1)), dateKey(addDays(base,2))];
      const lists = [$("taskList0"), $("taskList1"), $("taskList2")];

      const allTasks = Object.values(SYNC.data.tasks || {});
      for(let i=0;i<3;i++){
        const k = keys[i];
        const items = allTasks
          .filter(t => t && t.dateKey === k)
          .sort((a,b)=> (Number(a.done) - Number(b.done)) || ((a.createdAt||0)-(b.createdAt||0)));

        if(!items.length){
          lists[i].innerHTML = '<div class="muted" style="padding:10px 6px;font-size:12px;">Nessun task.</div>';
          continue;
        }

        lists[i].innerHTML = items.map(t => {
          const txtClass = t.done ? "itemText done" : "itemText";
          const checked = t.done ? "checked" : "";
          return `
            <div class="item" data-id="${escapeHtml(t.id)}">
              <input class="chk" type="checkbox" ${checked} aria-label="Fatto">
              <div class="itemMain">
                <div class="${txtClass}">${escapeHtml(t.text || "")}</div>
              </div>
              <div class="itemActions">
                <button class="iconBtn del" title="Elimina" aria-label="Elimina">√ó</button>
              </div>
            </div>
          `;
        }).join("");
      }

      const memoBox = $("memoList");
      const memos = Object.values(SYNC.data.memos || {})
        .sort((a,b)=> (Number(a.done) - Number(b.done)) || ((a.createdAt||0)-(b.createdAt||0)));

      if(!memos.length){
        memoBox.innerHTML = '<div class="muted" style="padding:10px 6px;font-size:12px;">Nessuna memo.</div>';
      } else {
        memoBox.innerHTML = memos.map(m => {
          const txtClass = m.done ? "itemText done" : "itemText";
          return `
            <div class="item" data-id="${escapeHtml(m.id)}">
              <div class="itemMain">
                <div class="${txtClass}">${escapeHtml(m.text || "")}</div>
              </div>
              <div class="itemActions">
                <button class="iconBtn pencil" title="Matita: barra/risbarra" aria-label="Matita">‚úé</button>
                <button class="iconBtn del" title="Elimina" aria-label="Elimina">√ó</button>
              </div>
            </div>
          `;
        }).join("");
      }

      document.querySelectorAll("#agendaPanel .item").forEach(el => {
        const id = el.getAttribute("data-id");
        const chk = el.querySelector(".chk");
        const del = el.querySelector(".del");
        chk.addEventListener("change", () => {
          safeWrite(d => { if(d.tasks[id]) d.tasks[id].done = !!chk.checked; return d; });
        });
        del.addEventListener("click", () => {
          safeWrite(d => { delete d.tasks[id]; return d; });
        });
      });

      document.querySelectorAll("#memoPanel .item").forEach(el => {
        const id = el.getAttribute("data-id");
        const pencil = el.querySelector(".pencil");
        const del = el.querySelector(".del");
        pencil.addEventListener("click", () => {
          safeWrite(d => { if(d.memos[id]) d.memos[id].done = !d.memos[id].done; return d; });
        });
        del.addEventListener("click", () => {
          safeWrite(d => { delete d.memos[id]; return d; });
        });
      });
    }

    /* =========================
       ADD/CLEAR
    ========================= */
    $("addTaskBtn").addEventListener("click", () => {
      const text = $("taskInput").value.trim();
      if(!text) return;

      const base = todayMidnight(new Date());
      const targetKey = manualTargetDateKey ? manualTargetDateKey : dateKey(addDays(base, selectedOffset));
      const id = uid();

      safeWrite(d => { d.tasks[id] = { id, dateKey: targetKey, text, done:false, createdAt: Date.now() }; return d; });
      $("taskInput").value = "";
    });

    $("taskInput").addEventListener("keydown", (e)=>{
      if(e.key==="Enter"){ e.preventDefault(); $("addTaskBtn").click(); }
    });

    $("agendaClearDoneBtn").addEventListener("click", ()=>{
      safeWrite(d => { for(const [id,t] of Object.entries(d.tasks)) if(t && t.done) delete d.tasks[id]; return d; });
    });

    $("addMemoBtn").addEventListener("click", ()=>{
      const text = $("memoInput").value.trim();
      if(!text) return;
      const id = uid();
      safeWrite(d => { d.memos[id] = { id, text, done:false, createdAt: Date.now() }; return d; });
      $("memoInput").value = "";
    });

    $("memoInput").addEventListener("keydown", (e)=>{
      if(e.key==="Enter" && (e.ctrlKey || e.metaKey)){ e.preventDefault(); $("addMemoBtn").click(); }
    });

    $("memoClearDoneBtn").addEventListener("click", ()=>{
      safeWrite(d => { for(const [id,m] of Object.entries(d.memos)) if(m && m.done) delete d.memos[id]; return d; });
    });

    /* =========================
       SYNC START/STOP
    ========================= */
    function startPlannerSync(user){
      stopPlannerSync();
      SYNC.docRef = doc(db, "users", user.uid, "planner", "main");
      setSyncBadge("...");

      SYNC.unsub = onSnapshot(SYNC.docRef, (snap) => {
        const data = snap.exists() ? snap.data() : { tasks:{}, memos:{} };
        SYNC.data = cleanupOldTasks(normalizePlanner(data));
        SYNC.ready = true;
        setSyncBadge("ok");

        renderTasksAndMemos();
        renderWeekCalendar();
        refreshDayHeaders();
        if(!snap.exists()){
          setDoc(SYNC.docRef, SYNC.data, { merge:false }).catch(()=>{});
        }
      }, () => setSyncBadge("warn"));
    }

    function stopPlannerSync(){
      if(SYNC.unsub){ try{ SYNC.unsub(); }catch{} }
      SYNC.unsub = null;
      SYNC.docRef = null;
      SYNC.data = { tasks:{}, memos:{} };
      SYNC.ready = false;
      setSyncBadge("warn");
      renderTasksAndMemos();
      renderWeekCalendar();
    }

    /* =========================
       CHAT (demo locale)
    ========================= */
    const chatTrigger = $("chatTrigger");
    const chatBox = $("chatBox");
    const closeBtn = $("closeBtn");
    const chatMessages = $("chatMessages");
    const chatInputField = $("chatInputField");
    const chatSendBtn = $("chatSendBtn");

    function addMsg(text, who="user"){
      const wrap = document.createElement("div");
      wrap.className = "message " + (who === "ai" ? "ai" : "user");
      const bub = document.createElement("div");
      bub.className = "messageBubble";
      bub.textContent = text;
      wrap.appendChild(bub);
      chatMessages.appendChild(wrap);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    async function sendChat(){
      const text = (chatInputField.value || "").trim();
      if(!text) return;
      chatInputField.value = "";
      addMsg(text, "user");
      addMsg("Ok. (Collego l‚ÄôAPI chat quando mi dai URL e payload.)", "ai");
    }

    chatTrigger.addEventListener("click", () => {
      chatBox.classList.add("open");
      chatTrigger.style.display = "none";
      chatInputField.focus();
    });
    closeBtn.addEventListener("click", () => {
      chatBox.classList.remove("open");
      chatTrigger.style.display = "flex";
    });
    chatSendBtn.addEventListener("click", sendChat);
    chatInputField.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){ e.preventDefault(); sendChat(); }
    });

    /* =========================
       AUTH
    ========================= */
    onAuthStateChanged(auth, user => {
      if (user) {
        $("userPill").textContent = "‚úÖ " + (user.email || "Utente");
        $("userPill").classList.remove("muted");
        $("userPill").style.borderColor = "rgba(249,115,22,.55)";
        $("userPill").style.background  = "rgba(249,115,22,.12)";
        $("loginBtn").style.display  = "none";
        $("logoutBtn").style.display = "inline-block";
        $("refreshBtn").disabled = false;

        loadNews();
        refreshDayHeaders();
        setWeekSelected(null);
        startPlannerSync(user);
      } else {
        $("userPill").textContent = "Non autenticato";
        $("userPill").classList.add("muted");
        $("userPill").style.borderColor = "";
        $("userPill").style.background  = "";
        $("loginBtn").style.display  = "inline-block";
        $("logoutBtn").style.display = "none";
        $("refreshBtn").disabled = true;
        $("newsList").innerHTML = "";
        setStatus("Effettua il login per caricare le news.");

        setWeekSelected(null);
        stopPlannerSync();
      }
    });
  </script>
</body>
</html>
