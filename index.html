<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Auto News - Debug</title>
  <style>
    :root{
      --bg:#0b0f1a;
      --panel:#111827;
      --line:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#3b82f6;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    header{
      position:sticky;
      top:0;
      background:rgba(11,15,26,.9);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
      z-index:10;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{font-weight:800;letter-spacing:.2px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{
      border:1px solid var(--line);
      background:var(--panel);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-size:14px;
      transition:all 0.2s;
    }
    .btn:hover{
      border-color:rgba(59,130,246,.6);
      background:rgba(17,24,39,.9);
    }
    .btn.primary{
      border-color:rgba(59,130,246,.5);
      background:rgba(37,99,235,.15);
    }
    .btn.primary:hover{
      background:rgba(37,99,235,.25);
    }
    .btn:disabled{opacity:.6;cursor:not-allowed}
    main .card{
      margin-top:16px;
      background:rgba(17,24,39,.75);
      border:1px solid var(--line);
      border-radius:16px;
      padding:16px;
    }
    .muted{color:var(--muted)}
    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(17,24,39,.35);
      font-size:12px;
    }
    #newsList{display:grid;gap:12px;margin-top:12px}
    .newsItem{
      display:block;
      padding:14px;
      border:1px solid var(--line);
      border-radius:14px;
      text-decoration:none;
      color:inherit;
      background:rgba(17,24,39,.35);
      transition:all 0.2s;
    }
    .newsItem:hover{
      border-color:rgba(59,130,246,.6);
      background:rgba(17,24,39,.55);
    }
    .newsTitle{font-weight:800;margin-bottom:8px}
    .newsMeta{opacity:.75;font-size:12px;margin-top:6px}
    .newsDate{opacity:.75;font-size:12px;margin-top:6px;font-style:italic}
    
    /* DEBUG PANEL */
    #debugPanel{
      position:fixed;
      bottom:20px;
      right:20px;
      max-width:400px;
      max-height:300px;
      overflow-y:auto;
      background:rgba(17,24,39,.95);
      border:1px solid var(--accent);
      border-radius:12px;
      padding:12px;
      font-size:11px;
      font-family:monospace;
      z-index:1000;
    }
    .debug-log{
      margin:4px 0;
      padding:4px;
      border-left:2px solid #666;
      padding-left:8px;
    }
    .debug-error{border-left-color:#ef4444;color:#fca5a5}
    .debug-success{border-left-color:#22c55e;color:#86efac}
    .debug-info{border-left-color:#3b82f6;color:#93c5fd}
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="row">
        <div class="brand">
          <span>üöó Auto News</span>
          <button id="fiatBtn" class="btn">Fiat</button>
          <button id="jeepBtn" class="btn">Jeep</button>
        </div>

        <div class="row" style="gap:10px">
          <span id="userPill" class="pill muted">Non autenticato</span>
          <button id="loginBtn" class="btn primary">Login Google</button>
          <button id="logoutBtn" class="btn" style="display:none">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- PANNELLO DEBUG -->
    <div id="debugPanel">
      <div style="font-weight:800;margin-bottom:8px;color:#3b82f6">üîç Debug Log</div>
      <div id="debugLog"></div>
    </div>

    <section class="card">
      <div class="row">
        <div>
          <div style="font-weight:800;font-size:18px">üì∞ Ultime News</div>
          <div class="muted" style="margin-top:6px">Visibili solo dopo login.</div>
        </div>
        <button id="refreshBtn" class="btn" disabled>üîÑ Aggiorna</button>
      </div>

      <div id="status" class="muted" style="margin-top:12px">
        Effettua il login per caricare le news.
      </div>
      <div id="newsList"></div>
    </section>

    <!-- INFO SISTEMA -->
    <section class="card" style="margin-top:16px">
      <div style="font-weight:800;margin-bottom:8px">üîß Diagnostica Sistema</div>
      <div id="systemInfo" style="font-size:12px;color:var(--muted)"></div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth,
      setPersistence,
      browserLocalPersistence,
      GoogleAuthProvider,
      signInWithRedirect,
      getRedirectResult,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    // ================== DEBUG LOGGER ==================
    const debugLog = [];
    function log(msg, type = 'info') {
      const timestamp = new Date().toLocaleTimeString('it-IT');
      const entry = { msg, type, timestamp };
      debugLog.push(entry);
      
      const logDiv = document.getElementById('debugLog');
      const el = document.createElement('div');
      el.className = `debug-log debug-${type}`;
      el.textContent = `[${timestamp}] ${msg}`;
      logDiv.appendChild(el);
      logDiv.scrollTop = logDiv.scrollHeight;
      
      // Log anche nella console
      const emoji = { error: '‚ùå', success: '‚úÖ', info: 'üìò' }[type] || 'üìù';
      console.log(`${emoji} [${timestamp}] ${msg}`);
    }

    // ================== SYSTEM INFO ==================
    function checkSystemInfo() {
      const info = [];
      
      // Check localStorage
      try {
        localStorage.setItem('test', 'test');
        localStorage.removeItem('test');
        info.push('‚úÖ localStorage: Funzionante');
        log('localStorage disponibile', 'success');
      } catch(e) {
        info.push('‚ùå localStorage: BLOCCATO - ' + e.message);
        log('localStorage BLOCCATO: ' + e.message, 'error');
      }
      
      // Check sessionStorage
      try {
        sessionStorage.setItem('test', 'test');
        sessionStorage.removeItem('test');
        info.push('‚úÖ sessionStorage: Funzionante');
        log('sessionStorage disponibile', 'success');
      } catch(e) {
        info.push('‚ùå sessionStorage: BLOCCATO');
        log('sessionStorage BLOCCATO: ' + e.message, 'error');
      }
      
      // Check cookies
      const cookiesEnabled = navigator.cookieEnabled;
      info.push(cookiesEnabled ? '‚úÖ Cookies: Abilitati' : '‚ùå Cookies: DISABILITATI');
      log(`Cookies: ${cookiesEnabled ? 'abilitati' : 'DISABILITATI'}`, cookiesEnabled ? 'success' : 'error');
      
      // Current URL
      info.push('üåê URL: ' + window.location.origin);
      log('URL corrente: ' + window.location.origin, 'info');
      
      // Browser
      info.push('üñ•Ô∏è Browser: ' + navigator.userAgent.split(' ').slice(-2).join(' '));
      
      document.getElementById('systemInfo').innerHTML = info.join('<br>');
    }

    // ================== CONFIGURAZIONE ==================
    const BACKEND_NEWS = "/api/news";

    const BRAND_LINKS = {
      Fiat: "https://www.fiat.it/omni/configuratore/#/",
      Jeep: "https://www.jeep-official.it/omni/configuratore"
    };

    const firebaseConfig = {
      apiKey: "AIzaSyALsFF_dpL39GlPfMyKBFIKtZi5coOk9I8",
      authDomain: "auto-1af60.firebaseapp.com",
      projectId: "auto-1af60",
      storageBucket: "auto-1af60.firebasestorage.app",
      messagingSenderId: "498320258984",
      appId: "1:498320258984:web:bac67d7634273d10464f9d",
      measurementId: "G-WYM78KQWQJ"
    };

    // ================== UTILITY FUNCTIONS ==================
    const $ = (id) => document.getElementById(id);
    const setStatus = (t) => { $("status").textContent = t; };

    function escapeHtml(s = "") {
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function safeHost(url) {
      try { return new URL(url).hostname; } catch { return ""; }
    }

    function fmtDate(d) {
      if (!d) return "";
      const dt = new Date(d);
      if (Number.isNaN(dt.getTime())) return String(d);
      return dt.toLocaleString("it-IT", { 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit' 
      });
    }

    function renderItems(items) {
      const box = $("newsList");
      if (!items || !items.length) {
        box.innerHTML = '<div class="muted" style="padding:20px;text-align:center">Nessuna news disponibile.</div>';
        setStatus("Nessuna news trovata.");
        log('Nessuna news da visualizzare', 'info');
        return;
      }
      
      box.innerHTML = items.map(n => {
        const link = n.url || n.link || "";
        const title = n.title || "Senza titolo";
        const date = fmtDate(n.date || n.pubDate || "");
        const host = safeHost(link);
        
        return `
          <a class="newsItem" href="${escapeHtml(link)}" target="_blank" rel="noopener noreferrer">
            <div class="newsTitle">${escapeHtml(title)}</div>
            ${host ? `<div class="newsMeta">üìç ${escapeHtml(host)}</div>` : ''}
            ${date ? `<div class="newsDate">üïê ${escapeHtml(date)}</div>` : ""}
          </a>
        `;
      }).join("");
      
      setStatus(`‚úÖ ${items.length} news caricate - ${new Date().toLocaleString("it-IT")}`);
      log(`${items.length} news visualizzate`, 'success');
    }

    // ================== FIREBASE INITIALIZATION ==================
    log('Inizializzazione Firebase...', 'info');
    log('AuthDomain: ' + firebaseConfig.authDomain, 'info');
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" });

    log('Firebase inizializzato', 'success');

    // ================== SETUP ASYNC ==================
    (async function initApp() {
      // Check sistema
      checkSystemInfo();
      
      // Imposta persistenza
      log('Impostazione persistenza...', 'info');
      try {
        await setPersistence(auth, browserLocalPersistence);
        log('Persistenza configurata: browserLocalPersistence', 'success');
      } catch (e) {
        log('ERRORE persistenza: ' + (e.code || e.message), 'error');
        setStatus("‚ö†Ô∏è Errore configurazione: " + (e.code || e.message));
      }

      // Gestisci risultato redirect
      log('Controllo redirect result...', 'info');
      try {
        const result = await getRedirectResult(auth);
        if (result?.user) {
          log('Login da redirect: ' + result.user.email, 'success');
          log('User UID: ' + result.user.uid, 'info');
          setStatus("‚úÖ Login riuscito! Benvenuto " + result.user.email);
        } else {
          log('Nessun redirect result', 'info');
        }
      } catch (e) {
        log('ERRORE redirect: ' + (e.code || e.message), 'error');
        setStatus("‚ùå Errore login: " + (e.code || e.message));
      }
      
      // Check stato iniziale
      log('Controllo stato autenticazione iniziale...', 'info');
      const currentUser = auth.currentUser;
      if (currentUser) {
        log('Utente gi√† loggato: ' + currentUser.email, 'success');
      } else {
        log('Nessun utente loggato', 'info');
      }
    })();

    // ================== CARICAMENTO NEWS ==================
    async function loadNews() {
      const user = auth.currentUser;
      if (!user) {
        $("newsList").innerHTML = "";
        setStatus("üîí Effettua il login per vedere le news.");
        log('Tentativo caricamento news senza autenticazione', 'error');
        return;
      }

      log('Caricamento news per utente: ' + user.email, 'info');
      setStatus("‚è≥ Caricamento news...");
      $("refreshBtn").disabled = true;

      try {
        log('Fetch a: ' + BACKEND_NEWS, 'info');
        const response = await fetch(BACKEND_NEWS, {
          method: "GET",
          headers: { 'Cache-Control': 'no-cache' },
          cache: "no-store"
        });

        log('Response status: ' + response.status, response.ok ? 'success' : 'error');

        if (!response.ok) {
          const errorText = await response.text().catch(() => "");
          throw new Error(`HTTP ${response.status}${errorText ? ' - ' + errorText : ''}`);
        }

        const data = await response.json();
        log('Dati ricevuti: ' + JSON.stringify(data).substring(0, 100) + '...', 'info');
        
        if (data.items && Array.isArray(data.items)) {
          log('Trovati ' + data.items.length + ' items', 'success');
          renderItems(data.items);
        } else if (Array.isArray(data)) {
          log('Trovati ' + data.length + ' items (array diretto)', 'success');
          renderItems(data);
        } else {
          throw new Error("Formato dati non valido");
        }
      } catch (err) {
        log('ERRORE caricamento: ' + (err?.message || err), 'error');
        $("newsList").innerHTML = '<div class="muted" style="padding:20px;text-align:center">‚ùå Errore caricamento</div>';
        setStatus("‚ùå Errore: " + (err?.message || err));
      } finally {
        $("refreshBtn").disabled = !auth.currentUser;
      }
    }

    // ================== EVENT LISTENERS ==================
    $("loginBtn").addEventListener("click", async () => {
      log('Click su login button', 'info');
      try {
        setStatus("üîê Reindirizzamento a Google...");
        log('Avvio signInWithRedirect...', 'info');
        await signInWithRedirect(auth, provider);
        log('Redirect avviato (la pagina verr√† ricaricata)', 'info');
      } catch (e) {
        log('ERRORE login: ' + (e.code || e.message), 'error');
        setStatus("‚ùå Errore: " + (e.code || e.message));
      }
    });

    $("logoutBtn").addEventListener("click", async () => {
      log('Click su logout button', 'info');
      try {
        const email = auth.currentUser?.email;
        await signOut(auth);
        log('Logout completato per: ' + email, 'success');
        $("newsList").innerHTML = "";
        setStatus("üëã Logout effettuato.");
      } catch (e) {
        log('ERRORE logout: ' + (e.code || e.message), 'error');
        setStatus("‚ùå Errore logout: " + (e.code || e.message));
      }
    });

    $("refreshBtn").addEventListener("click", () => {
      log('Click su refresh', 'info');
      loadNews();
    });

    $("fiatBtn").addEventListener("click", () => {
      window.open(BRAND_LINKS.Fiat, "_blank", "noopener,noreferrer");
    });

    $("jeepBtn").addEventListener("click", () => {
      window.open(BRAND_LINKS.Jeep, "_blank", "noopener,noreferrer");
    });

    // ================== GESTIONE STATO AUTENTICAZIONE ==================
    onAuthStateChanged(auth, (user) => {
      log('üîî onAuthStateChanged triggered', 'info');
      
      if (user) {
        log('UTENTE LOGGATO: ' + user.email, 'success');
        log('UID: ' + user.uid, 'info');
        log('Provider: ' + (user.providerData[0]?.providerId || 'unknown'), 'info');
        
        $("userPill").textContent = "‚úÖ " + (user.email || "Utente");
        $("userPill").classList.remove("muted");
        $("userPill").style.borderColor = "rgba(34, 197, 94, 0.5)";
        $("userPill").style.background = "rgba(34, 197, 94, 0.1)";
        
        $("loginBtn").style.display = "none";
        $("logoutBtn").style.display = "inline-block";
        $("refreshBtn").disabled = false;
        
        log('Caricamento automatico news...', 'info');
        loadNews();
      } else {
        log('NESSUN UTENTE LOGGATO', 'info');
        
        $("userPill").textContent = "üîí Non autenticato";
        $("userPill").classList.add("muted");
        $("userPill").style.borderColor = "";
        $("userPill").style.background = "";
        
        $("loginBtn").style.display = "inline-block";
        $("logoutBtn").style.display = "none";
        $("refreshBtn").disabled = true;
        $("newsList").innerHTML = "";
        setStatus("üîí Effettua il login per caricare le news.");
      }
    });

    log('‚úÖ App inizializzata - in attesa di azioni utente', 'success');
  </script>
</body>
</html>
