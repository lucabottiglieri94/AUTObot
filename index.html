<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI BOTT Automotive</title>

  <style>
    :root{
      --bgTop:#07080b;
      --bgMid:#101216;
      --bgBot:#1a1d23;

      --panel: rgba(17,24,39,.78);
      --line:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#3b82f6;
      --accent2:#60a5fa;
    }

    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(1200px 700px at 18% -12%, rgba(59,130,246,.22), transparent 58%),
        radial-gradient(900px 520px at 72% 8%, rgba(96,165,250,.14), transparent 60%),
        linear-gradient(180deg, var(--bgTop) 0%, var(--bgMid) 48%, var(--bgBot) 100%);
    }

    header{
      position:relative;
      top:0;
      z-index:10;
      background:rgba(10,10,12,.72);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
    }

    .wrap{max-width:1200px;margin:0 auto;padding:16px}

    .row{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
      min-width: 320px;
    }

    /* LOGO TOP-LEFT + TESTO */
    .brandMark{
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .brandLogo{
      width:4cm;
      height:4cm;
      object-fit:contain;
      background:transparent;
      border:none;
      outline:none;
      filter:none;
      mix-blend-mode: screen;
    }

    .brandName{
      font-weight:950;
      letter-spacing:.2px;
      font-size:18px;
      line-height:1;
      background:linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      white-space:nowrap;
    }
    .brandSub{
      opacity:.75;
      white-space:nowrap;
    }

    .btn{
      border:1px solid var(--line);
      background:rgba(17,24,39,.75);
      color:var(--text);
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-size:14px;
      transition:all .2s;
      font-weight:650;
    }
    .btn:hover{
      border-color:rgba(59,130,246,.6);
      background:rgba(17,24,39,.92);
      transform:translateY(-1px);
    }
    .btn.primary{
      border-color:rgba(59,130,246,.55);
      background:rgba(37,99,235,.16);
    }
    .btn.primary:hover{background:rgba(37,99,235,.26)}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}

    .btn.brand-fiat:hover{border-color:rgba(220,38,38,.6);background:rgba(220,38,38,.1)}
    .btn.brand-jeep:hover{border-color:rgba(34,197,94,.6);background:rgba(34,197,94,.1)}
    .btn.brand-alfa:hover{border-color:rgba(239,68,68,.6);background:rgba(239,68,68,.1)}
    .btn.brand-lancia:hover{border-color:rgba(59,130,246,.6);background:rgba(59,130,246,.1)}

    /* CentroAuto Logo */
    .centroAutoLink{
      display:inline-flex;
      align-items:center;
      padding:6px 12px;
      border:2px solid rgba(34,197,94,.4);
      background:rgba(34,197,94,.08);
      border-radius:12px;
      transition:all .3s ease;
      text-decoration:none;
      box-shadow:0 2px 8px rgba(34,197,94,.15);
    }
    .centroAutoLink:hover{
      border-color:rgba(34,197,94,.7);
      background:rgba(34,197,94,.18);
      transform:translateY(-2px);
      box-shadow:0 4px 16px rgba(34,197,94,.3);
    }
    .centroAutoLogo{
      height:42px;
      width:auto;
      object-fit:contain;
      filter:drop-shadow(0 1px 3px rgba(0,0,0,.2));
    }

    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(17,24,39,.35);
      font-size:12px;
      white-space:nowrap;
    }
    .muted{color:var(--muted)}

    /* LAYOUT: NEWS A SINISTRA (riquadro scrollabile) */
    .layout{
      margin-top:16px;
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
      align-items:start;
    }

    .panel{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
    }

    .panelHeader{
      padding:14px 14px 10px 14px;
      border-bottom:1px solid rgba(31,41,55,.75);
      background:rgba(10,12,18,.35);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }

    .panelTitle{font-weight:950;font-size:18px}
    .panelSub{margin-top:6px}

    .newsScroll{
      max-height: calc(100vh - 140px);
      overflow:auto;
      padding:12px;
    }

    /* scrollbar (WebKit) */
    .newsScroll::-webkit-scrollbar{width:10px}
    .newsScroll::-webkit-scrollbar-thumb{
      background:rgba(59,130,246,.25);
      border:2px solid rgba(17,24,39,.7);
      border-radius:999px;
    }
    .newsScroll::-webkit-scrollbar-track{background:rgba(0,0,0,.12)}

    #status{margin:10px 0 0 0}
    #newsList{display:grid;gap:12px}

    .newsItem{
      display:block;
      padding:14px;
      border:1px solid var(--line);
      border-radius:14px;
      text-decoration:none;
      color:inherit;
      background:rgba(17,24,39,.35);
      transition:all .2s;
    }
    .newsItem:hover{
      border-color:rgba(59,130,246,.6);
      background:rgba(17,24,39,.55);
      transform:translateX(4px);
    }
    .newsTitle{font-weight:850;margin-bottom:8px}
    .newsMeta{opacity:.75;font-size:12px;margin-top:6px}
    .newsDate{opacity:.75;font-size:12px;margin-top:6px;font-style:italic}

    .rightSpace{
      padding:18px;
      border:1px dashed rgba(31,41,55,.7);
      border-radius:16px;
      background:rgba(0,0,0,.12);
    }

    /* ========== CHATBOT STYLES ========== */
    
    /* Pulsante AI Agent (bottom-right) */
    .chatTrigger{
      position:fixed;
      bottom:24px;
      right:24px;
      width:70px;
      height:70px;
      border-radius:50%;
      background:transparent;
      border:none;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 8px 24px rgba(0,0,0,.3);
      transition:all .3s ease;
      z-index:1000;
    }
    .chatTrigger:hover{
      transform:scale(1.1);
      box-shadow:0 12px 32px rgba(0,0,0,.5);
    }
    .chatTrigger img{
      width:70px;
      height:70px;
      object-fit:contain;
    }

    /* Chat Box Container */
    .chatBox{
      position:fixed;
      bottom:24px;
      right:24px;
      width:420px;
      max-width:calc(100vw - 32px);
      height:600px;
      max-height:calc(100vh - 48px);
      background:rgba(17,24,39,.95);
      border:1px solid var(--line);
      border-radius:20px;
      display:none;
      flex-direction:column;
      box-shadow:0 20px 60px rgba(0,0,0,.6);
      z-index:1001;
      overflow:hidden;
      backdrop-filter:blur(20px);
    }
    .chatBox.open{display:flex}
    .chatBox.minimized{
      width:70px;
      height:70px;
      background:transparent;
      border:none;
      border-radius:50%;
      box-shadow:0 8px 24px rgba(0,0,0,.3);
    }
    .chatBox.minimized .chatHeader,
    .chatBox.minimized .chatMessages,
    .chatBox.minimized .chatInput{
      display:none;
    }

    /* Chat Header */
    .chatHeader{
      background:linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.15);
    }
    .chatHeaderLeft{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .chatHeaderLogo{
      width:38px;
      height:38px;
      border-radius:50%;
      background:rgba(255,255,255,.15);
      padding:4px;
    }
    .chatHeaderTitle{
      font-weight:700;
      font-size:16px;
      color:#fff;
    }
    .chatHeaderSub{
      font-size:11px;
      color:rgba(255,255,255,.75);
      margin-top:2px;
    }
    .chatHeaderBtns{
      display:flex;
      gap:8px;
    }
    .chatHeaderBtn{
      width:32px;
      height:32px;
      border-radius:8px;
      background:rgba(255,255,255,.15);
      border:none;
      color:#fff;
      cursor:pointer;
      font-size:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all .2s;
      font-weight:700;
    }
    .chatHeaderBtn:hover{
      background:rgba(255,255,255,.25);
      transform:scale(1.05);
    }

    /* Chat Messages Area */
    .chatMessages{
      flex:1;
      overflow-y:auto;
      padding:16px;
      background:linear-gradient(180deg, 
        rgba(26,29,35,.95) 0%, 
        rgba(16,18,22,.95) 100%);
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .chatMessages::-webkit-scrollbar{width:8px}
    .chatMessages::-webkit-scrollbar-thumb{
      background:rgba(59,130,246,.3);
      border-radius:999px;
    }
    .chatMessages::-webkit-scrollbar-track{background:rgba(0,0,0,.2)}

    /* Message Bubbles */
    .message{
      display:flex;
      gap:8px;
      animation:slideIn .3s ease;
    }
    @keyframes slideIn{
      from{opacity:0;transform:translateY(10px)}
      to{opacity:1;transform:translateY(0)}
    }

    .message.user{
      flex-direction:row-reverse;
    }
    .messageBubble{
      max-width:85%;
      padding:12px 16px;
      border-radius:18px;
      font-size:14px;
      line-height:1.6;
      word-wrap:break-word;
      white-space:pre-line;
    }
    .message.ai .messageBubble{
      background:linear-gradient(135deg, rgba(59,130,246,.85) 0%, rgba(96,165,250,.85) 100%);
      color:#fff;
      border-bottom-left-radius:4px;
    }
    .message.user .messageBubble{
      background:rgba(255,255,255,.92);
      color:#1a1d23;
      border-bottom-right-radius:4px;
    }

    /* Typing Indicator */
    .typingIndicator{
      display:flex;
      gap:8px;
      padding:12px 16px;
      background:linear-gradient(135deg, rgba(59,130,246,.85) 0%, rgba(96,165,250,.85) 100%);
      border-radius:18px;
      border-bottom-left-radius:4px;
      max-width:75%;
    }
    .typingDot{
      width:8px;
      height:8px;
      border-radius:50%;
      background:rgba(255,255,255,.9);
      animation:bounce 1.4s infinite ease-in-out;
    }
    .typingDot:nth-child(1){animation-delay:0s}
    .typingDot:nth-child(2){animation-delay:.2s}
    .typingDot:nth-child(3){animation-delay:.4s}
    @keyframes bounce{
      0%,80%,100%{transform:scale(0)}
      40%{transform:scale(1)}
    }

    /* Chat Input */
    .chatInput{
      padding:16px;
      background:rgba(10,12,18,.95);
      border-top:1px solid var(--line);
      display:flex;
      gap:10px;
    }
    .chatInputField{
      flex:1;
      background:rgba(31,41,55,.6);
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px 16px;
      color:var(--text);
      font-size:14px;
      outline:none;
      transition:all .2s;
      font-family:inherit;
    }
    .chatInputField:focus{
      border-color:var(--accent);
      background:rgba(31,41,55,.8);
    }
    .chatInputField::placeholder{
      color:var(--muted);
    }
    .chatSendBtn{
      width:48px;
      height:48px;
      border-radius:12px;
      background:linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
      border:none;
      color:#fff;
      cursor:pointer;
      font-size:20px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all .2s;
    }
    .chatSendBtn:hover:not(:disabled){
      transform:scale(1.05);
      box-shadow:0 4px 16px rgba(59,130,246,.4);
    }
    .chatSendBtn:disabled{
      opacity:.5;
      cursor:not-allowed;
    }

    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
      .newsScroll{max-height: 60vh}
      .brand{min-width: unset}
      .chatBox{
        width:100%;
        max-width:100%;
        height:100vh;
        max-height:100vh;
        bottom:0;
        right:0;
        border-radius:0;
      }
      .chatTrigger{
        bottom:16px;
        right:16px;
        width:60px;
        height:60px;
      }
    }

    /* ===== COMPARATORE ===== */
    .cmpSuggest{
      background:rgba(59,130,246,.12);
      border:1px solid rgba(59,130,246,.3);
      border-radius:999px;
      padding:4px 10px;
      color:#93c5fd;
      font-size:11px;
      cursor:pointer;
      transition:all .2s;
      font-family:inherit;
    }
    .cmpSuggest:hover{
      background:rgba(59,130,246,.25);
      border-color:rgba(59,130,246,.6);
    }
    .cmpCard{
      flex:1;
      min-width:220px;
      background:rgba(31,41,55,.45);
      border:1px solid rgba(59,130,246,.2);
      border-radius:14px;
      overflow:hidden;
    }
    .cmpCardHeader{
      padding:12px 16px;
      font-weight:800;
      font-size:15px;
      border-bottom:1px solid rgba(31,41,55,.8);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .cmpCardHeader.left{ background:rgba(59,130,246,.18); }
    .cmpCardHeader.right{ background:rgba(96,165,250,.14); }
    .cmpRow{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      padding:9px 16px;
      border-bottom:1px solid rgba(31,41,55,.4);
      font-size:13px;
      gap:8px;
    }
    .cmpRow:last-child{ border-bottom:none; }
    .cmpLabel{ color:#9ca3af; white-space:nowrap; min-width:90px; }
    .cmpVal{ color:#e5e7eb; text-align:right; font-weight:600; }
    .cmpWin{ color:#4ade80; }
    .cmpVerdict{
      margin-top:16px;
      padding:14px 16px;
      background:rgba(59,130,246,.1);
      border:1px solid rgba(59,130,246,.25);
      border-radius:12px;
      font-size:13px;
      line-height:1.6;
      color:#e5e7eb;
    }
    .cmpLoading{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:40px;
      color:#9ca3af;
      font-size:14px;
    }
    .cmpDot{
      width:8px;height:8px;border-radius:50%;
      background:#3b82f6;
      animation:bounce 1.4s infinite ease-in-out;
    }
    .cmpDot:nth-child(2){animation-delay:.2s}
    .cmpDot:nth-child(3){animation-delay:.4s}

    @media (max-width: 768px){
      .btn{padding:8px 10px;font-size:13px}
      .brandLogo{width:30px;height:30px}
      .brandName{font-size:16px}
      .centroAutoLogo{height:36px}
      .centroAutoLink{padding:4px 8px}
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="row">
        <div class="brand">
          <div class="brandMark">
            <img
              class="brandLogo"
              src="https://image2url.com/r2/default/images/1770729951588-711e8f2c-9f48-4ef1-9af3-be4b1f7b5d9f.png"
              alt="AI BOTT logo"
            />
            <div>
              <div class="brandName">AI BOTT</div>
              <div class="brandSub">Automotive</div>
            </div>
          </div>

          <button id="fiatBtn" class="btn brand-fiat">Fiat</button>
          <button id="jeepBtn" class="btn brand-jeep">Jeep</button>
          <button id="alfaBtn" class="btn brand-alfa">Alfa Romeo</button>
          <button id="lanciaBtn" class="btn brand-lancia">Lancia</button>
          
          <!-- Logo CentroAuto -->
          <a 
            href="https://www.centroautovt.it/" 
            target="_blank" 
            rel="noopener noreferrer"
            class="centroAutoLink"
            title="Visita CentroAuto VT"
          >
            <img 
              src="https://image2url.com/r2/default/images/1770805237740-1db65b1e-5553-4b5b-b28a-750e3520a0a2.png" 
              alt="CentroAuto VT" 
              class="centroAutoLogo"
            />
          </a>
        </div>

        <div class="row" style="gap:10px">
          <span id="userPill" class="pill muted">Non autenticato</span>
          <button id="loginBtn" class="btn primary">Login Google</button>
          <button id="logoutBtn" class="btn" style="display:none">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="layout">
      <!-- NEWS A SINISTRA -->
      <aside class="panel">
        <div class="panelHeader">
          <div>
            <div class="panelTitle">&#128240; Ultime News</div>
            <div class="muted panelSub">Visibili solo dopo login.</div>
            <div id="status" class="muted">Effettua il login per caricare le news.</div>
          </div>
          <button id="refreshBtn" class="btn" disabled>&#128260;</button>
        </div>

        <div class="newsScroll">
          <div id="newsList"></div>
        </div>
      </aside>

      <!-- CONTENUTI A DESTRA -->
      <section class="rightSpace" style="padding:0;border:none;background:none;">

        <!-- ===== COMPARATORE AUTO ===== -->
        <div id="comparatorPanel" style="
          background:rgba(17,24,39,.78);
          border:1px solid #1f2937;
          border-radius:16px;
          overflow:hidden;
        ">
          <!-- Header -->
          <div style="
            padding:16px 20px;
            border-bottom:1px solid rgba(31,41,55,.75);
            background:rgba(10,12,18,.35);
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:12px;
            flex-wrap:wrap;
          ">
            <div>
              <div style="font-weight:950;font-size:18px">&#9878; Comparatore Auto</div>
              <div style="color:#9ca3af;font-size:13px;margin-top:4px">Confronta due auto fianco a fianco</div>
            </div>
            <button id="cmpResetBtn" class="btn" style="font-size:12px;padding:7px 12px;">
              &#10227; Reset
            </button>
          </div>

          <!-- Input row -->
          <div style="padding:16px 20px;border-bottom:1px solid rgba(31,41,55,.5);display:flex;gap:10px;flex-wrap:wrap;">
            <input id="cmpInput1" type="text" placeholder="Auto 1 ‚Äî es. Jeep Compass Longitude"
              style="flex:1;min-width:180px;background:rgba(31,41,55,.6);border:1px solid #1f2937;
                border-radius:10px;padding:10px 14px;color:#e5e7eb;font-size:13px;outline:none;
                font-family:inherit;transition:border-color .2s"
              onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#1f2937'"
            />
            <div style="display:flex;align-items:center;color:#9ca3af;font-size:18px;font-weight:700;">VS</div>
            <input id="cmpInput2" type="text" placeholder="Auto 2 ‚Äî es. Fiat Tipo Cross"
              style="flex:1;min-width:180px;background:rgba(31,41,55,.6);border:1px solid #1f2937;
                border-radius:10px;padding:10px 14px;color:#e5e7eb;font-size:13px;outline:none;
                font-family:inherit;transition:border-color .2s"
              onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#1f2937'"
            />
            <button id="cmpBtn" onclick="startComparison()" style="
              background:linear-gradient(135deg,#3b82f6,#60a5fa);
              border:none;border-radius:10px;padding:10px 20px;
              color:#fff;font-weight:700;font-size:14px;cursor:pointer;
              transition:all .2s;white-space:nowrap;font-family:inherit;
            "
              onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 4px 16px rgba(59,130,246,.4)'"
              onmouseout="this.style.transform='none';this.style.boxShadow='none'"
            >
              &#128269; Confronta
            </button>
          </div>

          <!-- Quick suggestions -->
          <div style="padding:10px 20px;border-bottom:1px solid rgba(31,41,55,.4);display:flex;gap:8px;flex-wrap:wrap;">
            <span style="color:#9ca3af;font-size:12px;align-self:center;">Esempio rapido:</span>
            <button class="cmpSuggest" onclick="setSuggest('Jeep Compass Longitude','Jeep Compass Limited')">Compass Longitude vs Limited</button>
            <button class="cmpSuggest" onclick="setSuggest('Fiat Panda','Fiat Tipo')">Panda vs Tipo</button>
            <button class="cmpSuggest" onclick="setSuggest('Alfa Romeo Giulia','Alfa Romeo Stelvio')">Giulia vs Stelvio</button>
          </div>

          <!-- Results area -->
          <div id="cmpResults" style="padding:20px;min-height:120px;">
            <div style="text-align:center;color:#9ca3af;padding:30px 0;font-size:14px;">
              &#8593; Inserisci due auto e premi Confronta
            </div>
          </div>
        </div>

      </section>
    </div>
  </main>

  <!-- ========== CHATBOT UI ========== -->
  
  <!-- Pulsante trigger -->
  <div class="chatTrigger" id="chatTrigger">
    <img 
      src="https://image2url.com/r2/default/images/1770729951588-711e8f2c-9f48-4ef1-9af3-be4b1f7b5d9f.png" 
      alt="AI Agent"
    />
  </div>

  <!-- Chat Box -->
  <div class="chatBox" id="chatBox">
    <!-- Logo visibile quando minimizzato -->
    <img 
      id="chatMinimizedLogo"
      src="https://image2url.com/r2/default/images/1770729951588-711e8f2c-9f48-4ef1-9af3-be4b1f7b5d9f.png" 
      alt="AI Agent"
      style="display:none; width:70px; height:70px; object-fit:contain; cursor:pointer;"
    />
    
    <div class="chatHeader">
      <div class="chatHeaderLeft">
        <img 
          class="chatHeaderLogo" 
          src="https://image2url.com/r2/default/images/1770729951588-711e8f2c-9f48-4ef1-9af3-be4b1f7b5d9f.png" 
          alt="AI"
        />
        <div>
          <div class="chatHeaderTitle">AI BOTT Assistant</div>
          <div class="chatHeaderSub">Esperto configurazioni</div>
        </div>
      </div>
      <div class="chatHeaderBtns">
        <button class="chatHeaderBtn" id="minimizeBtn" title="Minimizza">&#8722;</button>
        <button class="chatHeaderBtn" id="closeBtn" title="Chiudi">&#10005;</button>
      </div>
    </div>

    <div class="chatMessages" id="chatMessages">
      <!-- Messaggio di benvenuto -->
      <div class="message ai">
        <div class="messageBubble">Ciao! &#128075; Sono <strong>AI BOTT</strong>, il tuo assistente auto.

&#128269; Chiedimi di:
&#8226; Auto <strong>nuove</strong> &mdash; Fiat, Jeep, Alfa, Lancia
&#8226; Auto <strong>usate</strong> &mdash; CentroAuto VT (Ford, Jeep, Opel, VW...)

&#9997; Es: <em>&ldquo;Ford usata&rdquo;</em> oppure <em>&ldquo;Compass allestimenti&rdquo;</em></div></div>
      </div>

    <div class="chatInput">
      <input 
        type="text" 
        class="chatInputField" 
        id="chatInputField" 
        placeholder="Es: auto usate disponibili oppure confronta Compass Longitude e Limited"
        autocomplete="off"
      />
      <button class="chatSendBtn" id="chatSendBtn">
        &#10148;
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth,
      setPersistence,
      browserLocalPersistence,
      browserSessionPersistence,
      GoogleAuthProvider,
      signInWithPopup,
      signInWithRedirect,
      getRedirectResult,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    const BACKEND_NEWS = "/api/news";
    const BACKEND_CHAT = "https://auto-backend-three.vercel.app/api/chat";
    const BACKEND_SEARCH = "https://auto-backend-three.vercel.app/api/search";

    const BRAND_LINKS = {
      Fiat: "https://www.fiat.it/omni/configuratore/#/",
      Jeep: "https://www.jeep-official.it/omni/configuratore",
      AlfaRomeo: "https://www.alfaromeo.it/omni/configuratore",
      Lancia: "https://www.lancia.it/omni/configuratore"
    };

    const firebaseConfig = {
      apiKey: "AIzaSyALsFF_dpL39GlPfMyKBFIKtZi5coOk9I8",
      authDomain: "auto-1af60.firebaseapp.com",
      projectId: "auto-1af60",
      storageBucket: "auto-1af60.firebasestorage.app",
      messagingSenderId: "498320258984",
      appId: "1:498320258984:web:bac67d7634273d10464f9d",
      measurementId: "G-WYM78KQWQJ"
    };

    const $ = (id) => document.getElementById(id);
    const setStatus = (t) => { $("status").textContent = t; };

    function escapeHtml(s = "") {
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function safeHost(url) {
      try { return new URL(url).hostname; } catch { return ""; }
    }

    function fmtDate(d) {
      if (!d) return "";
      const dt = new Date(d);
      if (Number.isNaN(dt.getTime())) return String(d);
      return dt.toLocaleString("it-IT", {
        day:"2-digit", month:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit"
      });
    }

    function renderItems(items) {
      const box = $("newsList");
      if (!items || !items.length) {
        box.innerHTML = '<div class="muted" style="padding:20px;text-align:center">Nessuna news disponibile.</div>';
        setStatus("Nessuna news trovata.");
        return;
      }

      box.innerHTML = items.map(n => {
        const link = n.url || n.link || "";
        const title = n.title || "Senza titolo";
        const date = fmtDate(n.date || n.pubDate || "");
        const host = safeHost(link);

        return `
          <a class="newsItem" href="${escapeHtml(link)}" target="_blank" rel="noopener noreferrer">
            <div class="newsTitle">${escapeHtml(title)}</div>
            ${host ? `<div class="newsMeta">üîó ${escapeHtml(host)}</div>` : ""}
            ${date ? `<div class="newsDate">üïê ${escapeHtml(date)}</div>` : ""}
          </a>
        `;
      }).join("");

      setStatus(`‚úÖ ${items.length} news caricate ‚Ä¢ ${new Date().toLocaleString("it-IT")}`);
    }

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt:"select_account", display:"popup" });

    (async function initApp(){
      try { await setPersistence(auth, browserLocalPersistence); }
      catch {
        try { await setPersistence(auth, browserSessionPersistence); } catch {}
      }

      try{
        const result = await getRedirectResult(auth);
        if (result?.user) setStatus("Login riuscito! Benvenuto " + result.user.email);
      }catch(e){
        setStatus("Errore login: " + (e.code || e.message));
      }
    })();

    async function loadNews() {
      const user = auth.currentUser;
      if (!user) {
        $("newsList").innerHTML = "";
        setStatus("üîí Effettua il login per vedere le news.");
        return;
      }

        setStatus("Caricamento news...");
      $("refreshBtn").disabled = true;

      try {
        const response = await fetch(BACKEND_NEWS, {
          method:"GET",
          headers:{ "Cache-Control":"no-cache" },
          cache:"no-store"
        });

        if (!response.ok) {
          const errorText = await response.text().catch(() => "");
          throw new Error(`HTTP ${response.status}${errorText ? " - " + errorText : ""}`);
        }

        const data = await response.json();

        if (data.items && Array.isArray(data.items)) renderItems(data.items);
        else if (Array.isArray(data)) renderItems(data);
        else throw new Error("Formato dati non valido");
      } catch (err) {
        $("newsList").innerHTML = '<div class="muted" style="padding:20px;text-align:center">Errore caricamento news</div>';
        setStatus("Errore: " + (err?.message || err));
      } finally {
        $("refreshBtn").disabled = !auth.currentUser;
      }
    }

    $("loginBtn").addEventListener("click", async () => {
      try {
        setStatus("üì≤ Apertura login Google...");

        try {
          const result = await signInWithPopup(auth, provider);
          setStatus("Login riuscito! Benvenuto " + result.user.email);
        } catch (popupError) {
          if (popupError.code === "auth/popup-blocked" ||
              popupError.code === "auth/popup-closed-by-user" ||
              popupError.code === "auth/cancelled-popup-request") {
            setStatus("üîÑ Reindirizzamento in corso...");
            await signInWithRedirect(auth, provider);
          } else {
            throw popupError;
          }
        }
      } catch (e) {
        let errorMsg = "Errore sconosciuto";
        if (e.code === "auth/unauthorized-domain") errorMsg = "Dominio non autorizzato in Firebase Console";
        else if (e.code === "auth/popup-blocked") errorMsg = "Popup bloccato dal browser";
        else errorMsg = e.code || e.message;
        setStatus("√¢¬ù≈í " + errorMsg);
      }
    });

    $("logoutBtn").addEventListener("click", async () => {
      try {
        await signOut(auth);
        $("newsList").innerHTML = "";
        setStatus("Logout effettuato.");
      } catch (e) {
        setStatus("√¢¬ù≈í Errore logout: " + (e.code || e.message));
      }
    });

    $("refreshBtn").addEventListener("click", loadNews);

    $("fiatBtn").addEventListener("click", () => window.open(BRAND_LINKS.Fiat, "_blank", "noopener,noreferrer"));
    $("jeepBtn").addEventListener("click", () => window.open(BRAND_LINKS.Jeep, "_blank", "noopener,noreferrer"));
    $("alfaBtn").addEventListener("click", () => window.open(BRAND_LINKS.AlfaRomeo, "_blank", "noopener,noreferrer"));
    $("lanciaBtn").addEventListener("click", () => window.open(BRAND_LINKS.Lancia, "_blank", "noopener,noreferrer"));

    onAuthStateChanged(auth, (user) => {
      if (user) {
        $("userPill").textContent = "‚úÖ " + (user.email || "Utente");
        $("userPill").classList.remove("muted");
        $("userPill").style.borderColor = "rgba(34,197,94,.5)";
        $("userPill").style.background = "rgba(34,197,94,.1)";

        $("loginBtn").style.display = "none";
        $("logoutBtn").style.display = "inline-block";
        $("refreshBtn").disabled = false;

        loadNews();
      } else {
        $("userPill").textContent = "Non autenticato";
        $("userPill").classList.add("muted");
        $("userPill").style.borderColor = "";
        $("userPill").style.background = "";

        $("loginBtn").style.display = "inline-block";
        $("logoutBtn").style.display = "none";
        $("refreshBtn").disabled = true;

        $("newsList").innerHTML = "";
        setStatus("Effettua il login per caricare le news.");
      }
    });

    // ========== CHATBOT LOGIC - IMPROVED ========== 
    
    let chatHistory = [];
    let isMinimized = false;

    const chatTrigger = $("chatTrigger");
    const chatBox = $("chatBox");
    const chatMessages = $("chatMessages");
    const chatInputField = $("chatInputField");
    const chatSendBtn = $("chatSendBtn");
    const minimizeBtn = $("minimizeBtn");
    const closeBtn = $("closeBtn");

    // Toggle chat
    chatTrigger.addEventListener("click", () => {
      chatBox.classList.add("open");
      chatBox.classList.remove("minimized");
      chatTrigger.style.display = "none";
      $("chatMinimizedLogo").style.display = "none";
      chatInputField.focus();
    });

    // Minimize
    minimizeBtn.addEventListener("click", () => {
      chatBox.classList.add("minimized");
      isMinimized = true;
      $("chatMinimizedLogo").style.display = "block";
    });

    // Close (senza cancellare la cronologia)
    closeBtn.addEventListener("click", () => {
      chatBox.classList.remove("open");
      chatBox.classList.remove("minimized");
      chatTrigger.style.display = "flex";
    });

    // Riapertura da header o logo minimizzato
    chatBox.querySelector(".chatHeader").addEventListener("click", (e) => {
      if (isMinimized && !e.target.closest("button")) {
        chatBox.classList.remove("minimized");
        isMinimized = false;
        $("chatMinimizedLogo").style.display = "none";
      }
    });

    $("chatMinimizedLogo").addEventListener("click", () => {
      chatBox.classList.remove("minimized");
      isMinimized = false;
      $("chatMinimizedLogo").style.display = "none";
      chatInputField.focus();
    });

    // Add message to UI
    /** Trasforma URL e tag LINK: in anchor cliccabili */
    function linkify(text) {
      // Prima esegui escape HTML sul testo
      let safe = text.replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
      // Poi trasforma URL raw in <a> tag
      safe = safe.replace(
        /(https?:\/\/[^\s<>"]+)/g,
        '<a href="$1" target="_blank" rel="noopener noreferrer" style="color:#fff;text-decoration:underline;word-break:break-all;">$1</a>'
      );
      return safe;
    }

    function addMessage(text, sender) {
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${sender}`;
      
      // Per AI: linkifica URL e mantieni formattazione con \n
      // Per utente: solo escape HTML base
      const content = sender === 'ai' ? linkify(text) : escapeHtml(text);
      
      messageDiv.innerHTML = `
        <div class="messageBubble">${content}</div>
      `;
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Add typing indicator
    function showTyping() {
      const typingDiv = document.createElement("div");
      typingDiv.className = "message ai";
      typingDiv.id = "typingIndicator";
      typingDiv.innerHTML = `
        <div class="typingIndicator">
          <div class="typingDot"></div>
          <div class="typingDot"></div>
          <div class="typingDot"></div>
        </div>
      `;
      chatMessages.appendChild(typingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function hideTyping() {
      const typing = $("typingIndicator");
      if (typing) typing.remove();
    }

    // MAPPA MARCHE USATO - CentroAuto VT
    const USED_CAR_BRANDS = [
      { keywords: ['ford','focus','fiesta','kuga','ecosport','mustang','transit'], slug: 'ford',         label: 'Ford'       },
      { keywords: ['jeep','renegade','compass','wrangler','cherokee','avenger'],   slug: 'jeep',         label: 'Jeep'       },
      { keywords: ['kia','sportage','picanto','rio','ceed','niro'],                slug: 'kia',          label: 'Kia'        },
      { keywords: ['lancia','ypsilon','delta'],                                    slug: 'lancia',       label: 'Lancia'     },
      { keywords: ['land rover','range rover','evoque','defender','discovery'],    slug: 'land-rover',   label: 'Land Rover' },
      { keywords: ['man'],                                                          slug: 'man',          label: 'MAN'        },
      { keywords: ['mazda','cx-5','mx-5','mazda2','mazda3'],                       slug: 'mazda',        label: 'Mazda'      },
      { keywords: ['mg'],                                                           slug: 'mg',           label: 'MG'         },
      { keywords: ['opel','corsa','astra','mokka','grandland'],                    slug: 'opel',         label: 'Opel'       },
      { keywords: ['peugeot','208','308','2008','3008','5008'],                    slug: 'peugeot',      label: 'Peugeot'    },
      { keywords: ['renault','clio','captur','megane','kadjar'],                   slug: 'renault',      label: 'Renault'    },
      { keywords: ['seat','ibiza','leon','arona','ateca'],                         slug: 'seat',         label: 'Seat'       },
      { keywords: ['smart','fortwo','forfour'],                                    slug: 'smart',        label: 'Smart'      },
      { keywords: ['suzuki','vitara','swift','ignis','jimny'],                     slug: 'suzuki',       label: 'Suzuki'     },
      { keywords: ['volkswagen','vw','golf','polo','tiguan','passat','t-roc'],     slug: 'volkswagen',   label: 'Volkswagen' },
      { keywords: ['audi'],                                                         slug: 'audi',         label: 'Audi'       },
      { keywords: ['bmw'],                                                          slug: 'bmw',          label: 'BMW'        },
      { keywords: ['mercedes'],                                                     slug: 'mercedes-benz',label: 'Mercedes'   },
      { keywords: ['volvo'],                                                        slug: 'volvo',        label: 'Volvo'      },
      { keywords: ['toyota'],                                                       slug: 'toyota',       label: 'Toyota'     },
      { keywords: ['honda'],                                                        slug: 'honda',        label: 'Honda'      },
      { keywords: ['nissan'],                                                       slug: 'nissan',       label: 'Nissan'     },
      { keywords: ['hyundai'],                                                      slug: 'hyundai',      label: 'Hyundai'    },
      { keywords: ['citroen','citro√´hn'],                                  slug: 'citroen',      label: 'Citroen'    },
      { keywords: ['dacia'],                                                        slug: 'dacia',        label: 'Dacia'      },
      { keywords: ['skoda'],                                                        slug: 'skoda',        label: 'Skoda'      },
      { keywords: ['mini'],                                                         slug: 'mini',         label: 'MINI'       },
    ];

    const CENTROAUTO_BASE = 'https://www.centroautovt.it/ricerca-auto/usate';

    /** Rileva il brand menzionato nel testo, o null */
    function detectUsedBrand(text) {
      const lower = text.toLowerCase();
      return USED_CAR_BRANDS.find(b => b.keywords.some(kw => lower.includes(kw))) || null;
    }

    /**
     * True se la domanda riguarda auto usate / CentroAuto.
     * IMPORTANTE: scatta anche solo citando una marca del parco usato,
     * senza dover scrivere "usata/o" esplicitamente.
     */
    function isUsedCarQuery(text) {
      const lower = text.toLowerCase();
      const usedKeywords = [
        'usato','usata','usati','usate','seconda mano','km zero',
        'centroauto','centro auto','occasione','occasioni','pronta consegna',
        'chilometri','immatricolazione','immatricolata','stock'
      ];
      if (usedKeywords.some(kw => lower.includes(kw))) return true;
      return !!detectUsedBrand(text);
    }

    // Verifica se la domanda riguarda auto (usate O nuove)
    function needsSearch(text) {
      if (isUsedCarQuery(text)) return true;
      const newCarKeywords = [
        'prezzo','costo','quanto costa','listino',
        'allestimento','versione','dotazione','equipaggiamento','optional','serie',
        'motore','motorizzazione','cavalli','cv','kw','cilindrata',
        'consumi','autonomia','km/l','emissioni',
        'dimensioni','lunghezza','larghezza','altezza','bagagliaio',
        'colori','tinta','verniciatura','disponibilita','tempi consegna',
        'caratteristiche','scheda tecnica','specifiche',
        'confronto','differenza','meglio','vs',
        'ibrida','elettrica','plug-in','mild hybrid','full hybrid',
        'diesel','benzina','gpl','metano',
        'trazione','integrale','4x4','awd','cambio','automatico','manuale',
        'adas','sicurezza','airbag','frenata automatica',
        'garanzia','manutenzione','tagliando',
        'panda','punto','500','tipo','ducato',
        'renegade','compass','wrangler','cherokee','avenger',
        'giulia','stelvio','tonale','giulietta',
        'ypsilon','delta'
      ];
      const lower = text.toLowerCase();
      return newCarKeywords.some(kw => lower.includes(kw));
    }

    // RICERCA: CentroAuto per usato, configuratori ufficiali per nuovo
    async function searchCarInfo(query) {
      try {
        if (isUsedCarQuery(query)) {
          // RAMO USATO - punta sempre e solo su centroautovt.it
          const brand = detectUsedBrand(query);
          const directUrl = brand
            ? `${CENTROAUTO_BASE}?brand=${brand.slug}`
            : CENTROAUTO_BASE;

          // Prova backend con ricerca forzata su centroautovt.it
          const searchQuery = brand
            ? `${brand.label} usata site:centroautovt.it`
            : `auto usate site:centroautovt.it`;

          let backendResult = null;
          try {
            const resp = await fetch(`${BACKEND_SEARCH}?q=${encodeURIComponent(searchQuery)}`);
            if (resp.ok) {
              const data = await resp.json();
              if (data.results && data.results.length > 0) {
                // Tieni SOLO risultati da centroautovt.it
                const valid = data.results.filter(r =>
                  r.url && r.url.toLowerCase().includes('centroautovt.it')
                );
                if (valid.length > 0) {
                  backendResult = valid.slice(0, 5).map(r =>
                    `\ud83d\ude97 ${r.title}\n${r.description || ''}\n\ud83d\udd17 ${r.url}`
                  ).join('\n\n---\n\n');
                }
              }
            }
          } catch (_) { /* ignora errori backend */ }

          // FALLBACK GARANTITO: link diretto CentroAuto con filtro marca
          if (!backendResult) {
            const brandLine = brand
              ? `${brand.label} usata su CentroAuto VT`
              : 'Tutte le auto usate su CentroAuto VT';
            backendResult =
              `\ud83d\ude97 ${brandLine}\n` +
              `Clicca per vedere il parco auto aggiornato in tempo reale.\n` +
              `\ud83d\udd17 ${directUrl}\n\n` +
              `---\n` +
              `\ud83d\udccd CentroAuto VT - Viterbo\n` +
              `\ud83d\udd17 ${CENTROAUTO_BASE}`;
          }

          return backendResult;

        } else {
          // RAMO NUOVE - configuratori ufficiali Fiat/Jeep/Alfa/Lancia
          const officialQuery = `${query} allestimenti versioni (site:fiat.it OR site:jeep-official.it OR site:alfaromeo.it OR site:lancia.it)`;
          const allowedDomains = ['fiat.it','jeep-official.it','alfaromeo.it','lancia.it'];

          const response = await fetch(`${BACKEND_SEARCH}?q=${encodeURIComponent(officialQuery)}`);
          if (!response.ok) throw new Error("Errore ricerca");
          const data = await response.json();

          if (data.results && data.results.length > 0) {
            const valid = data.results.filter(r => {
              const url = (r.url || '').toLowerCase();
              return allowedDomains.some(d => url.includes(d));
            });
            if (valid.length === 0) return null;
            return valid.slice(0, 3).map(r => {
              const brand = r.url.includes('fiat') ? 'Fiat' :
                            r.url.includes('jeep') ? 'Jeep' :
                            r.url.includes('alfa') ? 'Alfa Romeo' : 'Lancia';
              return `--- ${brand.toUpperCase()} ---\n${r.title}\n\n${r.description}\n\n\ud83d\udd17 ${r.url}`;
            }).join('\n\n');
          }
          return null;
        }
      } catch (err) {
        console.error('Errore ricerca:', err);
        return null;
      }
    }


    // SISTEMA PROMPT MIGLIORATO
    const SYSTEM_PROMPT = `Sei un assistente esperto di auto NUOVE e USATE.

AUTO NUOVE: Fiat, Jeep, Alfa Romeo, Lancia (configuratori ufficiali)
AUTO USATE: CentroAuto VT (https://www.centroautovt.it/)

MARCHE USATO DISPONIBILI:
Ford (9), Jeep (13), Kia (1), Lancia (4), Land Rover (1),
MAN (1), Mazda (2), MG (2), Opel (2), Peugeot (2),
Renault (3), Seat (1), Smart (1), Suzuki (1), Volkswagen (4)

================================

REGOLE FONDAMENTALI:
1. Risposte SCHEMATICHE e CONCISE (max 10 righe)
2. Usa elenchi puntati con trattino (-)
3. Evidenzia solo INFO ESSENZIALI
4. Basati SOLO sui dati forniti

================================

FORMATO AUTO NUOVE:

Per INFO GENERALI:
- Punto chiave 1
- Punto chiave 2
- Punto chiave 3

Per CONFRONTI ALLESTIMENTI:
[ALLESTIMENTO 1]
- Caratteristica esclusiva 1
- Caratteristica esclusiva 2

[ALLESTIMENTO 2]
- Caratteristica esclusiva 1
- Caratteristica esclusiva 2

Consiglio: [suggerimento breve]

================================

FORMATO AUTO USATE:

Per ogni auto trovata usa ESATTAMENTE questo schema:
--- MARCA MODELLO ---
Anno: XXXX
Km: XXX.XXX
Prezzo: euro XX.XXX
Motore: [info motore]
Accessori: [lista]
Link: https://www.centroautovt.it/ricerca-auto/usate?brand=SLUG

REGOLE USATO:
- Mostra SEMPRE marca, modello, prezzo, km, anno
- Max 3-4 auto per risposta
- Filtra per marca se richiesta
- Scrivi i link come testo semplice (NO tag HTML)
- Usa solo lettere normali, NO emoji nei testi strutturati

================================

ATTENZIONE:
- NO informazioni inventate
- NO descrizioni narrative lunghe
- Se non hai dati precisi, dillo chiaramente
- Usa SOLO testo ASCII nei formati strutturati (niente emoji nei campi dati)`;


    // Send message to AI
    async function sendMessage() {
      const userMessage = chatInputField.value.trim();
      if (!userMessage) return;

      addMessage(userMessage, "user");
      chatInputField.value = "";
      chatSendBtn.disabled = true;

      chatHistory.push({ role: "user", content: userMessage });

      showTyping();

      try {
        let searchResults = null;

        // Cerca solo se riguarda auto
        if (needsSearch(userMessage)) {
          searchResults = await searchCarInfo(userMessage);
        }

        // Prepara i messaggi per l'API
        const messages = [
          { role: "system", content: SYSTEM_PROMPT },
          ...chatHistory
        ];

        // Se ci sono risultati di ricerca, aggiungili al contesto
        if (searchResults) {
          messages.push({
            role: "system",
            content: `DATI DAI CONFIGURATORI UFFICIALI:\n\n${searchResults}\n\nRispondi usando SOLO questi dati ufficiali in formato schematico.`
          });
        }

        const response = await fetch(BACKEND_CHAT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages }),
        });

        if (!response.ok) throw new Error(`Errore ${response.status}`);

        const data = await response.json();
        
        hideTyping();

        let aiMessage = data.choices?.[0]?.message?.content || "Scusa, non ho capito.";
        
        // linkify gestisce l'escape HTML - non fare doppio escape qui
        addMessage(aiMessage, "ai");

        chatHistory.push({ role: "assistant", content: aiMessage });

      } catch (error) {
        hideTyping();
        console.error("Errore chat:", error);
        addMessage("√¢¬ù≈í Errore di connessione. Riprova tra poco.", "ai");
      } finally {
        chatSendBtn.disabled = false;
        chatInputField.focus();
      }
    }

    // Send on button click
    chatSendBtn.addEventListener("click", sendMessage);

    // Send on Enter
    chatInputField.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // ===== COMPARATORE AUTO =====
    const BACKEND_CHAT_URL = "https://auto-backend-three.vercel.app/api/chat";
    const BACKEND_SEARCH_URL = "https://auto-backend-three.vercel.app/api/search";

    // Marche auto nuove supportate
    const NEW_CAR_BRANDS = ['fiat','jeep','alfa romeo','alfa','lancia'];
    const OFFICIAL_DOMAINS = ['fiat.it','jeep-official.it','alfaromeo.it','lancia.it'];

    // Modelli noti per riconoscimento automatico marca
    const MODEL_BRAND_MAP = {
      // Fiat
      'grande panda':'fiat','panda':'fiat','500':'fiat','500x':'fiat','500l':'fiat',
      'tipo':'fiat','bravo':'fiat','punto':'fiat','ducato':'fiat','doblo':'fiat',
      'freemont':'fiat','500e':'fiat','600':'fiat',
      // Jeep
      'renegade':'jeep','compass':'jeep','avenger':'jeep','wrangler':'jeep',
      'cherokee':'jeep','grand cherokee':'jeep','gladiator':'jeep','commander':'jeep',
      // Alfa Romeo
      'giulia':'alfa romeo','stelvio':'alfa romeo','tonale':'alfa romeo',
      'giulietta':'alfa romeo','mito':'alfa romeo','junior':'alfa romeo',
      'brera':'alfa romeo','spider':'alfa romeo','147':'alfa romeo','156':'alfa romeo',
      // Lancia
      'ypsilon':'lancia','delta':'lancia','lybra':'lancia','musa':'lancia',
      'voyager':'lancia','thema':'lancia',
    };

    function detectBrand(input) {
      const lower = input.toLowerCase().trim();
      // Check direct brand mention
      for (const b of NEW_CAR_BRANDS) {
        if (lower.includes(b)) return b === 'alfa' ? 'alfa romeo' : b;
      }
      // Check model map
      for (const [model, brand] of Object.entries(MODEL_BRAND_MAP)) {
        if (lower.includes(model)) return brand;
      }
      return null;
    }

    function brandDomain(brand) {
      const map = {
        'fiat': 'fiat.it',
        'jeep': 'jeep-official.it',
        'alfa romeo': 'alfaromeo.it',
        'lancia': 'lancia.it'
      };
      return map[brand] || null;
    }

    function setSuggest(a, b) {
      document.getElementById('cmpInput1').value = a;
      document.getElementById('cmpInput2').value = b;
      document.getElementById('cmpInput1').style.borderColor = '#3b82f6';
      document.getElementById('cmpInput2').style.borderColor = '#3b82f6';
    }

    document.getElementById('cmpResetBtn').addEventListener('click', () => {
      document.getElementById('cmpInput1').value = '';
      document.getElementById('cmpInput2').value = '';
      document.getElementById('cmpResults').innerHTML = `
        <div style="text-align:center;color:#9ca3af;padding:30px 0;font-size:14px;">
          ‚Üë Inserisci due auto e premi Confronta
        </div>`;
    });

    ['cmpInput1','cmpInput2'].forEach(id => {
      document.getElementById(id).addEventListener('keypress', e => {
        if (e.key === 'Enter') startComparison();
      });
    });

    async function fetchCarData(query) {
      const brand = detectBrand(query);
      const domain = brand ? brandDomain(brand) : null;

      // Build targeted search query
      let searchQ;
      if (domain) {
        searchQ = `${query} allestimenti versioni scheda tecnica site:${domain}`;
      } else {
        // Generic search across all official sites
        searchQ = `${query} allestimenti versioni scheda tecnica (site:fiat.it OR site:jeep-official.it OR site:alfaromeo.it OR site:lancia.it)`;
      }

      try {
        const resp = await fetch(`${BACKEND_SEARCH_URL}?q=${encodeURIComponent(searchQ)}`);
        if (!resp.ok) return null;
        const data = await resp.json();
        if (!data.results || !data.results.length) return null;

        // Filter to official domains only
        const valid = data.results.filter(r =>
          OFFICIAL_DOMAINS.some(d => (r.url||'').toLowerCase().includes(d))
        );
        if (!valid.length) return null;

        // Return top 3 results as context
        return valid.slice(0,3).map(r =>
          `Titolo: ${r.title}
Descrizione: ${r.description || ''}
URL: ${r.url}`
        ).join('

---

');
      } catch(e) {
        return null;
      }
    }

    async function startComparison() {
      const car1 = document.getElementById('cmpInput1').value.trim();
      const car2 = document.getElementById('cmpInput2').value.trim();
      const results = document.getElementById('cmpResults');
      const btn = document.getElementById('cmpBtn');

      if (!car1 || !car2) {
        results.innerHTML = `<div style="text-align:center;color:#f87171;padding:20px;font-size:13px;">
          ‚ö† Inserisci entrambe le auto da confrontare!
        </div>`;
        return;
      }

      btn.disabled = true;
      results.innerHTML = `
        <div class="cmpLoading">
          <div class="cmpDot"></div><div class="cmpDot"></div><div class="cmpDot"></div>
          <span>Ricerca sui configuratori ufficiali...</span>
        </div>`;

      try {
        // Fetch data for both cars in parallel
        const [data1, data2] = await Promise.all([
          fetchCarData(car1),
          fetchCarData(car2)
        ]);

        // Update loading message
        results.innerHTML = `
          <div class="cmpLoading">
            <div class="cmpDot"></div><div class="cmpDot"></div><div class="cmpDot"></div>
            <span>Analisi in corso...</span>
          </div>`;

        // Build context for AI
        let context = '';
        if (data1) context += `=== DATI UFFICIALI: ${car1} ===
${data1}

`;
        if (data2) context += `=== DATI UFFICIALI: ${car2} ===
${data2}

`;

        const systemMsg = context
          ? `Sei un esperto di auto nuove. Usa SOLO i dati ufficiali forniti qui sotto per il confronto:

${context}
Rispondi SOLO con JSON valido, senza markdown, senza backtick.`
          : `Sei un esperto di auto nuove Fiat, Jeep, Alfa Romeo e Lancia. Rispondi SOLO con JSON valido, senza markdown, senza backtick.`;

        const userMsg = `Confronta ${car1} e ${car2}. Restituisci SOLO questo JSON:
{
  "auto1": {
    "nome": "nome completo con allestimento",
    "prezzo": "prezzo base indicativo",
    "motore": "motorizzazione principale",
    "consumi": "consumo medio",
    "bagagliaio": "volume bagagliaio",
    "dimensioni": "lunghezza",
    "punti_forza": ["forza 1","forza 2","forza 3"],
    "punti_deboli": ["debolezza 1","debolezza 2"]
  },
  "auto2": {
    "nome": "nome completo con allestimento",
    "prezzo": "prezzo base indicativo",
    "motore": "motorizzazione principale",
    "consumi": "consumo medio",
    "bagagliaio": "volume bagagliaio",
    "dimensioni": "lunghezza",
    "punti_forza": ["forza 1","forza 2","forza 3"],
    "punti_deboli": ["debolezza 1","debolezza 2"]
  },
  "verdetto": "testo verdetto 2-3 frasi",
  "migliore_prezzo": "auto1 o auto2",
  "migliore_efficienza": "auto1 o auto2"
}`;

        const response = await fetch(BACKEND_CHAT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            messages: [
              { role: 'system', content: systemMsg },
              { role: 'user',   content: userMsg }
            ]
          })
        });

        if (!response.ok) throw new Error('Errore API ' + response.status);
        const apiData = await response.json();
        let raw = apiData.choices?.[0]?.message?.content || '';
        raw = raw.replace(/```json\s*/gi,'').replace(/```\s*/gi,'').trim();

        let cmp;
        try {
          cmp = JSON.parse(raw);
        } catch(e) {
          throw new Error('Risposta non valida dal server');
        }

        renderComparison(cmp, car1, car2);

      } catch(err) {
        results.innerHTML = `<div style="text-align:center;color:#f87171;padding:24px;font-size:13px;">
          Errore: ${err.message || 'Impossibile completare il confronto'}.<br>
          <span style="color:#9ca3af">Riprova tra qualche secondo.</span>
        </div>`;
      } finally {
        btn.disabled = false;
      }
    }

    function renderComparison(cmp, q1, q2) {
      const a1 = cmp.auto1;
      const a2 = cmp.auto2;
      const results = document.getElementById('cmpResults');
      const betterPrice = cmp.migliore_prezzo;
      const betterEff   = cmp.migliore_efficienza;

      const fields = [
        { label: 'Prezzo',      k: 'prezzo',      winner: betterPrice },
        { label: 'Motore',      k: 'motore',      winner: null },
        { label: 'Consumi',     k: 'consumi',     winner: betterEff },
        { label: 'Bagagliaio',  k: 'bagagliaio',  winner: null },
        { label: 'Dimensioni',  k: 'dimensioni',  winner: null },
      ];

      function tableRows() {
        // Header row
        let html = `<div class="cmpRow" style="background:rgba(59,130,246,.08);font-weight:700;font-size:12px;text-transform:uppercase;letter-spacing:.5px;">
          <span class="cmpLabel" style="color:#9ca3af;">Caratteristica</span>
          <div style="display:flex;gap:0;flex:1;justify-content:flex-end;">
            <span style="flex:1;text-align:center;color:#f87171;">üî¥ ${a1.nome || q1}</span>
            <span style="flex:1;text-align:center;color:#60a5fa;">üîµ ${a2.nome || q2}</span>
          </div>
        </div>`;
        fields.forEach(f => {
          const w1 = f.winner === 'auto1';
          const w2 = f.winner === 'auto2';
          html += `<div class="cmpRow">
            <span class="cmpLabel">${f.label}</span>
            <div style="display:flex;flex:1;justify-content:flex-end;gap:4px;">
              <span class="cmpVal${w1?' cmpWin':''}" style="flex:1;text-align:center;">
                ${w1 ? '‚òÖ ' : ''}${a1[f.k] || '‚Äî'}
              </span>
              <span style="color:#374151;align-self:center;">|</span>
              <span class="cmpVal${w2?' cmpWin':''}" style="flex:1;text-align:center;">
                ${w2 ? '‚òÖ ' : ''}${a2[f.k] || '‚Äî'}
              </span>
            </div>
          </div>`;
        });
        return html;
      }

      function procon(items, color) {
        if (!items || !items.length) return '<li style="color:#9ca3af">‚Äî</li>';
        return items.map(i => `<li style="color:${color};margin-bottom:5px;font-size:12px;">‚Ä¢ ${i}</li>`).join('');
      }

      results.innerHTML = `
        <!-- Tabella comparativa -->
        <div class="cmpCard" style="width:100%;margin-bottom:14px;">
          ${tableRows()}
        </div>

        <!-- Pro/Contro affiancati -->
        <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;">
          <div style="flex:1;min-width:180px;background:rgba(31,41,55,.35);border-radius:12px;padding:12px 14px;border:1px solid rgba(248,113,113,.15)">
            <div style="font-weight:800;font-size:11px;color:#f87171;margin-bottom:6px;letter-spacing:.5px;">
              üî¥ ${a1.nome || q1}
            </div>
            <div style="font-size:11px;color:#4ade80;font-weight:700;margin-bottom:4px;">PUNTI FORZA</div>
            <ul style="list-style:none;padding:0;margin:0 0 8px;">${procon(a1.punti_forza,'#d1fae5')}</ul>
            <div style="font-size:11px;color:#f87171;font-weight:700;margin-bottom:4px;">PUNTI DEBOLI</div>
            <ul style="list-style:none;padding:0;margin:0;">${procon(a1.punti_deboli,'#fecaca')}</ul>
          </div>
          <div style="flex:1;min-width:180px;background:rgba(31,41,55,.35);border-radius:12px;padding:12px 14px;border:1px solid rgba(96,165,250,.15)">
            <div style="font-weight:800;font-size:11px;color:#60a5fa;margin-bottom:6px;letter-spacing:.5px;">
              üîµ ${a2.nome || q2}
            </div>
            <div style="font-size:11px;color:#4ade80;font-weight:700;margin-bottom:4px;">PUNTI FORZA</div>
            <ul style="list-style:none;padding:0;margin:0 0 8px;">${procon(a2.punti_forza,'#d1fae5')}</ul>
            <div style="font-size:11px;color:#f87171;font-weight:700;margin-bottom:4px;">PUNTI DEBOLI</div>
            <ul style="list-style:none;padding:0;margin:0;">${procon(a2.punti_deboli,'#fecaca')}</ul>
          </div>
        </div>

        <!-- Verdetto -->
        <div class="cmpVerdict">
          <strong style="color:#60a5fa;">‚ñ∂ Verdetto:</strong> ${cmp.verdetto || 'Nessun verdetto disponibile.'}
        </div>
      `;
    }

  </script>
</body>
</html>
