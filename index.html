<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI BOTT Automotive</title>
  <style>
    :root{
      --bgTop:#07080b;--bgMid:#101216;--bgBot:#1a1d23;
      --panel:rgba(17,24,39,.78);--line:#1f2937;
      --text:#e5e7eb;--muted:#9ca3af;
      --accent:#3b82f6;--accent2:#60a5fa;
      --orange:#f97316;--orange2:#fb923c;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);min-height:100vh;
      background:
        radial-gradient(1200px 700px at 18% -12%,rgba(59,130,246,.22),transparent 58%),
        radial-gradient(900px 520px at 72% 8%,rgba(96,165,250,.14),transparent 60%),
        linear-gradient(180deg,var(--bgTop) 0%,var(--bgMid) 48%,var(--bgBot) 100%);
    }
    header{
      position:fixed;top:0;left:0;right:0;z-index:10;
      background:rgba(10,10,12,.72);backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
      transition:transform .3s cubic-bezier(.4,0,.2,1);
    }
    header.header-hidden{transform:translateY(-110%)}
    body{padding-top:56px}
    .wrap{max-width:1200px;margin:0 auto;padding:8px 16px}
    .brand{display:flex;gap:10px;align-items:center;flex-wrap:wrap;min-width:unset}
    .brandLogo{width:36px;height:36px;object-fit:contain;background:transparent;border:none;outline:none;filter:none;mix-blend-mode:screen}
    .brandName{font-weight:950;letter-spacing:.2px;font-size:16px;line-height:1;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;white-space:nowrap}
    .brandSub{opacity:.75;white-space:nowrap;font-size:12px}
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brandMark{display:flex;align-items:center;gap:8px;user-select:none}
    .btn{border:1px solid var(--line);background:rgba(17,24,39,.75);color:var(--text);padding:7px 12px;border-radius:10px;cursor:pointer;font-size:13px;transition:all .2s;font-weight:650}
    .btn:hover{border-color:rgba(59,130,246,.6);background:rgba(17,24,39,.92);transform:translateY(-1px)}
    .btn.primary{border-color:rgba(59,130,246,.55);background:rgba(37,99,235,.16)}
    .btn.primary:hover{background:rgba(37,99,235,.26)}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .btn.brand-fiat:hover{border-color:rgba(220,38,38,.6);background:rgba(220,38,38,.1)}
    .btn.brand-jeep:hover{border-color:rgba(34,197,94,.6);background:rgba(34,197,94,.1)}
    .btn.brand-alfa:hover{border-color:rgba(239,68,68,.6);background:rgba(239,68,68,.1)}
    .btn.brand-lancia:hover{border-color:rgba(59,130,246,.6);background:rgba(59,130,246,.1)}
    .centroAutoLink{display:inline-flex;align-items:center;padding:4px 10px;border:2px solid rgba(34,197,94,.4);background:rgba(34,197,94,.08);border-radius:10px;transition:all .3s;text-decoration:none;box-shadow:0 2px 8px rgba(34,197,94,.15)}
    .centroAutoLink:hover{border-color:rgba(34,197,94,.7);background:rgba(34,197,94,.18);transform:translateY(-2px);box-shadow:0 4px 16px rgba(34,197,94,.3)}
    .centroAutoLogo{height:32px;width:auto;object-fit:contain;filter:drop-shadow(0 1px 3px rgba(0,0,0,.2))}
    .pill{padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(17,24,39,.35);font-size:12px;white-space:nowrap}
    .muted{color:var(--muted)}

    /* LAYOUT */
    .layout{margin-top:16px;display:grid;grid-template-columns:420px 1fr;gap:16px;align-items:start}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;overflow:hidden}
    .panelHeader{padding:14px 14px 10px;border-bottom:1px solid rgba(31,41,55,.75);background:rgba(10,12,18,.35);display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .panelTitle{font-weight:950;font-size:18px}
    .panelSub{margin-top:6px}
    .newsScroll{max-height:calc(100vh - 240px);overflow:auto;padding:12px}
    .newsScroll::-webkit-scrollbar{width:10px}
    .newsScroll::-webkit-scrollbar-thumb{background:rgba(59,130,246,.25);border:2px solid rgba(17,24,39,.7);border-radius:999px}
    .newsScroll::-webkit-scrollbar-track{background:rgba(0,0,0,.12)}
    #status{margin:10px 0 0}
    #newsList{display:grid;gap:12px}
    .newsItem{display:block;padding:14px;border:1px solid var(--line);border-radius:14px;text-decoration:none;color:inherit;background:rgba(17,24,39,.35);transition:all .2s}
    .newsItem:hover{border-color:rgba(59,130,246,.6);background:rgba(17,24,39,.55);transform:translateX(4px)}
    .newsTitle{font-weight:850;margin-bottom:8px}
    .newsMeta{opacity:.75;font-size:12px;margin-top:6px}
    .newsDate{opacity:.75;font-size:12px;margin-top:6px;font-style:italic}

    /* CALENDARIO SETTIMANALE */
    .weekPanel{border-top:1px solid rgba(31,41,55,.75);padding:12px;background:rgba(10,12,18,.18)}
    .weekHead{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .weekTitle{font-weight:950;font-size:16px}
    .weekSub{color:#9ca3af;font-size:12px}
    .weekGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .weekCell{aspect-ratio:1/1;border:1px solid rgba(31,41,55,.75);background:rgba(17,24,39,.35);border-radius:14px;padding:10px;overflow:hidden;display:flex;flex-direction:column;gap:6px}
    .weekCell.today{border-color:rgba(249,115,22,.55);box-shadow:0 0 0 3px rgba(249,115,22,.10) inset}
    .weekTop{display:flex;align-items:baseline;justify-content:space-between;gap:8px}
    .weekDow{font-size:11px;color:#9ca3af;font-weight:800;text-transform:uppercase}
    .weekDay{font-size:16px;font-weight:950}
    .weekTasks{margin-top:2px;display:grid;gap:4px;overflow:hidden}
    .weekTask{font-size:11px;line-height:1.2;color:#e5e7eb;opacity:.95;padding:5px 7px;border-radius:10px;border:1px solid rgba(31,41,55,.65);background:rgba(31,41,55,.30);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .weekTask.done{opacity:.55;text-decoration:line-through}
    .weekMore{font-size:11px;color:#fdba74;opacity:.9;font-weight:800}

    /* COMPARATORE */
    .cmpSuggest{background:rgba(59,130,246,.12);border:1px solid rgba(59,130,246,.3);border-radius:999px;padding:4px 10px;color:#93c5fd;font-size:11px;cursor:pointer;transition:all .2s;font-family:inherit}
    .cmpSuggest:hover{background:rgba(59,130,246,.25);border-color:rgba(59,130,246,.6)}

    /* AGENDA + MEMO */
    .widgetStack{display:grid;gap:16px;margin-top:16px}
    .widgetPanel{background:rgba(17,24,39,.78);border:1px solid #1f2937;border-radius:16px;overflow:hidden}
    .widgetHeader{padding:16px 20px;border-bottom:1px solid rgba(31,41,55,.75);background:rgba(10,12,18,.35);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .widgetTitle{font-weight:950;font-size:18px}
    .widgetSub{color:#9ca3af;font-size:13px;margin-top:4px}
    .widgetBody{padding:16px 20px}
    .formRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .field{flex:1;min-width:220px;background:rgba(31,41,55,.6);border:1px solid #1f2937;border-radius:10px;padding:10px 14px;color:#e5e7eb;font-size:13px;outline:none;font-family:inherit;transition:border-color .2s,background .2s}
    .field:focus{border-color:var(--orange);background:rgba(31,41,55,.8)}
    .seg{display:inline-flex;border:1px solid rgba(31,41,55,.9);background:rgba(17,24,39,.35);border-radius:999px;overflow:hidden}
    .seg button{border:none;background:transparent;color:#9ca3af;padding:8px 10px;font-size:12px;cursor:pointer;transition:all .2s;font-family:inherit;font-weight:700;white-space:nowrap}
    .seg button.active{color:#fff;background:linear-gradient(135deg,rgba(249,115,22,.28),rgba(251,146,60,.22))}
    .seg button:hover{background:rgba(249,115,22,.14);color:#ffe6d5}
    .split3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:14px;align-items:start}
    .dayCol{background:rgba(31,41,55,.35);border:1px solid rgba(31,41,55,.75);border-radius:14px;overflow:hidden}
    .dayHead{padding:12px 14px;font-weight:900;font-size:13px;border-bottom:1px solid rgba(31,41,55,.65);display:flex;align-items:center;justify-content:space-between;gap:10px;background:rgba(59,130,246,.10)}
    .dayMeta{color:#9ca3af;font-weight:700;font-size:12px}
    .list{padding:10px 12px;display:grid;gap:8px;max-height:260px;overflow:auto}
    .item{display:flex;align-items:flex-start;gap:10px;padding:10px;border:1px solid rgba(31,41,55,.7);border-radius:12px;background:rgba(17,24,39,.35)}
    .itemMain{flex:1;min-width:0}
    .itemText{font-size:13px;line-height:1.35;word-break:break-word}
    .itemText.done{text-decoration:line-through;opacity:.65}
    .itemActions{display:flex;gap:6px;align-items:center}
    .iconBtn{width:32px;height:32px;border-radius:10px;border:1px solid rgba(31,41,55,.9);background:rgba(17,24,39,.45);color:#e5e7eb;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:900}
    .iconBtn:hover{border-color:rgba(249,115,22,.55);background:rgba(17,24,39,.7);transform:translateY(-1px)}
    .chk{width:18px;height:18px;flex:0 0 auto;accent-color:var(--orange);margin-top:2px;cursor:pointer}
    .smallNote{margin-top:10px;color:#9ca3af;font-size:12px}
    .memoArea{width:100%;min-height:110px;resize:vertical}
    .syncBadge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(31,41,55,.9);background:rgba(17,24,39,.35);color:#9ca3af;white-space:nowrap}
    .syncBadge.ok{border-color:rgba(34,197,94,.5);background:rgba(34,197,94,.10);color:#bbf7d0}
    .syncBadge.warn{border-color:rgba(251,191,36,.5);background:rgba(251,191,36,.10);color:#fde68a}
    #agendaPanel .widgetHeader,#memoPanel .widgetHeader{background:linear-gradient(180deg,rgba(249,115,22,.09),rgba(10,12,18,.35) 70%)}

    /* VENDITE */
    .venditePanel{background:var(--panel);border:1px solid var(--line);border-radius:16px;overflow:hidden;margin-top:16px}
    .venditeHeader{padding:14px 18px;border-bottom:1px solid rgba(31,41,55,.75);background:rgba(10,12,18,.35);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .venditeTitleRow{display:flex;align-items:center;gap:10px}
    .venditeTitle{font-weight:950;font-size:18px}
    .venditeSyncBadge{font-size:11px;padding:4px 10px;border-radius:999px;border:1px solid rgba(31,41,55,.9);background:rgba(17,24,39,.35);color:var(--muted);white-space:nowrap}
    .venditeSyncBadge.ok{border-color:rgba(34,197,94,.5);background:rgba(34,197,94,.10);color:#bbf7d0}
    .venditeNav{display:flex;align-items:center;gap:8px}
    .navArrow{width:32px;height:32px;border-radius:9px;border:1px solid var(--line);background:rgba(17,24,39,.6);color:var(--text);cursor:pointer;font-size:18px;font-weight:700;display:flex;align-items:center;justify-content:center;transition:all .2s}
    .navArrow:hover{border-color:rgba(59,130,246,.5);background:rgba(17,24,39,.9);transform:translateY(-1px)}
    .navArrow:disabled{opacity:.35;cursor:not-allowed;transform:none}
    .venditeMonthLabel{font-weight:900;font-size:15px;min-width:140px;text-align:center;padding:0 4px}
    .venditeTotali{display:grid;grid-template-columns:repeat(3,1fr);border-bottom:1px solid rgba(31,41,55,.75)}
    .totCard{padding:14px 18px;display:flex;flex-direction:column;gap:4px}
    .totCard:not(:last-child){border-right:1px solid rgba(31,41,55,.75)}
    .totLabel{font-size:11px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--muted)}
    .totNum{font-size:36px;font-weight:950;line-height:1}
    .totNum.nuova{color:#60a5fa}.totNum.usata{color:#f97316}.totNum.all{color:#22c55e}
    .venditeForm{padding:12px 18px;border-bottom:1px solid rgba(31,41,55,.5);display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .venditeForm .fld{flex:1;min-width:150px;background:rgba(31,41,55,.6);border:1px solid var(--line);border-radius:10px;padding:9px 13px;color:var(--text);font-size:13px;outline:none;font-family:inherit;transition:border-color .2s}
    .venditeForm .fld:focus{border-color:var(--accent)}
    .venditeForm .fld::placeholder{color:var(--muted)}
    .tipoSeg{display:inline-flex;border:1px solid rgba(31,41,55,.9);background:rgba(17,24,39,.35);border-radius:999px;overflow:hidden;flex-shrink:0}
    .tipoBtn{border:none;background:transparent;color:var(--muted);padding:9px 14px;font-size:13px;cursor:pointer;font-family:inherit;font-weight:700;transition:all .2s;white-space:nowrap}
    .tipoBtn.nuova.active{background:linear-gradient(135deg,rgba(59,130,246,.28),rgba(96,165,250,.2));color:#93c5fd}
    .tipoBtn.usata.active{background:linear-gradient(135deg,rgba(249,115,22,.28),rgba(251,146,60,.2));color:#fdba74}
    .tipoBtn:hover{opacity:.85}
    .venditeListe{display:grid;grid-template-columns:1fr 1fr;min-height:180px}
    .venditeCol{padding:14px 16px}
    .venditeCol:first-child{border-right:1px solid rgba(31,41,55,.75)}
    .venditeColTitle{font-size:12px;font-weight:900;letter-spacing:.3px;margin-bottom:10px;display:flex;align-items:center;gap:6px}
    .venditeColTitle.nuova{color:#60a5fa}.venditeColTitle.usata{color:#f97316}
    .venditeCount{font-size:11px;padding:2px 8px;border-radius:999px;font-weight:700}
    .venditeCount.nuova{background:rgba(59,130,246,.15);border:1px solid rgba(59,130,246,.3);color:#93c5fd}
    .venditeCount.usata{background:rgba(249,115,22,.12);border:1px solid rgba(249,115,22,.3);color:#fdba74}
    .venditeList{display:grid;gap:6px;max-height:320px;overflow-y:auto}
    .venditeList::-webkit-scrollbar{width:6px}
    .venditeList::-webkit-scrollbar-thumb{background:rgba(59,130,246,.2);border-radius:999px}
    .autoItem{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid rgba(31,41,55,.7);border-radius:10px;background:rgba(17,24,39,.35);animation:itemIn .2s ease}
    @keyframes itemIn{from{opacity:0;transform:translateX(-6px)}to{opacity:1;transform:none}}
    .autoN{font-size:11px;font-weight:900;min-width:20px;color:var(--muted)}
    .autoModello{flex:1;font-size:13px;line-height:1.3;word-break:break-word}
    .autoProvv{font-size:12px;font-weight:700;color:#4ade80;background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.25);border-radius:6px;padding:2px 7px;white-space:nowrap;flex-shrink:0}
    .autoProvv.zero{color:var(--muted);background:transparent;border-color:rgba(31,41,55,.5);font-weight:400}
    .autoDelBtn{width:24px;height:24px;border-radius:7px;border:1px solid rgba(31,41,55,.9);background:rgba(17,24,39,.4);color:var(--muted);cursor:pointer;font-size:14px;font-weight:900;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}
    .autoDelBtn:hover{border-color:rgba(239,68,68,.4);background:rgba(239,68,68,.1);color:#fca5a5}
    .emptyList{font-size:12px;color:var(--muted);font-style:italic;padding:8px 2px}
    .venditeProvvBar{border-top:1px solid rgba(31,41,55,.75);padding:12px 18px;display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;background:rgba(34,197,94,.04)}
    .provvMeseGroup{display:flex;flex-direction:column;gap:2px}
    .provvMeseLabel{font-size:11px;font-weight:700;color:var(--muted);letter-spacing:.4px;text-transform:uppercase}
    .provvMeseNum{font-size:24px;font-weight:950;color:#4ade80;font-variant-numeric:tabular-nums}
    .provvMeseSplit{font-size:11px;color:var(--muted);margin-top:2px}
    .vendite2026Bar{border-top:2px solid rgba(251,191,36,.3);padding:14px 18px;background:linear-gradient(90deg,rgba(251,191,36,.07),transparent);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .bar2026Left{display:flex;align-items:center;gap:10px}
    .bar2026Icon{font-size:22px}
    .bar2026Title{font-weight:900;font-size:14px}
    .bar2026Sub{font-size:11px;color:var(--muted);margin-top:2px}
    .bar2026Right{text-align:right}
    .bar2026Num{font-size:30px;font-weight:950;color:#fbbf24;font-variant-numeric:tabular-nums}
    .bar2026Mesi{font-size:11px;color:var(--muted);margin-top:2px}
    .obiettivoBar{border-top:1px solid rgba(31,41,55,.75);padding:16px 18px;background:rgba(10,12,18,.25)}
    .obiettivoHead{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;flex-wrap:wrap}
    .obiettivoLeft{display:flex;align-items:center;gap:8px}
    .obiettivoIcon{font-size:18px}
    .obiettivoTitle{font-weight:900;font-size:14px}
    .obiettivoSub{font-size:11px;color:var(--muted);margin-top:2px}
    .obiettivoRight{display:flex;align-items:center;gap:8px}
    .obiettivoInput{width:110px;background:rgba(31,41,55,.6);border:1px solid var(--line);border-radius:9px;padding:7px 11px;color:var(--text);font-size:13px;font-weight:700;outline:none;font-family:inherit;transition:border-color .2s;text-align:right}
    .obiettivoInput:focus{border-color:var(--accent)}
    .obiettivoInputLabel{font-size:12px;color:var(--muted);white-space:nowrap}
    .progressWrap{background:rgba(31,41,55,.5);border-radius:999px;height:14px;overflow:hidden}
    .progressFill{height:100%;border-radius:999px;transition:width .5s cubic-bezier(.4,0,.2,1),background .4s;min-width:0}
    .progressFill.low{background:linear-gradient(90deg,#f97316,#fb923c)}
    .progressFill.mid{background:linear-gradient(90deg,#eab308,#fbbf24)}
    .progressFill.high{background:linear-gradient(90deg,#22c55e,#4ade80)}
    .progressFill.done{background:linear-gradient(90deg,#a855f7,#c084fc)}
    .progressMeta{display:flex;align-items:center;justify-content:space-between;margin-top:7px;font-size:12px}
    .progressPct{font-weight:900;font-size:15px}
    .progressPct.low{color:#fb923c}.progressPct.mid{color:#fbbf24}.progressPct.high{color:#4ade80}.progressPct.done{color:#c084fc}
    .progressManca{color:var(--muted)}
    .progressManca.done{color:#c084fc;font-weight:700}

    /* COLPI DI TELEFONO */
    #telefonoPanel .widgetHeader{background:linear-gradient(180deg,rgba(168,85,247,.09),rgba(10,12,18,.35) 70%)}
    .telFormRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:14px}
    .telInput{flex:1;min-width:120px;background:rgba(31,41,55,.6);border:1px solid var(--line);border-radius:10px;padding:8px 12px;color:var(--text);font-size:13px;outline:none;font-family:inherit;transition:border-color .2s}
    .telInput:focus{border-color:#a855f7}
    .telInput::placeholder{color:var(--muted)}
    .telSeg{display:inline-flex;border:1px solid rgba(31,41,55,.9);background:rgba(17,24,39,.35);border-radius:999px;overflow:hidden;flex-shrink:0}
    .telBtn{border:none;background:transparent;color:var(--muted);padding:8px 12px;font-size:12px;cursor:pointer;font-family:inherit;font-weight:700;transition:all .2s;white-space:nowrap}
    .telBtn.caldo.active{background:rgba(239,68,68,.25);color:#fca5a5}
    .telBtn.tiepido.active{background:rgba(251,191,36,.2);color:#fde68a}
    .telBtn.freddo.active{background:rgba(59,130,246,.2);color:#93c5fd}
    .telBtn:hover{opacity:.8}
    .telWhenSeg{display:inline-flex;border:1px solid rgba(31,41,55,.9);background:rgba(17,24,39,.35);border-radius:999px;overflow:hidden;flex-shrink:0}
    .telWhenBtn{border:none;background:transparent;color:var(--muted);padding:8px 10px;font-size:12px;cursor:pointer;font-family:inherit;font-weight:700;transition:all .2s;white-space:nowrap}
    .telWhenBtn.active{background:rgba(168,85,247,.22);color:#d8b4fe}
    .telList{display:grid;gap:8px;max-height:360px;overflow-y:auto}
    .telList::-webkit-scrollbar{width:6px}
    .telList::-webkit-scrollbar-thumb{background:rgba(168,85,247,.25);border-radius:999px}
    .telCard{display:flex;align-items:center;gap:10px;padding:10px 14px;border:1px solid rgba(31,41,55,.7);border-radius:12px;background:rgba(17,24,39,.35);animation:itemIn .2s ease;transition:border-color .2s}
    .telCard.caldo{border-left:3px solid rgba(239,68,68,.7)}
    .telCard.tiepido{border-left:3px solid rgba(251,191,36,.7)}
    .telCard.freddo{border-left:3px solid rgba(59,130,246,.7)}
    .telCard.chiamato{opacity:.5}
    .telCardMain{flex:1;min-width:0}
    .telCardName{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .telCardName.chiamato{text-decoration:line-through}
    .telCardMeta{display:flex;gap:8px;align-items:center;margin-top:3px;flex-wrap:wrap}
    .telCardModello{font-size:12px;color:var(--muted)}
    .telStatoBadge{font-size:11px;font-weight:700;padding:2px 8px;border-radius:999px}
    .telStatoBadge.caldo{background:rgba(239,68,68,.18);border:1px solid rgba(239,68,68,.35);color:#fca5a5}
    .telStatoBadge.tiepido{background:rgba(251,191,36,.15);border:1px solid rgba(251,191,36,.35);color:#fde68a}
    .telStatoBadge.freddo{background:rgba(59,130,246,.15);border:1px solid rgba(59,130,246,.35);color:#93c5fd}
    .telCardActions{display:flex;gap:6px;flex-shrink:0}
    .telSection{margin-top:14px}
    .telSectionLabel{font-size:11px;font-weight:900;letter-spacing:.5px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;padding:0 2px;display:flex;align-items:center;gap:6px}
    .telEmpty{font-size:12px;color:var(--muted);font-style:italic;padding:6px 2px}

    /* CHATBOT */
    .chatTrigger{position:fixed;bottom:24px;right:24px;width:70px;height:70px;border-radius:50%;background:transparent;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(0,0,0,.3);transition:all .3s;z-index:1000}
    .chatTrigger:hover{transform:scale(1.1);box-shadow:0 12px 32px rgba(0,0,0,.5)}
    .chatTrigger img{width:70px;height:70px;object-fit:contain}
    .chatBox{position:fixed;bottom:24px;right:24px;width:420px;max-width:calc(100vw - 32px);height:600px;max-height:calc(100vh - 48px);background:rgba(17,24,39,.95);border:1px solid var(--line);border-radius:20px;display:none;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,.6);z-index:1001;overflow:hidden;backdrop-filter:blur(20px)}
    .chatBox.open{display:flex}
    .chatBox.minimized{width:70px;height:70px;background:transparent;border:none;border-radius:50%;box-shadow:0 8px 24px rgba(0,0,0,.3)}
    .chatBox.minimized .chatHeader,.chatBox.minimized .chatMessages,.chatBox.minimized .chatInput{display:none}
    .chatHeader{background:linear-gradient(135deg,var(--accent),var(--accent2));padding:14px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,.15)}
    .chatHeaderLeft{display:flex;align-items:center;gap:10px}
    .chatHeaderLogo{width:38px;height:38px;border-radius:50%;background:rgba(255,255,255,.15);padding:4px}
    .chatHeaderTitle{font-weight:700;font-size:16px;color:#fff}
    .chatHeaderSub{font-size:11px;color:rgba(255,255,255,.75);margin-top:2px}
    .chatHeaderBtns{display:flex;gap:8px}
    .chatHeaderBtn{width:32px;height:32px;border-radius:8px;background:rgba(255,255,255,.15);border:none;color:#fff;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;transition:all .2s;font-weight:700}
    .chatHeaderBtn:hover{background:rgba(255,255,255,.25);transform:scale(1.05)}
    .chatMessages{flex:1;overflow-y:auto;padding:16px;background:linear-gradient(180deg,rgba(26,29,35,.95),rgba(16,18,22,.95));display:flex;flex-direction:column;gap:12px}
    .chatMessages::-webkit-scrollbar{width:8px}
    .chatMessages::-webkit-scrollbar-thumb{background:rgba(59,130,246,.3);border-radius:999px}
    .message{display:flex;gap:8px;animation:slideIn .3s ease}
    @keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .message.user{flex-direction:row-reverse}
    .messageBubble{max-width:85%;padding:12px 16px;border-radius:18px;font-size:14px;line-height:1.6;word-wrap:break-word;white-space:pre-line}
    .message.ai .messageBubble{background:linear-gradient(135deg,rgba(59,130,246,.85),rgba(96,165,250,.85));color:#fff;border-bottom-left-radius:4px}
    .message.user .messageBubble{background:rgba(255,255,255,.92);color:#1a1d23;border-bottom-right-radius:4px}
    .typingIndicator{display:flex;gap:8px;padding:12px 16px;background:linear-gradient(135deg,rgba(59,130,246,.85),rgba(96,165,250,.85));border-radius:18px;border-bottom-left-radius:4px;max-width:75%}
    .typingDot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.9);animation:bounce 1.4s infinite ease-in-out}
    .typingDot:nth-child(1){animation-delay:0s}.typingDot:nth-child(2){animation-delay:.2s}.typingDot:nth-child(3){animation-delay:.4s}
    @keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}
    .chatInput{padding:16px;background:rgba(10,12,18,.95);border-top:1px solid var(--line);display:flex;gap:10px}
    .chatInputField{flex:1;background:rgba(31,41,55,.6);border:1px solid var(--line);border-radius:12px;padding:12px 16px;color:var(--text);font-size:14px;outline:none;transition:all .2s;font-family:inherit}
    .chatInputField:focus{border-color:var(--accent);background:rgba(31,41,55,.8)}
    .chatInputField::placeholder{color:var(--muted)}
    .chatSendBtn{width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;color:#fff;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;transition:all .2s}
    .chatSendBtn:hover:not(:disabled){transform:scale(1.05);box-shadow:0 4px 16px rgba(59,130,246,.4)}
    .chatSendBtn:disabled{opacity:.5;cursor:not-allowed}

    @media(max-width:980px){
      .layout{grid-template-columns:1fr}
      .newsScroll{max-height:60vh}
      .brand{min-width:unset}
      .split3{grid-template-columns:1fr}
      .venditeListe{grid-template-columns:1fr}
      .venditeCol:first-child{border-right:none;border-bottom:1px solid rgba(31,41,55,.75)}
      .chatBox{width:100%;max-width:100%;height:100vh;max-height:100vh;bottom:0;right:0;border-radius:0}
      .chatTrigger{bottom:16px;right:16px;width:60px;height:60px}
      .weekGrid{gap:4px}
      .weekCell{border-radius:10px;padding:6px}
    }
    @media(max-width:768px){
      .btn{padding:8px 10px;font-size:13px}
      .brandLogo{width:30px;height:30px}
      .brandName{font-size:16px}
      .centroAutoLogo{height:36px}
      .centroAutoLink{padding:4px 8px}
      .weekGrid{grid-template-columns:repeat(7,1fr)}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row">
        <div class="brand">
          <div class="brandMark">
            <img class="brandLogo" src="https://image2url.com/r2/default/images/1770729951588-711e8f2c-9f48-4ef1-9af3-be4b1f7b5d9f.png" alt="AI BOTT logo"/>
            <div><div class="brandName">AI BOTT</div><div class="brandSub">Automotive</div></div>
          </div>
          <button id="fiatBtn"   class="btn brand-fiat">Fiat</button>
          <button id="jeepBtn"   class="btn brand-jeep">Jeep</button>
          <button id="alfaBtn"   class="btn brand-alfa">Alfa Romeo</button>
          <button id="lanciaBtn" class="btn brand-lancia">Lancia</button>
          <a href="https://www.centroautovt.it/" target="_blank" rel="noopener noreferrer" class="centroAutoLink">
            <img src="https://image2url.com/r2/default/images/1770805237740-1db65b1e-5553-4b5b-b28a-750e3520a0a2.png" alt="CentroAuto VT" class="centroAutoLogo"/>
          </a>
        </div>
        <div class="row" style="gap:10px">
          <span id="userPill" class="pill muted">Non autenticato</span>
          <button id="loginBtn"  class="btn primary">Login Google</button>
          <button id="logoutBtn" class="btn" style="display:none">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="layout">

      <!-- SINISTRA: NEWS + CALENDARIO -->
      <aside class="panel">
        <div class="panelHeader">
          <div>
            <div class="panelTitle">üì∞ Ultime News</div>
            <div class="muted panelSub">Visibili solo dopo login.</div>
            <div id="status" class="muted">Effettua il login per caricare le news.</div>
          </div>
          <button id="refreshBtn" class="btn" disabled>üîÑ</button>
        </div>
        <div class="newsScroll"><div id="newsList"></div></div>

        <!-- CALENDARIO SETTIMANALE -->
        <div class="weekPanel">
          <div class="weekHead">
            <div>
              <div class="weekTitle">üóì Calendario settimanale</div>
              <div class="weekSub">Task dell'agenda nella settimana corrente</div>
            </div>
            <div id="weekRange" class="pill muted">‚Äî</div>
          </div>
          <div id="weekGrid" class="weekGrid"></div>
        </div>
      </aside>

      <!-- DESTRA: COMPARATORE + VENDITE + AGENDA + MEMO + TELEFONO -->
      <section style="padding:0;border:none;background:none;">

        <!-- COMPARATORE -->
        <div style="background:rgba(17,24,39,.78);border:1px solid #1f2937;border-radius:16px;overflow:hidden;">
          <div style="padding:16px 20px;border-bottom:1px solid rgba(31,41,55,.75);background:rgba(10,12,18,.35);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
            <div>
              <div style="font-weight:950;font-size:18px">‚öî Comparatore Auto</div>
              <div style="color:#9ca3af;font-size:13px;margin-top:4px">Confronta due auto nuove ‚Äî cerca sui configuratori ufficiali</div>
            </div>
            <button id="cmpResetBtn" class="btn" style="font-size:12px;padding:7px 12px;">‚Ü© Reset</button>
          </div>
          <div style="padding:16px 20px;border-bottom:1px solid rgba(31,41,55,.5);display:flex;gap:10px;flex-wrap:wrap;">
            <input id="cmpInput1" type="text" placeholder="Es: Grande Panda, Compass, Stelvio..."
              style="flex:1;min-width:180px;background:rgba(31,41,55,.6);border:1px solid #1f2937;border-radius:10px;padding:10px 14px;color:#e5e7eb;font-size:13px;outline:none;font-family:inherit;transition:border-color .2s"
              onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#1f2937'"/>
            <div style="display:flex;align-items:center;color:#9ca3af;font-size:18px;font-weight:700;">VS</div>
            <input id="cmpInput2" type="text" placeholder="Es: Junior, Avenger, Ypsilon..."
              style="flex:1;min-width:180px;background:rgba(31,41,55,.6);border:1px solid #1f2937;border-radius:10px;padding:10px 14px;color:#e5e7eb;font-size:13px;outline:none;font-family:inherit;transition:border-color .2s"
              onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#1f2937'"/>
            <button id="cmpBtn" style="background:linear-gradient(135deg,#3b82f6,#60a5fa);border:none;border-radius:10px;padding:10px 20px;color:#fff;font-weight:700;font-size:14px;cursor:pointer;transition:all .2s;white-space:nowrap;font-family:inherit;">üîé Confronta</button>
          </div>
          <div style="padding:10px 20px;border-bottom:1px solid rgba(31,41,55,.4);display:flex;gap:8px;flex-wrap:wrap;">
            <span style="color:#9ca3af;font-size:12px;align-self:center;">Rapido:</span>
            <button class="cmpSuggest" data-s1="Grande Panda" data-s2="Junior">Grande Panda vs Junior</button>
            <button class="cmpSuggest" data-s1="Compass" data-s2="Tonale">Compass vs Tonale</button>
            <button class="cmpSuggest" data-s1="Stelvio" data-s2="Renegade">Stelvio vs Renegade</button>
            <button class="cmpSuggest" data-s1="Ypsilon" data-s2="Avenger">Ypsilon vs Avenger</button>
          </div>
          <div id="cmpResults" style="padding:20px;min-height:120px;">
            <div style="text-align:center;color:#9ca3af;padding:30px 0;font-size:14px;">‚Üë Scrivi il modello e premi Confronta</div>
          </div>
        </div>

        <!-- VENDITE MENSILI -->
        <div class="venditePanel">
          <div class="venditeHeader">
            <div class="venditeTitleRow">
              <div class="venditeTitle">üöó Vendite mensili</div>
              <span id="venditeSyncBadge" class="venditeSyncBadge">Sync ‚Äî</span>
            </div>
            <div class="venditeNav">
              <button class="navArrow" id="vendPrevBtn">&#8249;</button>
              <div class="venditeMonthLabel" id="vendMonthLabel">‚Äî</div>
              <button class="navArrow" id="vendNextBtn">&#8250;</button>
            </div>
          </div>
          <div class="venditeTotali">
            <div class="totCard"><div class="totLabel">üÜï Nuove</div><div class="totNum nuova" id="totNuove">0</div></div>
            <div class="totCard"><div class="totLabel">üîÑ Usate</div><div class="totNum usata" id="totUsate">0</div></div>
            <div class="totCard"><div class="totLabel">üì¶ Totale</div><div class="totNum all"  id="totAll">0</div></div>
          </div>
          <div class="venditeForm">
            <input id="vendModello" type="text" class="fld" placeholder="Modello auto (es: Jeep Compass‚Ä¶)" style="min-width:160px;"/>
            <input id="vendProvv"   type="number" class="fld" placeholder="Provvigione ‚Ç¨" min="0" step="1" style="max-width:140px;min-width:110px;"/>
            <div class="tipoSeg">
              <button class="tipoBtn nuova active" id="tipoBtnNuova">üÜï Nuova</button>
              <button class="tipoBtn usata"        id="tipoBtnUsata">üîÑ Usata</button>
            </div>
            <button id="vendAddBtn" class="btn primary" style="flex-shrink:0;font-weight:700;">+ Aggiungi</button>
          </div>
          <div class="venditeListe">
            <div class="venditeCol">
              <div class="venditeColTitle nuova">üÜï AUTO NUOVE <span class="venditeCount nuova" id="cntNuove">0</span></div>
              <div class="venditeList" id="listNuove"></div>
            </div>
            <div class="venditeCol">
              <div class="venditeColTitle usata">üîÑ AUTO USATE <span class="venditeCount usata" id="cntUsate">0</span></div>
              <div class="venditeList" id="listUsate"></div>
            </div>
          </div>
          <div class="venditeProvvBar">
            <div class="provvMeseGroup">
              <div class="provvMeseLabel">üí∞ Provvigioni del mese</div>
              <div class="provvMeseNum" id="provvMeseTot">‚Ç¨ 0</div>
              <div class="provvMeseSplit" id="provvMeseSplit"></div>
            </div>
          </div>
          <div class="vendite2026Bar">
            <div class="bar2026Left">
              <div class="bar2026Icon">üèÜ</div>
              <div>
                <div class="bar2026Title">Totale provvigioni 2026</div>
                <div class="bar2026Sub">Somma cumulativa di tutti i mesi</div>
              </div>
            </div>
            <div class="bar2026Right">
              <div class="bar2026Num" id="provv2026Tot">‚Ç¨ 0</div>
              <div class="bar2026Mesi" id="provv2026Mesi">0 mesi con provvigioni</div>
            </div>
          </div>
          <div class="obiettivoBar">
            <div class="obiettivoHead">
              <div class="obiettivoLeft">
                <div class="obiettivoIcon">üéØ</div>
                <div>
                  <div class="obiettivoTitle">Obiettivo mensile</div>
                  <div class="obiettivoSub">Imposta il tuo target provvigioni per questo mese</div>
                </div>
              </div>
              <div class="obiettivoRight">
                <span class="obiettivoInputLabel">Target ‚Ç¨</span>
                <input id="obiettivoInput" type="number" class="obiettivoInput" placeholder="es. 3000" min="0" step="100"/>
              </div>
            </div>
            <div class="progressWrap"><div class="progressFill low" id="progressFill" style="width:0%"></div></div>
            <div class="progressMeta">
              <span class="progressPct low" id="progressPct">0%</span>
              <span class="progressManca" id="progressManca">Imposta un obiettivo ‚Üë</span>
            </div>
          </div>
        </div>

        <!-- AGENDA + MEMO + TELEFONO -->
        <div class="widgetStack">
          <div class="widgetPanel" id="agendaPanel">
            <div class="widgetHeader">
              <div>
                <div class="widgetTitle">üìÖ Agenda 3 giorni</div>
                <div class="widgetSub">Task sincronizzati su Firebase.</div>
              </div>
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <span id="syncBadge" class="syncBadge warn">Sync: non attivo</span>
                <button id="agendaClearDoneBtn" class="btn" style="font-size:12px;padding:7px 12px;">Pulisci fatti</button>
              </div>
            </div>
            <div class="widgetBody">
              <div class="formRow">
                <input id="taskInput" class="field" type="text" placeholder="Scrivi un task..."/>
                <div class="seg">
                  <button id="dayBtn0" class="active" type="button">Oggi</button>
                  <button id="dayBtn1" type="button">Domani</button>
                  <button id="dayBtn2" type="button">+2</button>
                </div>
                <button id="addTaskBtn" class="btn primary" type="button">Aggiungi</button>
              </div>
              <div class="split3" style="margin-top:14px;">
                <div class="dayCol">
                  <div class="dayHead"><span id="dayLabel0">Oggi</span><span id="dayDate0" class="dayMeta"></span></div>
                  <div id="taskList0" class="list"></div>
                </div>
                <div class="dayCol">
                  <div class="dayHead" style="background:rgba(96,165,250,.08);"><span id="dayLabel1">Domani</span><span id="dayDate1" class="dayMeta"></span></div>
                  <div id="taskList1" class="list"></div>
                </div>
                <div class="dayCol">
                  <div class="dayHead" style="background:rgba(59,130,246,.06);"><span id="dayLabel2">+2 giorni</span><span id="dayDate2" class="dayMeta"></span></div>
                  <div id="taskList2" class="list"></div>
                </div>
              </div>
              <div class="smallNote">Se fai login su telefono, vedi gli stessi task e memo.</div>
            </div>
          </div>

          <div class="widgetPanel" id="memoPanel">
            <div class="widgetHeader">
              <div>
                <div class="widgetTitle">üìù Memo</div>
                <div class="widgetSub">Sincronizzate su Firebase.</div>
              </div>
              <button id="memoClearDoneBtn" class="btn" style="font-size:12px;padding:7px 12px;">Pulisci barrate</button>
            </div>
            <div class="widgetBody">
              <div class="formRow" style="align-items:stretch;">
                <textarea id="memoInput" class="field memoArea" placeholder="Scrivi una memo..."></textarea>
                <button id="addMemoBtn" class="btn primary" type="button" style="align-self:flex-start;">Aggiungi</button>
              </div>
              <div style="margin-top:14px;"><div id="memoList" class="list" style="max-height:320px;"></div></div>
              <div class="smallNote">Ctrl+Enter nella memo = aggiungi.</div>
            </div>
          </div>

          <!-- COLPI DI TELEFONO -->
          <div class="widgetPanel" id="telefonoPanel">
            <div class="widgetHeader">
              <div>
                <div class="widgetTitle">üìû Colpi di telefono</div>
                <div class="widgetSub">Chi spingere oggi, domani, prossima settimana.</div>
              </div>
              <button id="telClearDoneBtn" class="btn" style="font-size:12px;padding:6px 10px;">Pulisci chiamati</button>
            </div>
            <div class="widgetBody">
              <div class="telFormRow">
                <input id="telNome"    class="telInput" type="text" placeholder="Nome (es: Marco R.)"/>
                <input id="telModello" class="telInput" type="text" placeholder="Modello interesse" style="max-width:160px"/>
                <div class="telSeg">
                  <button class="telBtn caldo   active" id="telBtnCaldo"  >üî• Caldo</button>
                  <button class="telBtn tiepido"        id="telBtnTiepido">üå° Tiepido</button>
                  <button class="telBtn freddo"         id="telBtnFreddo" >‚ùÑ Freddo</button>
                </div>
              </div>
              <div class="telFormRow">
                <div class="telWhenSeg">
                  <button class="telWhenBtn active" id="telWhenOggi">üìÖ Oggi</button>
                  <button class="telWhenBtn"        id="telWhenDomani">Domani</button>
                  <button class="telWhenBtn"        id="telWhenSettimana">Settimana</button>
                </div>
                <button id="telAddBtn" class="btn primary" style="flex-shrink:0;font-weight:700;">+ Aggiungi</button>
              </div>
              <div class="telSection">
                <div class="telSectionLabel">üìÖ Da chiamare oggi <span id="telCntOggi" style="font-size:10px;background:rgba(168,85,247,.2);border:1px solid rgba(168,85,247,.3);color:#d8b4fe;padding:1px 7px;border-radius:999px;">0</span></div>
                <div id="telListOggi" class="telList"></div>
              </div>
              <div class="telSection">
                <div class="telSectionLabel">üåÖ Domani <span id="telCntDomani" style="font-size:10px;background:rgba(168,85,247,.2);border:1px solid rgba(168,85,247,.3);color:#d8b4fe;padding:1px 7px;border-radius:999px;">0</span></div>
                <div id="telListDomani" class="telList"></div>
              </div>
              <div class="telSection">
                <div class="telSectionLabel">üìÜ Prossima settimana <span id="telCntSettimana" style="font-size:10px;background:rgba(168,85,247,.2);border:1px solid rgba(168,85,247,.3);color:#d8b4fe;padding:1px 7px;border-radius:999px;">0</span></div>
                <div id="telListSettimana" class="telList"></div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- CHATBOT -->
  <div class="chatTrigger" id="chatTrigger">
    <img src="https://image2url.com/r2/default/images/1770729951588-711e8f2c-9f48-4ef1-9af3-be4b1f7b5d9f.png" alt="AI Agent"/>
  </div>
  <div class="chatBox" id="chatBox">
    <img id="chatMinimizedLogo" src="https://image2url.com/r2/default/images/1770729951588-711e8f2c-9f48-4ef1-9af3-be4b1f7b5d9f.png" alt="AI Agent" style="display:none;width:70px;height:70px;object-fit:contain;cursor:pointer;"/>
    <div class="chatHeader">
      <div class="chatHeaderLeft">
        <img class="chatHeaderLogo" src="https://image2url.com/r2/default/images/1770729951588-711e8f2c-9f48-4ef1-9af3-be4b1f7b5d9f.png" alt="AI"/>
        <div><div class="chatHeaderTitle">AI BOTT Assistant</div><div class="chatHeaderSub">Esperto configurazioni</div></div>
      </div>
      <div class="chatHeaderBtns">
        <button class="chatHeaderBtn" id="minimizeBtn">‚àí</button>
        <button class="chatHeaderBtn" id="closeBtn">√ó</button>
      </div>
    </div>
    <div class="chatMessages" id="chatMessages">
      <div class="message ai"><div class="messageBubble">üëã Ciao! Sono AI BOTT.
Posso aiutarti con auto nuove (Fiat, Jeep, Alfa, Lancia) e usate (CentroAuto VT).
Esempi: "Ford usate disponibili" ¬∑ "Confronta Compass e Tonale" üí°</div></div>
    </div>
    <div class="chatInput">
      <input type="text" class="chatInputField" id="chatInputField" placeholder="Scrivi..." autocomplete="off"/>
      <button class="chatSendBtn" id="chatSendBtn">‚û§</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, setPersistence, browserLocalPersistence, browserSessionPersistence,
      GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult,
      signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, doc, onSnapshot, setDoc, enableIndexedDbPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const BACKEND_NEWS   = "/api/news";
    const BACKEND_CHAT   = "https://auto-backend-three.vercel.app/api/chat";
    const BACKEND_SEARCH = "https://auto-backend-three.vercel.app/api/search";
    const BRAND_LINKS = {
      Fiat:"https://www.fiat.it/omni/configuratore/#/",
      Jeep:"https://www.jeep-official.it/omni/configuratore",
      AlfaRomeo:"https://www.alfaromeo.it/omni/configuratore",
      Lancia:"https://www.lancia.it/omni/configuratore"
    };
    const firebaseConfig = {
      apiKey:"AIzaSyALsFF_dpL39GlPfMyKBFIKtZi5coOk9I8",
      authDomain:"auto-1af60.firebaseapp.com",
      projectId:"auto-1af60",
      storageBucket:"auto-1af60.firebasestorage.app",
      messagingSenderId:"498320258984",
      appId:"1:498320258984:web:bac67d7634273d10464f9d",
      measurementId:"G-WYM78KQWQJ"
    };
    const $ = id => document.getElementById(id);
    const setStatus = t => { $("status").textContent = t; };
    function escapeHtml(s=""){return String(s??"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]))}
    function safeHost(url){try{return new URL(url).hostname}catch{return""}}
    function fmtDate(d){if(!d)return"";const dt=new Date(d);if(Number.isNaN(dt.getTime()))return String(d);return dt.toLocaleString("it-IT",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}
    function renderItems(items){
      const box=$("newsList");
      if(!items||!items.length){box.innerHTML='<div class="muted" style="padding:20px;text-align:center">Nessuna news.</div>';setStatus("Nessuna news trovata.");return}
      box.innerHTML=items.map(n=>{
        const link=n.url||n.link||"",title=n.title||"Senza titolo",date=fmtDate(n.date||n.pubDate||""),host=safeHost(link);
        return`<a class="newsItem" href="${escapeHtml(link)}" target="_blank" rel="noopener noreferrer"><div class="newsTitle">${escapeHtml(title)}</div>${host?`<div class="newsMeta">üîó ${escapeHtml(host)}</div>`:""}${date?`<div class="newsDate">üïí ${escapeHtml(date)}</div>`:""}</a>`;
      }).join("");
      setStatus(`‚úÖ ${items.length} news caricate ‚Ä¢ ${new Date().toLocaleString("it-IT")}`);
    }

    const app=initializeApp(firebaseConfig);
    const auth=getAuth(app);
    const db=getFirestore(app);
    enableIndexedDbPersistence(db).catch(()=>{});
    const provider=new GoogleAuthProvider();
    provider.setCustomParameters({prompt:"select_account",display:"popup"});

    (async function(){
      try{await setPersistence(auth,browserLocalPersistence)}catch{try{await setPersistence(auth,browserSessionPersistence)}catch{}}
      try{await getRedirectResult(auth)}catch{}
    })();

    async function loadNews(){
      if(!auth.currentUser){$("newsList").innerHTML="";setStatus("üîí Login per vedere le news.");return}
      setStatus("‚è≥ Caricamento...");$("refreshBtn").disabled=true;
      try{
        const r=await fetch(BACKEND_NEWS,{method:"GET",headers:{"Cache-Control":"no-cache"},cache:"no-store"});
        if(!r.ok)throw new Error(`HTTP ${r.status}`);
        const data=await r.json();
        if(data.items&&Array.isArray(data.items))renderItems(data.items);
        else if(Array.isArray(data))renderItems(data);
        else throw new Error("Formato non valido");
      }catch(err){
        $("newsList").innerHTML='<div class="muted" style="padding:20px;text-align:center">‚ùå Errore news</div>';
        setStatus("‚ùå "+(err?.message||err));
      }finally{$("refreshBtn").disabled=!auth.currentUser}
    }

    $("loginBtn").addEventListener("click",async()=>{
      try{
        setStatus("üîê Apertura login...");
        try{const r=await signInWithPopup(auth,provider);setStatus("‚úÖ Login riuscito! "+r.user.email)}
        catch(pe){
          if(["auth/popup-blocked","auth/popup-closed-by-user","auth/cancelled-popup-request"].includes(pe.code)){setStatus("üîÑ Reindirizzamento...");await signInWithRedirect(auth,provider)}
          else throw pe;
        }
      }catch(e){
        let msg=e.code==="auth/unauthorized-domain"?"Dominio non autorizzato":e.code||e.message;
        setStatus("‚ùå "+msg);
      }
    });
    $("logoutBtn").addEventListener("click",async()=>{try{await signOut(auth);$("newsList").innerHTML="";setStatus("üëã Logout.")}catch(e){setStatus("‚ùå "+e.message)}});
    $("refreshBtn").addEventListener("click",loadNews);
    $("fiatBtn").addEventListener("click",()=>window.open(BRAND_LINKS.Fiat,"_blank","noopener,noreferrer"));
    $("jeepBtn").addEventListener("click",()=>window.open(BRAND_LINKS.Jeep,"_blank","noopener,noreferrer"));
    $("alfaBtn").addEventListener("click",()=>window.open(BRAND_LINKS.AlfaRomeo,"_blank","noopener,noreferrer"));
    $("lanciaBtn").addEventListener("click",()=>window.open(BRAND_LINKS.Lancia,"_blank","noopener,noreferrer"));

    /* ‚ïê‚ïê AGENDA + MEMO + CALENDARIO ‚ïê‚ïê */
    const SYNC={unsub:null,uid:null,docRef:null,data:{tasks:{},memos:{}},ready:false};
    function setSyncBadge(state){
      const b=$("syncBadge");
      if(state==="ok"){b.className="syncBadge ok";b.textContent="Sync: attivo"}
      else if(state==="warn"){b.className="syncBadge warn";b.textContent="Sync: non attivo"}
      else{b.className="syncBadge";b.textContent="Sync: ..."}
    }
    function todayMidnight(d=new Date()){const x=new Date(d);x.setHours(0,0,0,0);return x}
    function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x}
    function dateKey(d){const x=todayMidnight(d);return`${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,"0")}-${String(x.getDate()).padStart(2,"0")}`}
    function prettyDay(d){return d.toLocaleDateString("it-IT",{weekday:"short",day:"2-digit",month:"2-digit"})}
    function mkUid(){return Math.random().toString(16).slice(2)+Date.now().toString(16)}

    function startOfWeekMonday(d=new Date()){const x=todayMidnight(d);const day=x.getDay();x.setDate(x.getDate()+(day===0?-6:1-day));return x}
    function fmtRange(a,b){return`${a.toLocaleDateString("it-IT",{day:"2-digit",month:"2-digit"})}‚Äì${b.toLocaleDateString("it-IT",{day:"2-digit",month:"2-digit"})}`}

    function renderWeekCalendar(){
      const grid=$("weekGrid"),range=$("weekRange");
      if(!grid||!range)return;
      if(!auth.currentUser){range.textContent="Login richiesto";grid.innerHTML="";return}
      const base=startOfWeekMonday(new Date());
      range.textContent=fmtRange(base,addDays(base,6));
      const allTasks=Object.values(SYNC.data.tasks||{});
      const todayKey=dateKey(new Date());
      const dows=["Lun","Mar","Mer","Gio","Ven","Sab","Dom"];
      grid.innerHTML=Array.from({length:7}).map((_,i)=>{
        const d=addDays(base,i),k=dateKey(d);
        const tasks=allTasks.filter(t=>t&&t.dateKey===k).sort((a,b)=>(Number(a.done)-Number(b.done))||((a.createdAt||0)-(b.createdAt||0)));
        const show=tasks.slice(0,3).map(t=>`<div class="weekTask${t.done?" done":""}" title="${escapeHtml(t.text||"")}">${escapeHtml(t.text||"")}</div>`).join("");
        const more=tasks.length>3?`<div class="weekMore">+${tasks.length-3} altri</div>`:"";
        return`<div class="weekCell${k===todayKey?" today":""}"><div class="weekTop"><div class="weekDow">${dows[i]}</div><div class="weekDay">${String(d.getDate()).padStart(2,"0")}</div></div><div class="weekTasks">${tasks.length?(show+more):'<div class="muted" style="font-size:11px;opacity:.7">‚Äî</div>'}</div></div>`;
      }).join("");
    }

    let selectedOffset=0;
    function refreshDayHeaders(){
      const base=todayMidnight(new Date());
      $("dayDate0").textContent=prettyDay(base);
      $("dayDate1").textContent=prettyDay(addDays(base,1));
      $("dayDate2").textContent=prettyDay(addDays(base,2));
      renderTasksAndMemos();renderWeekCalendar();
    }
    (function scheduleMidnightRefresh(){
      const now=new Date(),next=new Date(now);next.setHours(24,0,0,0);
      setTimeout(()=>{refreshDayHeaders();scheduleMidnightRefresh()},Math.max(1000,next-now));
    })();

    function normalizePlanner(p){
      return{tasks:(p&&typeof p.tasks==="object"&&p.tasks)?p.tasks:{},memos:(p&&typeof p.memos==="object"&&p.memos)?p.memos:{}};
    }
    async function writePlanner(next){if(!SYNC.docRef)return;await setDoc(SYNC.docRef,next,{merge:false}).catch(()=>{})}
    async function safeWrite(fn){
      if(!SYNC.docRef)return;
      const next=fn(JSON.parse(JSON.stringify(SYNC.data)));
      SYNC.data=next;renderTasksAndMemos();renderWeekCalendar();
      try{await writePlanner(next)}catch{}
    }
    function cleanupOldTasks(data){
      const limitKey=dateKey(addDays(new Date(),-30));
      const out={...data,tasks:{...data.tasks},memos:{...data.memos}};
      for(const[id,t]of Object.entries(out.tasks)){if(t?.dateKey&&String(t.dateKey)<limitKey)delete out.tasks[id]}
      return out;
    }

    function renderTasksAndMemos(){
      if(!auth.currentUser){
        const msg='<div class="muted" style="padding:10px 6px;font-size:12px;">Login richiesto.</div>';
        [$("taskList0"),$("taskList1"),$("taskList2"),$("memoList")].forEach(el=>{if(el)el.innerHTML=msg});
        return;
      }
      const base=todayMidnight(new Date());
      const keys=[dateKey(base),dateKey(addDays(base,1)),dateKey(addDays(base,2))];
      const lists=[$("taskList0"),$("taskList1"),$("taskList2")];
      const allTasks=Object.values(SYNC.data.tasks||{});
      for(let i=0;i<3;i++){
        const items=allTasks.filter(t=>t&&t.dateKey===keys[i]).sort((a,b)=>(Number(a.done)-Number(b.done))||((a.createdAt||0)-(b.createdAt||0)));
        if(!items.length){lists[i].innerHTML='<div class="muted" style="padding:10px 6px;font-size:12px;">Nessun task.</div>';continue}
        lists[i].innerHTML=items.map(t=>`<div class="item" data-id="${escapeHtml(t.id)}"><input class="chk" type="checkbox"${t.done?" checked":""}><div class="itemMain"><div class="itemText${t.done?" done":""}">${escapeHtml(t.text||"")}</div></div><div class="itemActions"><button class="iconBtn del" title="Elimina">√ó</button></div></div>`).join("");
      }
      const memos=Object.values(SYNC.data.memos||{}).sort((a,b)=>(Number(a.done)-Number(b.done))||((a.createdAt||0)-(b.createdAt||0)));
      const box=$("memoList");
      box.innerHTML=!memos.length?'<div class="muted" style="padding:10px 6px;font-size:12px;">Nessuna memo.</div>':
        memos.map(m=>`<div class="item" data-id="${escapeHtml(m.id)}"><div class="itemMain"><div class="itemText${m.done?" done":""}">${escapeHtml(m.text||"")}</div></div><div class="itemActions"><button class="iconBtn pencil" title="Matita">‚úé</button><button class="iconBtn del" title="Elimina">√ó</button></div></div>`).join("");

      document.querySelectorAll("#agendaPanel .item").forEach(el=>{
        const id=el.getAttribute("data-id"),chk=el.querySelector(".chk"),del=el.querySelector(".del");
        chk.addEventListener("change",()=>safeWrite(d=>{if(d.tasks[id])d.tasks[id].done=!!chk.checked;return d}));
        del.addEventListener("click",()=>safeWrite(d=>{delete d.tasks[id];return d}));
      });
      document.querySelectorAll("#memoPanel .item").forEach(el=>{
        const id=el.getAttribute("data-id"),pencil=el.querySelector(".pencil"),del=el.querySelector(".del");
        pencil.addEventListener("click",()=>safeWrite(d=>{if(d.memos[id])d.memos[id].done=!d.memos[id].done;return d}));
        del.addEventListener("click",()=>safeWrite(d=>{delete d.memos[id];return d}));
      });
    }

    function setDayOffset(n){
      selectedOffset=n;
      [0,1,2].forEach(i=>$("dayBtn"+i).classList.toggle("active",i===n));
    }
    [0,1,2].forEach(i=>$("dayBtn"+i).addEventListener("click",()=>setDayOffset(i)));
    setDayOffset(0);

    $("addTaskBtn").addEventListener("click",()=>{
      const text=$("taskInput").value.trim();if(!text)return;
      const target=addDays(todayMidnight(new Date()),selectedOffset),id=mkUid();
      safeWrite(d=>{d.tasks[id]={id,dateKey:dateKey(target),text,done:false,createdAt:Date.now()};return cleanupOldTasks(d)});
      $("taskInput").value="";
    });
    $("taskInput").addEventListener("keypress",e=>{if(e.key==="Enter"){e.preventDefault();$("addTaskBtn").click()}});
    $("agendaClearDoneBtn").addEventListener("click",()=>safeWrite(d=>{for(const[id,t]of Object.entries(d.tasks)){if(t&&t.done)delete d.tasks[id]}return cleanupOldTasks(d)}));
    $("addMemoBtn").addEventListener("click",()=>{
      const text=$("memoInput").value.trim();if(!text)return;
      const id=mkUid();
      safeWrite(d=>{d.memos[id]={id,text,done:false,createdAt:Date.now()};return d});
      $("memoInput").value="";
    });
    $("memoInput").addEventListener("keydown",e=>{if(e.key==="Enter"&&(e.ctrlKey||e.metaKey)){e.preventDefault();$("addMemoBtn").click()}});
    $("memoClearDoneBtn").addEventListener("click",()=>safeWrite(d=>{for(const[id,m]of Object.entries(d.memos)){if(m&&m.done)delete d.memos[id]}return d}));

    /* ‚ïê‚ïê COLPI DI TELEFONO ‚ïê‚ïê */
    let telState={contatti:{}};
    let telDocRef=null,telUnsub=null;
    let telStato="caldo",telWhen="oggi";
    function telUid(){return Math.random().toString(16).slice(2)+Date.now().toString(16)}
    function normalizeTel(d){return{contatti:(d&&typeof d.contatti==="object"&&d.contatti)?d.contatti:{}}}
    async function telWrite(){if(!telDocRef)return;try{await setDoc(telDocRef,telState,{merge:false})}catch{}}
    async function telSafeWrite(fn){
      if(!telDocRef)return;
      const next=fn(JSON.parse(JSON.stringify(telState)));
      telState=next;renderTelefono();try{await telWrite()}catch{}
    }
    const STATO_EMOJI={caldo:"üî• Caldo",tiepido:"üå° Tiepido",freddo:"‚ùÑ Freddo"};
    function telCardHTML(c){
      const sc=escapeHtml(c.stato||"freddo");
      return`<div class="telCard ${sc}${c.chiamato?" chiamato":""}" data-id="${escapeHtml(c.id)}">
        <div class="telCardMain">
          <div class="telCardName${c.chiamato?" chiamato":""}">${escapeHtml(c.nome||"")}</div>
          <div class="telCardMeta">
            ${c.modello?`<span class="telCardModello">üöó ${escapeHtml(c.modello)}</span>`:""}
            <span class="telStatoBadge ${sc}">${STATO_EMOJI[c.stato]||c.stato}</span>
          </div>
        </div>
        <div class="telCardActions">
          <button class="iconBtn telChiamato" title="${c.chiamato?"Riattiva":"Segna chiamato"}" style="font-size:15px;">${c.chiamato?"‚Ü©":"‚úÖ"}</button>
          <button class="iconBtn telDel" title="Elimina" style="font-size:14px;font-weight:900;">√ó</button>
        </div>
      </div>`;
    }
    function renderTelefono(){
      if(!auth.currentUser){
        ["telListOggi","telListDomani","telListSettimana"].forEach(id=>{const el=$(id);if(el)el.innerHTML='<div class="telEmpty">Login richiesto.</div>'});
        return;
      }
      const all=Object.values(telState.contatti||{});
      const groups={oggi:[],domani:[],settimana:[]};
      all.forEach(c=>{if(groups[c.quando])groups[c.quando].push(c)});
      const statoOrd={caldo:0,tiepido:1,freddo:2};
      const sort=arr=>arr.sort((a,b)=>(Number(a.chiamato)-Number(b.chiamato))||(statoOrd[a.stato]||2)-(statoOrd[b.stato]||2)||((a.createdAt||0)-(b.createdAt||0)));
      ["oggi","domani","settimana"].forEach(w=>{
        const el=$("telList"+w.charAt(0).toUpperCase()+w.slice(1));
        const cnt=$("telCnt"+w.charAt(0).toUpperCase()+w.slice(1));
        const items=sort(groups[w]);
        const attivi=items.filter(c=>!c.chiamato).length;
        if(cnt)cnt.textContent=attivi;
        if(!items.length){el.innerHTML='<div class="telEmpty">Nessuno.</div>';return}
        el.innerHTML=items.map(telCardHTML).join("");
      });
      document.querySelectorAll("#telefonoPanel .telCard").forEach(card=>{
        const id=card.getAttribute("data-id");
        card.querySelector(".telChiamato")?.addEventListener("click",()=>telSafeWrite(d=>{if(d.contatti[id])d.contatti[id].chiamato=!d.contatti[id].chiamato;return d}));
        card.querySelector(".telDel")?.addEventListener("click",()=>telSafeWrite(d=>{delete d.contatti[id];return d}));
      });
    }
    ["Caldo","Tiepido","Freddo"].forEach(s=>{
      $("telBtn"+s).addEventListener("click",()=>{
        telStato=s.toLowerCase();
        ["Caldo","Tiepido","Freddo"].forEach(x=>$("telBtn"+x).classList.toggle("active",x===s));
      });
    });
    ["Oggi","Domani","Settimana"].forEach(w=>{
      $("telWhen"+w).addEventListener("click",()=>{
        telWhen=w.toLowerCase();
        ["Oggi","Domani","Settimana"].forEach(x=>$("telWhen"+x).classList.toggle("active",x===w));
      });
    });
    $("telAddBtn").addEventListener("click",()=>{
      const nome=$("telNome").value.trim();if(!nome)return;
      const modello=$("telModello").value.trim();
      const id=telUid();
      telSafeWrite(d=>{d.contatti[id]={id,nome,modello,stato:telStato,quando:telWhen,chiamato:false,createdAt:Date.now()};return d});
      $("telNome").value="";$("telModello").value="";
    });
    $("telNome").addEventListener("keypress",e=>{if(e.key==="Enter"){e.preventDefault();$("telAddBtn").click()}});
    $("telClearDoneBtn").addEventListener("click",()=>telSafeWrite(d=>{for(const[id,c]of Object.entries(d.contatti)){if(c?.chiamato)delete d.contatti[id]}return d}));

    function startTelSync(user){
      if(telUnsub){try{telUnsub()}catch{}}
      telDocRef=doc(db,"users",user.uid,"telefono","data");
      telUnsub=onSnapshot(telDocRef,snap=>{
        telState=normalizeTel(snap.exists()?snap.data():null);
        renderTelefono();
        if(!snap.exists())setDoc(telDocRef,telState,{merge:false}).catch(()=>{});
      },()=>renderTelefono());
    }
    function stopTelSync(){
      if(telUnsub){try{telUnsub()}catch{}}
      telUnsub=null;telDocRef=null;telState={contatti:{}};renderTelefono();
    }

    function startPlannerSync(user){
      stopPlannerSync();
      SYNC.docRef=doc(db,"users",user.uid,"planner","main");
      setSyncBadge("...");
      SYNC.unsub=onSnapshot(SYNC.docRef,snap=>{
        const data=snap.exists()?snap.data():{tasks:{},memos:{}};
        SYNC.data=normalizePlanner(data);SYNC.data=cleanupOldTasks(SYNC.data);SYNC.ready=true;
        setSyncBadge("ok");renderTasksAndMemos();renderWeekCalendar();
        if(!snap.exists())setDoc(SYNC.docRef,SYNC.data,{merge:false}).catch(()=>{});
      },()=>setSyncBadge("warn"));
    }
    function stopPlannerSync(){
      if(SYNC.unsub){try{SYNC.unsub()}catch{}}
      SYNC.unsub=null;SYNC.docRef=null;SYNC.data={tasks:{},memos:{}};SYNC.ready=false;
      setSyncBadge("warn");renderTasksAndMemos();renderWeekCalendar();
    }

    /* ‚ïê‚ïê COMPARATORE ‚ïê‚ïê */
    const COMPARATORE_SYSTEM=`Sei un esperto di auto nuove (Fiat, Jeep, Alfa Romeo, Lancia).
Quando confronti due modelli usa questo formato:

‚öî CONFRONTO: [MODELLO1] vs [MODELLO2]

üîµ [MODELLO1]
‚Ä¢ Punto forza 1
‚Ä¢ Punto forza 2
üí∞ Prezzo da: ‚Ç¨XX.XXX
‚öô Motori: [lista]

üü† [MODELLO2]
‚Ä¢ Punto forza 1
‚Ä¢ Punto forza 2
üí∞ Prezzo da: ‚Ç¨XX.XXX
‚öô Motori: [lista]

üìä DIFFERENZE CHIAVE:
‚Ä¢ Dimensioni: [chi √® pi√π grande]
‚Ä¢ Tecnologia: [chi ha pi√π dotazioni]

üèÜ CONSIGLIO: [breve suggerimento]

Solo questo schema, niente testo extra.`;

    async function runComparatore(){
      const m1=$("cmpInput1").value.trim(),m2=$("cmpInput2").value.trim();
      if(!m1||!m2){$("cmpResults").innerHTML='<div style="color:#fca5a5;background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.25);border-radius:10px;padding:12px 16px;font-size:13px;">‚ö† Inserisci entrambi i modelli!</div>';return}
      const btn=$("cmpBtn");
      btn.disabled=true;btn.textContent="‚è≥ Ricerca...";
      $("cmpResults").innerHTML='<div style="display:flex;align-items:center;justify-content:center;gap:10px;padding:30px 0;color:#60a5fa;font-size:14px;"><span>üîç Ricerca in corso...</span></div>';
      try{
        let searchContext="";
        try{
          const sq=`${m1} vs ${m2} allestimenti caratteristiche prezzo site:fiat.it OR site:jeep-official.it OR site:alfaromeo.it OR site:lancia.it`;
          const sr=await fetch(`${BACKEND_SEARCH}?q=${encodeURIComponent(sq)}`);
          if(sr.ok){const sd=await sr.json();if(sd.results?.length){const allowed=['fiat.it','jeep-official.it','alfaromeo.it','lancia.it'];const valid=sd.results.filter(r=>allowed.some(d=>r.url.toLowerCase().includes(d)));if(valid.length)searchContext=valid.slice(0,4).map(r=>`${r.title}\n${r.description}\n${r.url}`).join("\n\n---\n\n")}}
        }catch{}
        const messages=[
          {role:"system",content:COMPARATORE_SYSTEM},
          ...(searchContext?[{role:"system",content:`DATI DAI CONFIGURATORI UFFICIALI:\n\n${searchContext}`}]:[]),
          {role:"user",content:`Confronta ${m1} vs ${m2}`}
        ];
        const res=await fetch(BACKEND_CHAT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages})});
        if(!res.ok)throw new Error(`HTTP ${res.status}`);
        const data=await res.json();
        let ai=data.choices?.[0]?.message?.content||"Nessuna risposta.";
        ai=ai.replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]));
        $("cmpResults").innerHTML=`<div style="background:rgba(31,41,55,.35);border:1px solid rgba(31,41,55,.7);border-radius:12px;padding:14px 16px;white-space:pre-line;font-size:13px;line-height:1.65">${ai}</div>`;
      }catch(err){
        $("cmpResults").innerHTML=`<div style="color:#fca5a5;background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.25);border-radius:10px;padding:12px 16px;font-size:13px;">‚ùå Errore di connessione. Riprova tra poco.</div>`;
      }finally{
        btn.disabled=false;btn.textContent="üîé Confronta";
      }
    }

    document.querySelectorAll(".cmpSuggest").forEach(btn=>btn.addEventListener("click",()=>{
      $("cmpInput1").value=btn.dataset.s1;$("cmpInput2").value=btn.dataset.s2;
      [$("cmpInput1"),$("cmpInput2")].forEach(el=>el.style.borderColor="#3b82f6");
      runComparatore();
    }));
    $("cmpResetBtn").addEventListener("click",()=>{
      $("cmpInput1").value="";$("cmpInput2").value="";
      $("cmpResults").innerHTML='<div style="text-align:center;color:#9ca3af;padding:30px 0;font-size:14px;">‚Üë Scrivi il modello e premi Confronta</div>';
    });
    $("cmpBtn").addEventListener("click",runComparatore);
    $("cmpInput1").addEventListener("keypress",e=>{if(e.key==="Enter"){e.preventDefault();runComparatore()}});
    $("cmpInput2").addEventListener("keypress",e=>{if(e.key==="Enter"){e.preventDefault();runComparatore()}});

    /* ‚ïê‚ïê VENDITE MENSILI ‚ïê‚ïê */
    let vendState={months:{},obiettivo:0};
    let vendDocRef=null,vendUnsub=null,vendTipo="nuova";
    const TODAY_KEY=(()=>{const n=new Date();return`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}`})();
    let vendViewKey=TODAY_KEY;

    function monthLabel(k){const[y,m]=k.split("-").map(Number);const d=new Date(y,m-1,1);const l=d.toLocaleDateString("it-IT",{month:"long",year:"numeric"});return l.charAt(0).toUpperCase()+l.slice(1)}
    function prevMonthKey(k){const[y,m]=k.split("-").map(Number);const d=new Date(y,m-2,1);return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`}
    function nextMonthKey(k){const[y,m]=k.split("-").map(Number);const d=new Date(y,m,1);return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`}
    function vendUid(){return Math.random().toString(16).slice(2)+Date.now().toString(16)}
    function ensureMonth(k){if(!vendState.months[k])vendState.months[k]={nuove:[],usate:[]}}
    function sumProvv(list){return(list||[]).reduce((s,c)=>s+(Number(c.provv)||0),0)}
    function fmtEur(n){return"‚Ç¨ "+n.toLocaleString("it-IT",{minimumFractionDigits:0,maximumFractionDigits:0})}

    function renderObiettivo(provvMese){
      const target=vendState.obiettivo||0;
      const inp=$("obiettivoInput");
      if(document.activeElement!==inp)inp.value=target>0?target:"";
      const fill=$("progressFill"),pct=$("progressPct"),manca=$("progressManca");
      if(!target||target<=0){fill.style.width="0%";fill.className="progressFill low";pct.textContent="0%";pct.className="progressPct low";manca.textContent="Imposta un obiettivo ‚Üë";manca.className="progressManca";return}
      const ratio=Math.min(provvMese/target,1);const pctVal=Math.round(ratio*100);
      const tier=pctVal>=100?"done":pctVal>=66?"high":pctVal>=33?"mid":"low";
      fill.style.width=(ratio*100).toFixed(1)+"%";fill.className="progressFill "+tier;
      pct.textContent=pctVal+"%";pct.className="progressPct "+tier;
      if(pctVal>=100){manca.textContent="üéâ Obiettivo raggiunto! +"+fmtEur(provvMese-target)+" extra";manca.className="progressManca done"}
      else{manca.textContent="Mancano "+fmtEur(target-provvMese)+" all'obiettivo";manca.className="progressManca"}
    }

    function renderVendite(){
      const k=vendViewKey;ensureMonth(k);
      const mese=vendState.months[k],nuove=mese.nuove||[],usate=mese.usate||[];
      const isCurrent=(k===TODAY_KEY);
      $("vendMonthLabel").innerHTML=escapeHtml(monthLabel(k))+(isCurrent?' <span style="color:#22c55e;font-weight:700;font-size:11px;">‚óè in corso</span>':"");
      $("vendNextBtn").disabled=(k===TODAY_KEY);
      $("totNuove").textContent=nuove.length;$("totUsate").textContent=usate.length;$("totAll").textContent=nuove.length+usate.length;
      $("cntNuove").textContent=nuove.length;$("cntUsate").textContent=usate.length;
      $("listNuove").innerHTML=nuove.length?nuove.map((c,i)=>autoItemHTML(c,i+1,"nuova")).join(""):'<div class="emptyList">Nessuna auto nuova</div>';
      $("listUsate").innerHTML=usate.length?usate.map((c,i)=>autoItemHTML(c,i+1,"usata")).join(""):'<div class="emptyList">Nessuna auto usata</div>';
      document.querySelectorAll(".autoDelBtn").forEach(btn=>btn.addEventListener("click",()=>deleteAuto(k,btn.dataset.tipo,btn.dataset.id)));
      const pNuove=sumProvv(nuove),pUsate=sumProvv(usate),pTot=pNuove+pUsate;
      $("provvMeseTot").textContent=fmtEur(pTot);
      $("provvMeseSplit").textContent=pNuove>0&&pUsate>0?`üÜï ${fmtEur(pNuove)}  ¬∑  üîÑ ${fmtEur(pUsate)}`:pNuove>0?"üÜï Tutte da auto nuove":pUsate>0?"üîÑ Tutte da auto usate":"Nessuna provvigione inserita";
      let tot2026=0,mesi2026=0;
      Object.entries(vendState.months).forEach(([mk,mv])=>{if(!mk.startsWith("2026"))return;const mP=sumProvv(mv.nuove||[])+sumProvv(mv.usate||[]);tot2026+=mP;if(mP>0)mesi2026++});
      $("provv2026Tot").textContent=fmtEur(tot2026);
      $("provv2026Mesi").textContent=mesi2026===0?"Nessun mese con provvigioni":mesi2026===1?"1 mese con provvigioni":mesi2026+" mesi con provvigioni";
      renderObiettivo(pTot);
    }

    function autoItemHTML(c,n,tipo){
      const p=Number(c.provv)||0,pStr=p>0?"‚Ç¨ "+p.toLocaleString("it-IT"):"‚Äî",cls=p>0?"autoProvv":"autoProvv zero";
      return`<div class="autoItem"><span class="autoN">#${n}</span><span class="autoModello">${escapeHtml(c.modello)}</span><span class="${cls}">${pStr}</span><button class="autoDelBtn" data-id="${escapeHtml(c.id)}" data-tipo="${tipo}" title="Elimina">√ó</button></div>`;
    }

    async function vendWrite(){if(!vendDocRef)return;try{await setDoc(vendDocRef,vendState,{merge:false})}catch{}}
    async function addAuto(){
      const modello=$("vendModello").value.trim();if(!modello)return;
      const provv=parseFloat($("vendProvv").value)||0;
      const k=vendViewKey;ensureMonth(k);
      const id=vendUid(),entry={id,modello,provv,createdAt:Date.now()};
      if(vendTipo==="nuova")vendState.months[k].nuove.push(entry);
      else vendState.months[k].usate.push(entry);
      $("vendModello").value="";$("vendProvv").value="";
      renderVendite();await vendWrite();
    }
    async function deleteAuto(k,tipo,id){
      ensureMonth(k);
      const list=tipo==="nuova"?vendState.months[k].nuove:vendState.months[k].usate;
      const idx=list.findIndex(c=>c.id===id);if(idx!==-1)list.splice(idx,1);
      renderVendite();await vendWrite();
    }

    function startVenditeSync(user){
      if(vendUnsub){try{vendUnsub()}catch{}}
      vendDocRef=doc(db,"users",user.uid,"vendite","data");
      setSyncVendite("sync");
      vendUnsub=onSnapshot(vendDocRef,snap=>{
        if(snap.exists()){const d=snap.data();vendState={months:d.months||{},obiettivo:d.obiettivo||0}}
        else{vendState={months:{},obiettivo:0}}
        ensureMonth(TODAY_KEY);setSyncVendite("ok");renderVendite();
        if(!snap.exists())setDoc(vendDocRef,vendState,{merge:false}).catch(()=>{});
      },()=>setSyncVendite("warn"));
    }
    function stopVenditeSync(){
      if(vendUnsub){try{vendUnsub()}catch{}}
      vendUnsub=null;vendDocRef=null;vendState={months:{},obiettivo:0};
      setSyncVendite("warn");renderVendite();
    }
    function setSyncVendite(s){
      const b=$("venditeSyncBadge");
      if(s==="ok"){b.className="venditeSyncBadge ok";b.textContent="Sync ‚úì"}
      else if(s==="sync"){b.className="venditeSyncBadge";b.textContent="Sync ‚Ä¶"}
      else{b.className="venditeSyncBadge";b.textContent="Sync ‚Äî"}
    }

    $("vendPrevBtn").addEventListener("click",()=>{vendViewKey=prevMonthKey(vendViewKey);ensureMonth(vendViewKey);renderVendite()});
    $("vendNextBtn").addEventListener("click",()=>{if(vendViewKey===TODAY_KEY)return;vendViewKey=nextMonthKey(vendViewKey);ensureMonth(vendViewKey);renderVendite()});
    $("tipoBtnNuova").addEventListener("click",()=>{vendTipo="nuova";$("tipoBtnNuova").classList.add("active");$("tipoBtnUsata").classList.remove("active")});
    $("tipoBtnUsata").addEventListener("click",()=>{vendTipo="usata";$("tipoBtnUsata").classList.add("active");$("tipoBtnNuova").classList.remove("active")});
    $("vendAddBtn").addEventListener("click",addAuto);
    $("vendModello").addEventListener("keypress",e=>{if(e.key==="Enter"){e.preventDefault();addAuto()}});
    $("vendProvv").addEventListener("keypress",e=>{if(e.key==="Enter"){e.preventDefault();addAuto()}});
    $("obiettivoInput").addEventListener("input",async()=>{
      vendState.obiettivo=parseFloat($("obiettivoInput").value)||0;
      const k=vendViewKey;ensureMonth(k);const m=vendState.months[k];
      renderObiettivo(sumProvv(m.nuove||[])+sumProvv(m.usate||[]));
      await vendWrite();
    });

    ensureMonth(TODAY_KEY);renderVendite();
    (function scheduleMonthCheck(){
      const now=new Date(),next=new Date(now.getFullYear(),now.getMonth()+1,1,0,0,5);
      setTimeout(()=>{if(vendViewKey===TODAY_KEY)vendViewKey=nextMonthKey(TODAY_KEY);ensureMonth(TODAY_KEY);renderVendite();scheduleMonthCheck()},Math.max(5000,next-now));
    })();

    /* ‚ïê‚ïê AUTH STATE ‚ïê‚ïê */
    onAuthStateChanged(auth,user=>{
      if(user){
        $("userPill").textContent="‚úÖ "+(user.email||"Utente");
        $("userPill").classList.remove("muted");
        $("userPill").style.borderColor="rgba(34,197,94,.5)";
        $("userPill").style.background="rgba(34,197,94,.1)";
        $("loginBtn").style.display="none";$("logoutBtn").style.display="inline-block";$("refreshBtn").disabled=false;
        loadNews();refreshDayHeaders();startPlannerSync(user);startVenditeSync(user);startTelSync(user);
      }else{
        $("userPill").textContent="üîí Non autenticato";
        $("userPill").classList.add("muted");
        $("userPill").style.borderColor="";$("userPill").style.background="";
        $("loginBtn").style.display="inline-block";$("logoutBtn").style.display="none";$("refreshBtn").disabled=true;
        $("newsList").innerHTML="";setStatus("üîí Effettua il login per caricare le news.");
        stopPlannerSync();stopVenditeSync();stopTelSync();
      }
    });

    /* ‚ïê‚ïê CHATBOT ‚ïê‚ïê */
    let chatHistory=[],isMinimized=false;
    const chatTrigger=$("chatTrigger"),chatBox=$("chatBox"),chatMessages=$("chatMessages"),chatInputField=$("chatInputField"),chatSendBtn=$("chatSendBtn");
    chatTrigger.addEventListener("click",()=>{chatBox.classList.add("open");chatBox.classList.remove("minimized");chatTrigger.style.display="none";$("chatMinimizedLogo").style.display="none";chatInputField.focus()});
    $("minimizeBtn").addEventListener("click",()=>{chatBox.classList.add("minimized");isMinimized=true;$("chatMinimizedLogo").style.display="block"});
    $("closeBtn").addEventListener("click",()=>{chatBox.classList.remove("open","minimized");chatTrigger.style.display="flex"});
    chatBox.querySelector(".chatHeader").addEventListener("click",e=>{if(isMinimized&&!e.target.closest("button")){chatBox.classList.remove("minimized");isMinimized=false;$("chatMinimizedLogo").style.display="none"}});
    $("chatMinimizedLogo").addEventListener("click",()=>{chatBox.classList.remove("minimized");isMinimized=false;$("chatMinimizedLogo").style.display="none";chatInputField.focus()});

    function addMessage(text,sender){
      const div=document.createElement("div");div.className=`message ${sender}`;
      div.innerHTML=`<div class="messageBubble">${sender==="ai"?text:escapeHtml(text)}</div>`;
      chatMessages.appendChild(div);chatMessages.scrollTop=chatMessages.scrollHeight;
    }
    function showTyping(){const d=document.createElement("div");d.className="message ai";d.id="typingIndicator";d.innerHTML='<div class="typingIndicator"><div class="typingDot"></div><div class="typingDot"></div><div class="typingDot"></div></div>';chatMessages.appendChild(d);chatMessages.scrollTop=chatMessages.scrollHeight}
    function hideTyping(){const t=$("typingIndicator");if(t)t.remove()}

    function needsSearch(text){
      const kw=['prezzo','costo','listino','allestimento','versione','dotazione','optional','motore','cavalli','cv','kw','consumi','autonomia','dimensioni','bagagliaio','colori','confronto','differenza','meglio','vs','ibrida','elettrica','plug-in','diesel','benzina','gpl','trazione','integrale','cambio','automatico','garanzia','manutenzione','panda','punto','500','tipo','ducato','renegade','compass','wrangler','cherokee','avenger','giulia','stelvio','tonale','giulietta','ypsilon','delta','usato','usata','usati','usate','seconda mano','km zero','centroauto','occasione','ford','kia','lancia','land rover','man','mazda','mg','opel','peugeot','renault','seat','smart','suzuki','volkswagen','audi','bmw','mercedes','volvo','toyota','honda','nissan','hyundai','citroen','dacia','skoda','mini','focus','fiesta','kuga','sportage','picanto','defender','corsa','astra','mokka','208','308','2008','clio','captur','megane','ibiza','leon','vitara','swift','golf','polo','tiguan'];
      const low=text.toLowerCase();return kw.some(k=>low.includes(k));
    }
    async function searchCarInfo(query){
      try{
        const low=query.toLowerCase();
        const usedBrands=['ford','jeep','kia','lancia','land rover','man','mazda','mg','opel','peugeot','renault','seat','smart','suzuki','volkswagen','audi','bmw','mercedes','volvo','toyota','honda','nissan','hyundai','citroen','dacia','skoda','mini'];
        const isUsed=['usato','usata','usati','usate','seconda mano','km zero','centroauto','occasione'].some(k=>low.includes(k))||usedBrands.some(b=>low.includes(b));
        let eQ,aD;
        if(isUsed){const mb=usedBrands.find(b=>low.includes(b));eQ=`${mb?mb+" ":""}${query} site:centroautovt.it/ricerca-auto/usate`;aD=['centroautovt.it']}
        else{eQ=`${query} allestimenti versioni site:fiat.it OR site:jeep-official.it OR site:alfaromeo.it OR site:lancia.it`;aD=['fiat.it','jeep-official.it','alfaromeo.it','lancia.it']}
        const r=await fetch(`${BACKEND_SEARCH}?q=${encodeURIComponent(eQ)}`);
        if(!r.ok)throw new Error();
        const data=await r.json();
        if(data.results?.length){
          const valid=data.results.filter(r=>aD.some(d=>r.url.toLowerCase().includes(d)));
          if(!valid.length)return null;
          if(isUsed)return valid.slice(0,6).map(r=>`üöó ${r.title}\n${r.description}\nüîó ${r.url}`).join("\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n");
          return valid.slice(0,3).map(r=>{const b=r.url.includes('fiat')?'Fiat':r.url.includes('jeep')?'Jeep':r.url.includes('alfa')?'Alfa Romeo':'Lancia';return`‚îÅ‚îÅ‚îÅ ${b.toUpperCase()} ‚îÅ‚îÅ‚îÅ\n${r.title}\n\n${r.description}\n\nüîó ${r.url}`}).join("\n\n");
        }
        return null;
      }catch{return null}
    }
    const SYSTEM_PROMPT=`Sei un assistente esperto di auto NUOVE e USATE. AUTO NUOVE: Fiat, Jeep, Alfa Romeo, Lancia. AUTO USATE: CentroAuto VT. Risposte SCHEMATICHE e CONCISE (max 10 righe), usa elenchi puntati, solo dati concreti e verificabili.`;

    async function sendMessage(){
      const msg=chatInputField.value.trim();if(!msg)return;
      addMessage(msg,"user");chatInputField.value="";chatSendBtn.disabled=true;
      chatHistory.push({role:"user",content:msg});showTyping();
      try{
        const sr=needsSearch(msg)?await searchCarInfo(msg):null;
        const messages=[{role:"system",content:SYSTEM_PROMPT},...chatHistory];
        if(sr)messages.push({role:"system",content:`DATI UFFICIALI:\n\n${sr}\n\nRispondi usando SOLO questi dati in formato schematico.`});
        const r=await fetch(BACKEND_CHAT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages})});
        if(!r.ok)throw new Error();
        const data=await r.json();hideTyping();
        let ai=data.choices?.[0]?.message?.content||"Scusa, non ho capito.";
        ai=ai.replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]));
        addMessage(ai,"ai");chatHistory.push({role:"assistant",content:ai});
      }catch{hideTyping();addMessage("‚ùå Errore di connessione. Riprova tra poco.","ai")}
      finally{chatSendBtn.disabled=false;chatInputField.focus()}
    }
    chatSendBtn.addEventListener("click",sendMessage);
    chatInputField.addEventListener("keypress",e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendMessage()}});

    /* ‚ïê‚ïê SMART HEADER ‚ïê‚ïê */
    (function(){
      const hdr=document.querySelector("header");
      let lastY=0,ticking=false;
      window.addEventListener("scroll",()=>{
        if(ticking)return;ticking=true;
        requestAnimationFrame(()=>{
          const y=window.scrollY;
          if(y>lastY&&y>80)hdr.classList.add("header-hidden");
          else hdr.classList.remove("header-hidden");
          lastY=y;ticking=false;
        });
      },{passive:true});
    })();
  </script>
</body>
</html>
