<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI BOTT Automotive</title>

  <style>
    :root{
      --bgTop:#07080b;
      --bgMid:#101216;
      --bgBot:#1a1d23;
      --panel: rgba(17,24,39,.78);
      --line:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#3b82f6;
      --accent2:#60a5fa;
      --orange:#f97316;
      --orange2:#fb923c;
    }

    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(1200px 700px at 18% -12%, rgba(59,130,246,.22), transparent 58%),
        radial-gradient(900px 520px at 72% 8%, rgba(96,165,250,.14), transparent 60%),
        linear-gradient(180deg, var(--bgTop) 0%, var(--bgMid) 48%, var(--bgBot) 100%);
    }

    header{
      position:sticky;top:0;z-index:10;
      background:rgba(10,10,12,.72);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
    }

    .wrap{max-width:1200px;margin:0 auto;padding:16px}

    .row{
      display:flex;gap:12px;align-items:center;
      justify-content:space-between;flex-wrap:wrap;
    }

    .brand{
      display:flex;gap:12px;align-items:center;flex-wrap:wrap;
      min-width:320px;
    }

    .brandMark{display:flex;align-items:center;gap:10px;user-select:none}

    .brandLogo{
      width:4cm;height:4cm;object-fit:contain;
      background:transparent;border:none;outline:none;filter:none;
      mix-blend-mode:screen;
    }

    .brandName{
      font-weight:950;letter-spacing:.2px;font-size:18px;line-height:1;
      background:linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      white-space:nowrap;
    }
    .brandSub{opacity:.75;white-space:nowrap}

    .btn{
      border:1px solid var(--line);
      background:rgba(17,24,39,.75);
      color:var(--text);
      padding:10px 14px;border-radius:12px;
      cursor:pointer;font-size:14px;
      transition:all .2s;font-weight:650;
    }
    .btn:hover{
      border-color:rgba(59,130,246,.6);
      background:rgba(17,24,39,.92);
      transform:translateY(-1px);
    }
    .btn.primary{
      border-color:rgba(59,130,246,.55);
      background:rgba(37,99,235,.16);
    }
    .btn.primary:hover{background:rgba(37,99,235,.26)}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}

    .btn.brand-fiat:hover{border-color:rgba(220,38,38,.6);background:rgba(220,38,38,.1)}
    .btn.brand-jeep:hover{border-color:rgba(34,197,94,.6);background:rgba(34,197,94,.1)}
    .btn.brand-alfa:hover{border-color:rgba(239,68,68,.6);background:rgba(239,68,68,.1)}
    .btn.brand-lancia:hover{border-color:rgba(59,130,246,.6);background:rgba(59,130,246,.1)}

    .centroAutoLink{
      display:inline-flex;align-items:center;
      padding:6px 12px;
      border:2px solid rgba(34,197,94,.4);
      background:rgba(34,197,94,.08);
      border-radius:12px;transition:all .3s ease;
      text-decoration:none;
      box-shadow:0 2px 8px rgba(34,197,94,.15);
    }
    .centroAutoLink:hover{
      border-color:rgba(34,197,94,.7);background:rgba(34,197,94,.18);
      transform:translateY(-2px);box-shadow:0 4px 16px rgba(34,197,94,.3);
    }
    .centroAutoLogo{height:42px;width:auto;object-fit:contain;filter:drop-shadow(0 1px 3px rgba(0,0,0,.2))}

    .pill{
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(17,24,39,.35);
      font-size:12px;white-space:nowrap;
    }
    .muted{color:var(--muted)}

    .layout{
      margin-top:16px;
      display:grid;
      grid-template-columns:420px 1fr;
      gap:16px;align-items:start;
    }

    .panel{
      background:var(--panel);border:1px solid var(--line);
      border-radius:16px;overflow:hidden;
    }

    .panelHeader{
      padding:14px 14px 10px 14px;
      border-bottom:1px solid rgba(31,41,55,.75);
      background:rgba(10,12,18,.35);
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    }
    .panelTitle{font-weight:950;font-size:18px}
    .panelSub{margin-top:6px}

    .newsScroll{
      max-height:calc(100vh - 140px);overflow:auto;padding:12px;
    }
    .newsScroll::-webkit-scrollbar{width:10px}
    .newsScroll::-webkit-scrollbar-thumb{
      background:rgba(59,130,246,.25);border:2px solid rgba(17,24,39,.7);border-radius:999px;
    }
    .newsScroll::-webkit-scrollbar-track{background:rgba(0,0,0,.12)}

    #status{margin:10px 0 0 0}
    #newsList{display:grid;gap:12px}

    .newsItem{
      display:block;padding:14px;border:1px solid var(--line);border-radius:14px;
      text-decoration:none;color:inherit;background:rgba(17,24,39,.35);transition:all .2s;
    }
    .newsItem:hover{
      border-color:rgba(59,130,246,.6);background:rgba(17,24,39,.55);transform:translateX(4px);
    }
    .newsTitle{font-weight:850;margin-bottom:8px}
    .newsMeta{opacity:.75;font-size:12px;margin-top:6px}
    .newsDate{opacity:.75;font-size:12px;margin-top:6px;font-style:italic}

    /* ===== VENDITE ===== */
    .venditePanel{
      background:var(--panel);border:1px solid var(--line);border-radius:16px;overflow:hidden;
    }
    .venditeHeader{
      padding:14px 18px;
      border-bottom:1px solid rgba(31,41,55,.75);
      background:rgba(10,12,18,.35);
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    .venditeTitleRow{display:flex;align-items:center;gap:10px}
    .venditeTitle{font-weight:950;font-size:18px}
    .venditeSyncBadge{
      font-size:11px;padding:4px 10px;border-radius:999px;
      border:1px solid rgba(31,41,55,.9);background:rgba(17,24,39,.35);color:var(--muted);
      white-space:nowrap;
    }
    .venditeSyncBadge.ok{border-color:rgba(34,197,94,.5);background:rgba(34,197,94,.10);color:#bbf7d0}

    /* Navigazione mesi */
    .venditeNav{display:flex;align-items:center;gap:8px}
    .navArrow{
      width:32px;height:32px;border-radius:9px;
      border:1px solid var(--line);background:rgba(17,24,39,.6);
      color:var(--text);cursor:pointer;font-size:18px;font-weight:700;
      display:flex;align-items:center;justify-content:center;
      transition:all .2s;
    }
    .navArrow:hover{border-color:rgba(59,130,246,.5);background:rgba(17,24,39,.9);transform:translateY(-1px)}
    .navArrow:disabled{opacity:.35;cursor:not-allowed;transform:none}
    .venditeMonthLabel{
      font-weight:900;font-size:15px;
      min-width:140px;text-align:center;
      padding:0 4px;
    }
    .venditeMonthLabel span{
      font-size:11px;color:var(--muted);font-weight:400;margin-left:4px;
    }

    /* Totali */
    .venditeTotali{
      display:grid;grid-template-columns:repeat(3,1fr);
      border-bottom:1px solid rgba(31,41,55,.75);
    }
    .totCard{
      padding:14px 18px;
      display:flex;flex-direction:column;gap:4px;
    }
    .totCard:not(:last-child){border-right:1px solid rgba(31,41,55,.75)}
    .totLabel{font-size:11px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--muted)}
    .totNum{font-size:36px;font-weight:950;line-height:1}
    .totNum.nuova{color:#60a5fa}
    .totNum.usata{color:#f97316}
    .totNum.all{color:#22c55e}

    /* Form aggiungi */
    .venditeForm{
      padding:12px 18px;
      border-bottom:1px solid rgba(31,41,55,.5);
      display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;
    }
    .venditeForm .fld{
      flex:1;min-width:180px;
      background:rgba(31,41,55,.6);
      border:1px solid var(--line);border-radius:10px;
      padding:9px 13px;color:var(--text);font-size:13px;
      outline:none;font-family:inherit;transition:border-color .2s;
    }
    .venditeForm .fld:focus{border-color:var(--accent)}
    .venditeForm .fld::placeholder{color:var(--muted)}

    /* Toggle Nuova / Usata */
    .tipoSeg{
      display:inline-flex;border:1px solid rgba(31,41,55,.9);
      background:rgba(17,24,39,.35);border-radius:999px;overflow:hidden;flex-shrink:0;
    }
    .tipoBtn{
      border:none;background:transparent;color:var(--muted);
      padding:9px 14px;font-size:13px;cursor:pointer;
      font-family:inherit;font-weight:700;transition:all .2s;white-space:nowrap;
    }
    .tipoBtn.nuova.active{
      background:linear-gradient(135deg,rgba(59,130,246,.28),rgba(96,165,250,.2));color:#93c5fd;
    }
    .tipoBtn.usata.active{
      background:linear-gradient(135deg,rgba(249,115,22,.28),rgba(251,146,60,.2));color:#fdba74;
    }
    .tipoBtn:hover{opacity:.85}

    /* Liste auto */
    .venditeListe{
      display:grid;grid-template-columns:1fr 1fr;
      min-height:180px;
    }
    .venditeCol{padding:14px 16px}
    .venditeCol:first-child{border-right:1px solid rgba(31,41,55,.75)}
    .venditeColTitle{
      font-size:12px;font-weight:900;letter-spacing:.3px;
      margin-bottom:10px;display:flex;align-items:center;gap:6px;
    }
    .venditeColTitle.nuova{color:#60a5fa}
    .venditeColTitle.usata{color:#f97316}
    .venditeCount{
      font-size:11px;padding:2px 8px;border-radius:999px;font-weight:700;
    }
    .venditeCount.nuova{background:rgba(59,130,246,.15);border:1px solid rgba(59,130,246,.3);color:#93c5fd}
    .venditeCount.usata{background:rgba(249,115,22,.12);border:1px solid rgba(249,115,22,.3);color:#fdba74}

    .venditeList{
      display:grid;gap:6px;max-height:320px;overflow-y:auto;
    }
    .venditeList::-webkit-scrollbar{width:6px}
    .venditeList::-webkit-scrollbar-thumb{background:rgba(59,130,246,.2);border-radius:999px}

    .autoItem{
      display:flex;align-items:center;gap:8px;
      padding:8px 10px;
      border:1px solid rgba(31,41,55,.7);border-radius:10px;
      background:rgba(17,24,39,.35);
      animation:itemIn .2s ease;
    }
    @keyframes itemIn{from{opacity:0;transform:translateX(-6px)}to{opacity:1;transform:none}}
    .autoN{
      font-size:11px;font-weight:900;min-width:20px;
      color:var(--muted);
    }
    .autoModello{flex:1;font-size:13px;line-height:1.3;word-break:break-word}
    .autoDelBtn{
      width:24px;height:24px;border-radius:7px;
      border:1px solid rgba(31,41,55,.9);
      background:rgba(17,24,39,.4);color:var(--muted);
      cursor:pointer;font-size:14px;font-weight:900;
      display:flex;align-items:center;justify-content:center;
      transition:all .2s;flex-shrink:0;
    }
    .autoDelBtn:hover{
      border-color:rgba(239,68,68,.4);background:rgba(239,68,68,.1);color:#fca5a5;
    }
    .emptyList{
      font-size:12px;color:var(--muted);font-style:italic;padding:8px 2px;
    }

    /* Provvigione su card */
    .autoProvv{
      font-size:12px;font-weight:700;color:#4ade80;
      background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.25);
      border-radius:6px;padding:2px 7px;white-space:nowrap;flex-shrink:0;
    }
    .autoProvv.zero{color:var(--muted);background:transparent;border-color:rgba(31,41,55,.5);font-weight:400}

    /* Totale provvigioni mese */
    .venditeProvvBar{
      border-top:1px solid rgba(31,41,55,.75);
      padding:12px 18px;
      display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;
      background:rgba(34,197,94,.04);
    }
    .provvMeseGroup{display:flex;flex-direction:column;gap:2px}
    .provvMeseLabel{font-size:11px;font-weight:700;color:var(--muted);letter-spacing:.4px;text-transform:uppercase}
    .provvMeseNum{font-size:24px;font-weight:950;color:#4ade80;font-variant-numeric:tabular-nums}
    .provvMeseSplit{font-size:11px;color:var(--muted);margin-top:2px}

    /* Totale 2026 */
    .vendite2026Bar{
      border-top:2px solid rgba(251,191,36,.3);
      padding:14px 18px;
      background:linear-gradient(90deg,rgba(251,191,36,.07) 0%,transparent 100%);
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    .bar2026Left{display:flex;align-items:center;gap:10px}
    .bar2026Icon{font-size:22px}
    .bar2026Title{font-weight:900;font-size:14px}
    .bar2026Sub{font-size:11px;color:var(--muted);margin-top:2px}
    .bar2026Right{text-align:right}
    .bar2026Num{font-size:30px;font-weight:950;color:#fbbf24;font-variant-numeric:tabular-nums}
    .bar2026Mesi{font-size:11px;color:var(--muted);margin-top:2px}

    /* ===== CHATBOT ===== */
    .chatTrigger{
      position:fixed;bottom:24px;right:24px;
      width:70px;height:70px;border-radius:50%;
      background:transparent;border:none;cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 8px 24px rgba(0,0,0,.3);transition:all .3s ease;z-index:1000;
    }
    .chatTrigger:hover{transform:scale(1.1);box-shadow:0 12px 32px rgba(0,0,0,.5)}
    .chatTrigger img{width:70px;height:70px;object-fit:contain}

    .chatBox{
      position:fixed;bottom:24px;right:24px;
      width:420px;max-width:calc(100vw - 32px);
      height:600px;max-height:calc(100vh - 48px);
      background:rgba(17,24,39,.95);border:1px solid var(--line);
      border-radius:20px;display:none;flex-direction:column;
      box-shadow:0 20px 60px rgba(0,0,0,.6);z-index:1001;overflow:hidden;backdrop-filter:blur(20px);
    }
    .chatBox.open{display:flex}
    .chatBox.minimized{
      width:70px;height:70px;background:transparent;border:none;
      border-radius:50%;box-shadow:0 8px 24px rgba(0,0,0,.3);
    }
    .chatBox.minimized .chatHeader,
    .chatBox.minimized .chatMessages,
    .chatBox.minimized .chatInput{display:none}

    .chatHeader{
      background:linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
      padding:14px 16px;display:flex;align-items:center;justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.15);
    }
    .chatHeaderLeft{display:flex;align-items:center;gap:10px}
    .chatHeaderLogo{width:38px;height:38px;border-radius:50%;background:rgba(255,255,255,.15);padding:4px}
    .chatHeaderTitle{font-weight:700;font-size:16px;color:#fff}
    .chatHeaderSub{font-size:11px;color:rgba(255,255,255,.75);margin-top:2px}
    .chatHeaderBtns{display:flex;gap:8px}
    .chatHeaderBtn{
      width:32px;height:32px;border-radius:8px;background:rgba(255,255,255,.15);
      border:none;color:#fff;cursor:pointer;font-size:18px;
      display:flex;align-items:center;justify-content:center;transition:all .2s;font-weight:700;
    }
    .chatHeaderBtn:hover{background:rgba(255,255,255,.25);transform:scale(1.05)}

    .chatMessages{
      flex:1;overflow-y:auto;padding:16px;
      background:linear-gradient(180deg,rgba(26,29,35,.95) 0%,rgba(16,18,22,.95) 100%);
      display:flex;flex-direction:column;gap:12px;
    }
    .chatMessages::-webkit-scrollbar{width:8px}
    .chatMessages::-webkit-scrollbar-thumb{background:rgba(59,130,246,.3);border-radius:999px}
    .chatMessages::-webkit-scrollbar-track{background:rgba(0,0,0,.2)}

    .message{display:flex;gap:8px;animation:slideIn .3s ease}
    @keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .message.user{flex-direction:row-reverse}
    .messageBubble{
      max-width:85%;padding:12px 16px;border-radius:18px;
      font-size:14px;line-height:1.6;word-wrap:break-word;white-space:pre-line;
    }
    .message.ai .messageBubble{
      background:linear-gradient(135deg,rgba(59,130,246,.85) 0%,rgba(96,165,250,.85) 100%);
      color:#fff;border-bottom-left-radius:4px;
    }
    .message.user .messageBubble{
      background:rgba(255,255,255,.92);color:#1a1d23;border-bottom-right-radius:4px;
    }

    .typingIndicator{
      display:flex;gap:8px;padding:12px 16px;
      background:linear-gradient(135deg,rgba(59,130,246,.85) 0%,rgba(96,165,250,.85) 100%);
      border-radius:18px;border-bottom-left-radius:4px;max-width:75%;
    }
    .typingDot{
      width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.9);
      animation:bounce 1.4s infinite ease-in-out;
    }
    .typingDot:nth-child(1){animation-delay:0s}
    .typingDot:nth-child(2){animation-delay:.2s}
    .typingDot:nth-child(3){animation-delay:.4s}
    @keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}

    .chatInput{
      padding:16px;background:rgba(10,12,18,.95);
      border-top:1px solid var(--line);display:flex;gap:10px;
    }
    .chatInputField{
      flex:1;background:rgba(31,41,55,.6);border:1px solid var(--line);
      border-radius:12px;padding:12px 16px;color:var(--text);font-size:14px;
      outline:none;transition:all .2s;font-family:inherit;
    }
    .chatInputField:focus{border-color:var(--accent);background:rgba(31,41,55,.8)}
    .chatInputField::placeholder{color:var(--muted)}
    .chatSendBtn{
      width:48px;height:48px;border-radius:12px;
      background:linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
      border:none;color:#fff;cursor:pointer;font-size:20px;
      display:flex;align-items:center;justify-content:center;transition:all .2s;
    }
    .chatSendBtn:hover:not(:disabled){transform:scale(1.05);box-shadow:0 4px 16px rgba(59,130,246,.4)}
    .chatSendBtn:disabled{opacity:.5;cursor:not-allowed}

    @media(max-width:980px){
      .layout{grid-template-columns:1fr}
      .newsScroll{max-height:60vh}
      .brand{min-width:unset}
      .venditeListe{grid-template-columns:1fr}
      .venditeCol:first-child{border-right:none;border-bottom:1px solid rgba(31,41,55,.75)}
      .venditeTotali{grid-template-columns:repeat(3,1fr)}
      .chatBox{width:100%;max-width:100%;height:100vh;max-height:100vh;bottom:0;right:0;border-radius:0}
      .chatTrigger{bottom:16px;right:16px;width:60px;height:60px}
    }
    @media(max-width:768px){
      .btn{padding:8px 10px;font-size:13px}
      .brandLogo{width:30px;height:30px}
      .brandName{font-size:16px}
      .centroAutoLogo{height:36px}
      .centroAutoLink{padding:4px 8px}
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="row">
        <div class="brand">
          <div class="brandMark">
            <img class="brandLogo"
              src="https://image2url.com/r2/default/images/1770729951588-711e8f2c-9f48-4ef1-9af3-be4b1f7b5d9f.png"
              alt="AI BOTT logo"/>
            <div>
              <div class="brandName">AI BOTT</div>
              <div class="brandSub">Automotive</div>
            </div>
          </div>
          <button id="fiatBtn"   class="btn brand-fiat">Fiat</button>
          <button id="jeepBtn"   class="btn brand-jeep">Jeep</button>
          <button id="alfaBtn"   class="btn brand-alfa">Alfa Romeo</button>
          <button id="lanciaBtn" class="btn brand-lancia">Lancia</button>
          <a href="https://www.centroautovt.it/" target="_blank" rel="noopener noreferrer" class="centroAutoLink" title="Visita CentroAuto VT">
            <img src="https://image2url.com/r2/default/images/1770805237740-1db65b1e-5553-4b5b-b28a-750e3520a0a2.png" alt="CentroAuto VT" class="centroAutoLogo"/>
          </a>
        </div>
        <div class="row" style="gap:10px">
          <span id="userPill" class="pill muted">Non autenticato</span>
          <button id="loginBtn"  class="btn primary">Login Google</button>
          <button id="logoutBtn" class="btn" style="display:none">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="layout">

      <!-- ===== NEWS A SINISTRA ===== -->
      <aside class="panel">
        <div class="panelHeader">
          <div>
            <div class="panelTitle">üì∞ Ultime News</div>
            <div class="muted panelSub">Visibili solo dopo login.</div>
            <div id="status" class="muted">Effettua il login per caricare le news.</div>
          </div>
          <button id="refreshBtn" class="btn" disabled>üîÑ</button>
        </div>
        <div class="newsScroll">
          <div id="newsList"></div>
        </div>
      </aside>

      <!-- ===== VENDITE A DESTRA ===== -->
      <section style="padding:0;border:none;background:none;">
        <div class="venditePanel">

          <!-- Header + nav mesi -->
          <div class="venditeHeader">
            <div class="venditeTitleRow">
              <div class="venditeTitle">üöó Vendite mensili</div>
              <span id="venditeSyncBadge" class="venditeSyncBadge">Sync ‚Äî</span>
            </div>
            <div class="venditeNav">
              <button class="navArrow" id="vendPrevBtn" title="Mese precedente">&#8249;</button>
              <div class="venditeMonthLabel" id="vendMonthLabel">‚Äî</div>
              <button class="navArrow" id="vendNextBtn" title="Mese successivo">&#8250;</button>
            </div>
          </div>

          <!-- Totali -->
          <div class="venditeTotali">
            <div class="totCard">
              <div class="totLabel">üÜï Nuove</div>
              <div class="totNum nuova" id="totNuove">0</div>
            </div>
            <div class="totCard">
              <div class="totLabel">üîÑ Usate</div>
              <div class="totNum usata" id="totUsate">0</div>
            </div>
            <div class="totCard">
              <div class="totLabel">üì¶ Totale</div>
              <div class="totNum all" id="totAll">0</div>
            </div>
          </div>

          <!-- Form aggiungi auto -->
          <div class="venditeForm">
            <input id="vendModello" type="text" class="fld"
              placeholder="Modello auto (es: Jeep Compass, Ford Focus‚Ä¶)" style="min-width:160px;"/>
            <input id="vendProvv" type="number" class="fld"
              placeholder="Provvigione ‚Ç¨" min="0" step="1"
              style="max-width:140px;min-width:120px;"/>
            <div class="tipoSeg">
              <button class="tipoBtn nuova active" id="tipoBtnNuova">üÜï Nuova</button>
              <button class="tipoBtn usata"        id="tipoBtnUsata">üîÑ Usata</button>
            </div>
            <button id="vendAddBtn" class="btn primary" style="flex-shrink:0;font-weight:700;">+ Aggiungi</button>
          </div>

          <!-- Due colonne: nuove | usate -->
          <div class="venditeListe">
            <div class="venditeCol">
              <div class="venditeColTitle nuova">
                üÜï AUTO NUOVE
                <span class="venditeCount nuova" id="cntNuove">0</span>
              </div>
              <div class="venditeList" id="listNuove"></div>
            </div>
            <div class="venditeCol">
              <div class="venditeColTitle usata">
                üîÑ AUTO USATE
                <span class="venditeCount usata" id="cntUsate">0</span>
              </div>
              <div class="venditeList" id="listUsate"></div>
            </div>
          </div>

          <!-- Totale provvigioni mese corrente visualizzato -->
          <div class="venditeProvvBar">
            <div class="provvMeseGroup">
              <div class="provvMeseLabel">üí∞ Provvigioni del mese</div>
              <div class="provvMeseNum" id="provvMeseTot">‚Ç¨ 0</div>
              <div class="provvMeseSplit" id="provvMeseSplit"></div>
            </div>
          </div>

          <!-- Totale provvigioni anno 2026 -->
          <div class="vendite2026Bar">
            <div class="bar2026Left">
              <div class="bar2026Icon">üèÜ</div>
              <div>
                <div class="bar2026Title">Totale provvigioni 2026</div>
                <div class="bar2026Sub">Somma cumulativa di tutti i mesi</div>
              </div>
            </div>
            <div class="bar2026Right">
              <div class="bar2026Num" id="provv2026Tot">‚Ç¨ 0</div>
              <div class="bar2026Mesi" id="provv2026Mesi">0 mesi con provvigioni</div>
            </div>
          </div>

        </div><!-- /venditePanel -->
      </section>

    </div>
  </main>

  <!-- ===== CHATBOT ===== -->
  <div class="chatTrigger" id="chatTrigger">
    <img src="https://image2url.com/r2/default/images/1770729951588-711e8f2c-9f48-4ef1-9af3-be4b1f7b5d9f.png" alt="AI Agent"/>
  </div>

  <div class="chatBox" id="chatBox">
    <img id="chatMinimizedLogo"
      src="https://image2url.com/r2/default/images/1770729951588-711e8f2c-9f48-4ef1-9af3-be4b1f7b5d9f.png"
      alt="AI Agent"
      style="display:none;width:70px;height:70px;object-fit:contain;cursor:pointer;"/>
    <div class="chatHeader">
      <div class="chatHeaderLeft">
        <img class="chatHeaderLogo"
          src="https://image2url.com/r2/default/images/1770729951588-711e8f2c-9f48-4ef1-9af3-be4b1f7b5d9f.png" alt="AI"/>
        <div>
          <div class="chatHeaderTitle">AI BOTT Assistant</div>
          <div class="chatHeaderSub">Esperto configurazioni</div>
        </div>
      </div>
      <div class="chatHeaderBtns">
        <button class="chatHeaderBtn" id="minimizeBtn" title="Minimizza">‚àí</button>
        <button class="chatHeaderBtn" id="closeBtn"    title="Chiudi">√ó</button>
      </div>
    </div>
    <div class="chatMessages" id="chatMessages">
      <div class="message ai">
        <div class="messageBubble">üëã Ciao! Sono l'assistente AI BOTT specializzato in auto nuove e usate.

üîç Posso aiutarti con:

üÜï AUTO NUOVE (Fiat, Jeep, Alfa, Lancia)
‚Ä¢ Allestimenti e versioni
‚Ä¢ Dotazioni e optional
‚Ä¢ Motorizzazioni e prezzi

üöó AUTO USATE (CentroAuto VT)
‚Ä¢ Ford, Jeep, Kia, Lancia, Land Rover
‚Ä¢ MAN, Mazda, MG, Opel, Peugeot
‚Ä¢ Renault, Seat, Smart, Suzuki, VW
‚Ä¢ Prezzi, km, anno, accessori

Esempi:
"Ford usate disponibili"
"Confronta Compass Longitude e Limited" üí°</div>
      </div>
    </div>
    <div class="chatInput">
      <input type="text" class="chatInputField" id="chatInputField"
        placeholder="Es: auto usate disponibili oppure confronta Compass Longitude e Limited"
        autocomplete="off"/>
      <button class="chatSendBtn" id="chatSendBtn">‚û§</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, setPersistence, browserLocalPersistence, browserSessionPersistence,
      GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult,
      signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, doc, onSnapshot, setDoc, enableIndexedDbPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const BACKEND_NEWS   = "/api/news";
    const BACKEND_CHAT   = "https://auto-backend-three.vercel.app/api/chat";
    const BACKEND_SEARCH = "https://auto-backend-three.vercel.app/api/search";

    const BRAND_LINKS = {
      Fiat:      "https://www.fiat.it/omni/configuratore/#/",
      Jeep:      "https://www.jeep-official.it/omni/configuratore",
      AlfaRomeo: "https://www.alfaromeo.it/omni/configuratore",
      Lancia:    "https://www.lancia.it/omni/configuratore"
    };

    const firebaseConfig = {
      apiKey:            "AIzaSyALsFF_dpL39GlPfMyKBFIKtZi5coOk9I8",
      authDomain:        "auto-1af60.firebaseapp.com",
      projectId:         "auto-1af60",
      storageBucket:     "auto-1af60.firebasestorage.app",
      messagingSenderId: "498320258984",
      appId:             "1:498320258984:web:bac67d7634273d10464f9d",
      measurementId:     "G-WYM78KQWQJ"
    };

    const $ = id => document.getElementById(id);
    const setStatus = t => { $("status").textContent = t; };

    function escapeHtml(s = "") {
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }
    function safeHost(url){ try{ return new URL(url).hostname; } catch{ return ""; } }
    function fmtDate(d){
      if (!d) return "";
      const dt = new Date(d);
      if (Number.isNaN(dt.getTime())) return String(d);
      return dt.toLocaleString("it-IT",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});
    }
    function renderItems(items){
      const box = $("newsList");
      if (!items || !items.length){
        box.innerHTML = '<div class="muted" style="padding:20px;text-align:center">Nessuna news disponibile.</div>';
        setStatus("Nessuna news trovata.");
        return;
      }
      box.innerHTML = items.map(n => {
        const link  = n.url || n.link || "";
        const title = n.title || "Senza titolo";
        const date  = fmtDate(n.date || n.pubDate || "");
        const host  = safeHost(link);
        return `
          <a class="newsItem" href="${escapeHtml(link)}" target="_blank" rel="noopener noreferrer">
            <div class="newsTitle">${escapeHtml(title)}</div>
            ${host ? `<div class="newsMeta">üîó ${escapeHtml(host)}</div>` : ""}
            ${date ? `<div class="newsDate">üïí ${escapeHtml(date)}</div>` : ""}
          </a>`;
      }).join("");
      setStatus(`‚úÖ ${items.length} news caricate ‚Ä¢ ${new Date().toLocaleString("it-IT")}`);
    }

    /* ‚îÄ‚îÄ Firebase ‚îÄ‚îÄ */
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    enableIndexedDbPersistence(db).catch(()=>{});

    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt:"select_account", display:"popup" });

    (async function initApp(){
      try { await setPersistence(auth, browserLocalPersistence); }
      catch { try { await setPersistence(auth, browserSessionPersistence); } catch {} }
      try {
        const r = await getRedirectResult(auth);
        if (r?.user) setStatus("‚úÖ Login riuscito! Benvenuto " + r.user.email);
      } catch(e){ setStatus("‚ùå Errore login: " + (e.code || e.message)); }
    })();

    async function loadNews(){
      const user = auth.currentUser;
      if (!user){ $("newsList").innerHTML = ""; setStatus("üîí Login per vedere le news."); return; }
      setStatus("‚è≥ Caricamento news...");
      $("refreshBtn").disabled = true;
      try {
        const r = await fetch(BACKEND_NEWS, { method:"GET", headers:{"Cache-Control":"no-cache"}, cache:"no-store" });
        if (!r.ok){ const t = await r.text().catch(()=>""); throw new Error(`HTTP ${r.status}${t?" - "+t:""}`); }
        const data = await r.json();
        if (data.items && Array.isArray(data.items)) renderItems(data.items);
        else if (Array.isArray(data)) renderItems(data);
        else throw new Error("Formato dati non valido");
      } catch(err){
        $("newsList").innerHTML = '<div class="muted" style="padding:20px;text-align:center">‚ùå Errore caricamento news</div>';
        setStatus("‚ùå Errore: " + (err?.message || err));
      } finally {
        $("refreshBtn").disabled = !auth.currentUser;
      }
    }

    $("loginBtn").addEventListener("click", async () => {
      try {
        setStatus("üîê Apertura login Google...");
        try {
          const r = await signInWithPopup(auth, provider);
          setStatus("‚úÖ Login riuscito! Benvenuto " + r.user.email);
        } catch(pe){
          if (["auth/popup-blocked","auth/popup-closed-by-user","auth/cancelled-popup-request"].includes(pe.code)){
            setStatus("üîÑ Reindirizzamento in corso...");
            await signInWithRedirect(auth, provider);
          } else { throw pe; }
        }
      } catch(e){
        let msg = "Errore sconosciuto";
        if (e.code === "auth/unauthorized-domain") msg = "Dominio non autorizzato in Firebase Console";
        else if (e.code === "auth/popup-blocked")  msg = "Popup bloccato dal browser";
        else msg = e.code || e.message;
        setStatus("‚ùå " + msg);
      }
    });

    $("logoutBtn").addEventListener("click", async () => {
      try { await signOut(auth); $("newsList").innerHTML = ""; setStatus("üëã Logout effettuato."); }
      catch(e){ setStatus("‚ùå Errore logout: " + (e.code || e.message)); }
    });

    $("refreshBtn").addEventListener("click", loadNews);
    $("fiatBtn").addEventListener("click",   () => window.open(BRAND_LINKS.Fiat,      "_blank","noopener,noreferrer"));
    $("jeepBtn").addEventListener("click",   () => window.open(BRAND_LINKS.Jeep,      "_blank","noopener,noreferrer"));
    $("alfaBtn").addEventListener("click",   () => window.open(BRAND_LINKS.AlfaRomeo, "_blank","noopener,noreferrer"));
    $("lanciaBtn").addEventListener("click", () => window.open(BRAND_LINKS.Lancia,    "_blank","noopener,noreferrer"));

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       VENDITE MENSILI ‚Äî FIRESTORE SYNC
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    // struttura Firestore: users/{uid}/vendite/data
    // { months: { "2025-02": { nuove:[{id,modello,n},...], usate:[...] }, ... } }

    let vendState   = { months: {} };  // stato locale completo
    let vendDocRef  = null;
    let vendUnsub   = null;
    let vendTipo    = "nuova";         // tipo selezionato nel form

    // Mese visualizzato: partiamo dal mese corrente
    const TODAY_KEY = (() => {
      const now = new Date();
      return now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2,"0");
    })();
    let vendViewKey = TODAY_KEY;  // "YYYY-MM"

    /* helpers */
    function monthLabel(k){
      const [y,m] = k.split("-").map(Number);
      const d = new Date(y, m-1, 1);
      const label = d.toLocaleDateString("it-IT",{month:"long",year:"numeric"});
      return label.charAt(0).toUpperCase() + label.slice(1);
    }
    function prevMonthKey(k){
      const [y,m] = k.split("-").map(Number);
      const d = new Date(y, m-2, 1); // m-2 perch√© m √® 1-based
      return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0");
    }
    function nextMonthKey(k){
      const [y,m] = k.split("-").map(Number);
      const d = new Date(y, m, 1);
      return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0");
    }
    function vendUid(){
      return Math.random().toString(16).slice(2) + Date.now().toString(16);
    }
    function ensureMonth(k){
      if (!vendState.months[k]) vendState.months[k] = { nuove:[], usate:[] };
    }

    /* verifica automatica nuovo mese: se esiste il mese corrente, crealo */
    function autoCreateCurrentMonth(){
      ensureMonth(TODAY_KEY);
    }

    /* helper: somma provvigioni di una lista */
    function sumProvv(list){
      return (list || []).reduce((s, c) => s + (Number(c.provv) || 0), 0);
    }

    function fmtEur(n){
      return "‚Ç¨ " + n.toLocaleString("it-IT", { minimumFractionDigits:0, maximumFractionDigits:0 });
    }

    /* Render UI */
    function renderVendite(){
      const k = vendViewKey;
      ensureMonth(k);
      const mese  = vendState.months[k];
      const nuove = mese.nuove || [];
      const usate = mese.usate || [];

      // Etichetta mese + flag "mese corrente"
      const isCurrentMonth = (k === TODAY_KEY);
      $("vendMonthLabel").innerHTML =
        escapeHtml(monthLabel(k)) +
        (isCurrentMonth ? ' <span style="color:#22c55e;font-weight:700;font-size:11px;">‚óè in corso</span>' : "");

      // Freccia "avanti" disabilitata se siamo al mese corrente
      $("vendNextBtn").disabled = (k === TODAY_KEY);

      // Totali auto
      $("totNuove").textContent = nuove.length;
      $("totUsate").textContent = usate.length;
      $("totAll").textContent   = nuove.length + usate.length;
      $("cntNuove").textContent = nuove.length;
      $("cntUsate").textContent = usate.length;

      // Lista nuove
      $("listNuove").innerHTML = nuove.length
        ? nuove.map((c,i) => autoItemHTML(c, i+1, "nuova")).join("")
        : '<div class="emptyList">Nessuna auto nuova</div>';

      // Lista usate
      $("listUsate").innerHTML = usate.length
        ? usate.map((c,i) => autoItemHTML(c, i+1, "usata")).join("")
        : '<div class="emptyList">Nessuna auto usata</div>';

      // Bind bottoni elimina
      document.querySelectorAll(".autoDelBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const id   = btn.dataset.id;
          const tipo = btn.dataset.tipo;
          deleteAuto(k, tipo, id);
        });
      });

      // ‚îÄ‚îÄ Provvigioni mese ‚îÄ‚îÄ
      const pNuove = sumProvv(nuove);
      const pUsate = sumProvv(usate);
      const pTot   = pNuove + pUsate;
      $("provvMeseTot").textContent = fmtEur(pTot);

      // dettaglio split nuove/usate (solo se entrambe > 0)
      if (pNuove > 0 && pUsate > 0){
        $("provvMeseSplit").textContent = `üÜï ${fmtEur(pNuove)}  ¬∑  üîÑ ${fmtEur(pUsate)}`;
      } else if (pNuove > 0){
        $("provvMeseSplit").textContent = `üÜï Tutte da auto nuove`;
      } else if (pUsate > 0){
        $("provvMeseSplit").textContent = `üîÑ Tutte da auto usate`;
      } else {
        $("provvMeseSplit").textContent = "Nessuna provvigione inserita";
      }

      // ‚îÄ‚îÄ Totale 2026 ‚îÄ‚îÄ
      const year2026 = "2026";
      let tot2026  = 0;
      let mesiCon2026 = 0;
      Object.entries(vendState.months).forEach(([mk, mv]) => {
        if (!mk.startsWith(year2026)) return;
        const mP = sumProvv(mv.nuove || []) + sumProvv(mv.usate || []);
        tot2026  += mP;
        if (mP > 0) mesiCon2026++;
      });
      $("provv2026Tot").textContent  = fmtEur(tot2026);
      $("provv2026Mesi").textContent =
        mesiCon2026 === 0 ? "Nessun mese con provvigioni" :
        mesiCon2026 === 1 ? "1 mese con provvigioni" :
        mesiCon2026 + " mesi con provvigioni";
    }

    function autoItemHTML(c, n, tipo){
      const p    = Number(c.provv) || 0;
      const pStr = p > 0 ? "‚Ç¨ " + p.toLocaleString("it-IT") : "‚Äî";
      const cls  = p > 0 ? "autoProvv" : "autoProvv zero";
      return `
        <div class="autoItem">
          <span class="autoN">#${n}</span>
          <span class="autoModello">${escapeHtml(c.modello)}</span>
          <span class="${cls}">${pStr}</span>
          <button class="autoDelBtn" data-id="${escapeHtml(c.id)}" data-tipo="${tipo}" title="Elimina">√ó</button>
        </div>`;
    }

    /* Scrittura Firestore */
    async function vendWrite(){
      if (!vendDocRef) return;
      try { await setDoc(vendDocRef, vendState, { merge:false }); } catch {}
    }

    /* Aggiungi auto */
    async function addAuto(){
      const modello = $("vendModello").value.trim();
      if (!modello) return;
      const provv   = parseFloat($("vendProvv").value) || 0;
      const k = vendViewKey;
      ensureMonth(k);
      const id = vendUid();
      const entry = { id, modello, provv, createdAt: Date.now() };
      if (vendTipo === "nuova") vendState.months[k].nuove.push(entry);
      else                      vendState.months[k].usate.push(entry);
      $("vendModello").value = "";
      $("vendProvv").value   = "";
      renderVendite();
      await vendWrite();
    }

    /* Elimina auto */
    async function deleteAuto(k, tipo, id){
      ensureMonth(k);
      const list = tipo === "nuova" ? vendState.months[k].nuove : vendState.months[k].usate;
      const idx  = list.findIndex(c => c.id === id);
      if (idx !== -1) list.splice(idx, 1);
      renderVendite();
      await vendWrite();
    }

    /* Sync Firestore */
    function startVenditeSync(user){
      if (vendUnsub){ try{ vendUnsub(); } catch{} }
      vendDocRef = doc(db, "users", user.uid, "vendite", "data");
      setSyncVendite("sync");

      vendUnsub = onSnapshot(vendDocRef, snap => {
        if (snap.exists()){
          const data = snap.data();
          vendState = { months: data.months || {} };
        } else {
          vendState = { months: {} };
        }
        autoCreateCurrentMonth();
        setSyncVendite("ok");
        renderVendite();
        // crea documento se non esiste
        if (!snap.exists()) setDoc(vendDocRef, vendState, { merge:false }).catch(()=>{});
      }, () => setSyncVendite("warn"));
    }

    function stopVenditeSync(){
      if (vendUnsub){ try{ vendUnsub(); } catch{} }
      vendUnsub  = null;
      vendDocRef = null;
      vendState  = { months: {} };
      setSyncVendite("warn");
      renderVendite();
    }

    function setSyncVendite(state){
      const b = $("venditeSyncBadge");
      if (state === "ok")  { b.className = "venditeSyncBadge ok"; b.textContent = "Sync ‚úì"; }
      else if (state === "sync") { b.className = "venditeSyncBadge"; b.textContent = "Sync ‚Ä¶"; }
      else                 { b.className = "venditeSyncBadge"; b.textContent = "Sync ‚Äî"; }
    }

    /* Navigazione mesi */
    $("vendPrevBtn").addEventListener("click", () => {
      vendViewKey = prevMonthKey(vendViewKey);
      ensureMonth(vendViewKey);
      renderVendite();
    });
    $("vendNextBtn").addEventListener("click", () => {
      if (vendViewKey === TODAY_KEY) return;
      vendViewKey = nextMonthKey(vendViewKey);
      ensureMonth(vendViewKey);
      renderVendite();
    });

    /* Toggle tipo */
    $("tipoBtnNuova").addEventListener("click", () => {
      vendTipo = "nuova";
      $("tipoBtnNuova").classList.add("active");
      $("tipoBtnUsata").classList.remove("active");
    });
    $("tipoBtnUsata").addEventListener("click", () => {
      vendTipo = "usata";
      $("tipoBtnUsata").classList.add("active");
      $("tipoBtnNuova").classList.remove("active");
    });

    /* Aggiungi */
    $("vendAddBtn").addEventListener("click", addAuto);
    $("vendModello").addEventListener("keypress", e => {
      if (e.key === "Enter"){ e.preventDefault(); addAuto(); }
    });
    $("vendProvv").addEventListener("keypress", e => {
      if (e.key === "Enter"){ e.preventDefault(); addAuto(); }
    });

    /* Render iniziale (offline, mese corrente) */
    autoCreateCurrentMonth();
    renderVendite();

    /* Auto-switch a nuovo mese a mezzanotte */
    (function scheduleMonthCheck(){
      const now  = new Date();
      const next = new Date(now.getFullYear(), now.getMonth()+1, 1, 0, 0, 5); // 1¬∞ del mese prossimo + 5s
      const ms   = next.getTime() - now.getTime();
      setTimeout(() => {
        // Se l'utente sta guardando il mese corrente, spostalo al nuovo
        if (vendViewKey === TODAY_KEY) vendViewKey = nextMonthKey(TODAY_KEY);
        autoCreateCurrentMonth();
        renderVendite();
        scheduleMonthCheck();
      }, Math.max(5000, ms));
    })();

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       AUTH STATE
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    onAuthStateChanged(auth, user => {
      if (user){
        $("userPill").textContent = "‚úÖ " + (user.email || "Utente");
        $("userPill").classList.remove("muted");
        $("userPill").style.borderColor = "rgba(34,197,94,.5)";
        $("userPill").style.background  = "rgba(34,197,94,.1)";
        $("loginBtn").style.display  = "none";
        $("logoutBtn").style.display = "inline-block";
        $("refreshBtn").disabled = false;
        loadNews();
        startVenditeSync(user);
      } else {
        $("userPill").textContent = "üîí Non autenticato";
        $("userPill").classList.add("muted");
        $("userPill").style.borderColor = "";
        $("userPill").style.background  = "";
        $("loginBtn").style.display  = "inline-block";
        $("logoutBtn").style.display = "none";
        $("refreshBtn").disabled = true;
        $("newsList").innerHTML = "";
        setStatus("üîí Effettua il login per caricare le news.");
        stopVenditeSync();
      }
    });

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       CHATBOT
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    let chatHistory = [];
    let isMinimized = false;

    const chatTrigger    = $("chatTrigger");
    const chatBox        = $("chatBox");
    const chatMessages   = $("chatMessages");
    const chatInputField = $("chatInputField");
    const chatSendBtn    = $("chatSendBtn");
    const minimizeBtn    = $("minimizeBtn");
    const closeBtn       = $("closeBtn");

    chatTrigger.addEventListener("click", () => {
      chatBox.classList.add("open");
      chatBox.classList.remove("minimized");
      chatTrigger.style.display = "none";
      $("chatMinimizedLogo").style.display = "none";
      chatInputField.focus();
    });
    minimizeBtn.addEventListener("click", () => {
      chatBox.classList.add("minimized");
      isMinimized = true;
      $("chatMinimizedLogo").style.display = "block";
    });
    closeBtn.addEventListener("click", () => {
      chatBox.classList.remove("open","minimized");
      chatTrigger.style.display = "flex";
    });
    chatBox.querySelector(".chatHeader").addEventListener("click", e => {
      if (isMinimized && !e.target.closest("button")){
        chatBox.classList.remove("minimized");
        isMinimized = false;
        $("chatMinimizedLogo").style.display = "none";
      }
    });
    $("chatMinimizedLogo").addEventListener("click", () => {
      chatBox.classList.remove("minimized");
      isMinimized = false;
      $("chatMinimizedLogo").style.display = "none";
      chatInputField.focus();
    });

    function addMessage(text, sender){
      const div = document.createElement("div");
      div.className = `message ${sender}`;
      const content = sender === "ai" ? text : escapeHtml(text);
      div.innerHTML = `<div class="messageBubble">${content}</div>`;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    function showTyping(){
      const d = document.createElement("div");
      d.className = "message ai"; d.id = "typingIndicator";
      d.innerHTML = `<div class="typingIndicator"><div class="typingDot"></div><div class="typingDot"></div><div class="typingDot"></div></div>`;
      chatMessages.appendChild(d);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    function hideTyping(){ const t = $("typingIndicator"); if(t) t.remove(); }

    function needsSearch(text){
      const kw = [
        'prezzo','costo','quanto costa','listino','allestimento','versione','dotazione',
        'equipaggiamento','optional','serie','motore','motorizzazione','cavalli','cv','kw',
        'consumi','autonomia','emissioni','dimensioni','bagagliaio','colori','tinta',
        'caratteristiche','scheda tecnica','confronto','differenza','meglio','vs',
        'ibrida','elettrica','plug-in','mild hybrid','diesel','benzina','gpl','metano',
        'trazione','integrale','4x4','cambio','automatico','manuale',
        'garanzia','manutenzione','tagliando',
        'panda','punto','500','tipo','ducato',
        'renegade','compass','wrangler','cherokee','avenger',
        'giulia','stelvio','tonale','giulietta','ypsilon','delta',
        'usato','usata','usati','usate','seconda mano','km zero',
        'centroauto','occasione','pronta consegna',
        'ford','kia','lancia','land rover','man','mazda','mg','opel','peugeot',
        'renault','seat','smart','suzuki','volkswagen','audi','bmw','mercedes',
        'volvo','toyota','honda','nissan','hyundai','citroen','dacia','skoda','mini',
        'focus','fiesta','kuga','sportage','picanto','defender','discovery',
        'corsa','astra','mokka','208','308','2008','3008','clio','captur','megane',
        'ibiza','leon','vitara','swift','golf','polo','tiguan'
      ];
      const low = text.toLowerCase();
      return kw.some(k => low.includes(k));
    }

    async function searchCarInfo(query){
      try {
        const low = query.toLowerCase();
        const usedBrands = ['ford','jeep','kia','lancia','land rover','man','mazda','mg',
          'opel','peugeot','renault','seat','smart','suzuki','volkswagen','audi','bmw',
          'mercedes','volvo','toyota','honda','nissan','hyundai','citroen','dacia','skoda','mini'];
        const isUsed = ['usato','usata','usati','usate','seconda mano','km zero','centroauto','occasione']
          .some(k => low.includes(k)) || usedBrands.some(b => low.includes(b));

        let enhancedQuery, allowedDomains;
        if (isUsed){
          const mb = usedBrands.find(b => low.includes(b));
          enhancedQuery = `${mb?mb+" ":""}${query} site:centroautovt.it/ricerca-auto/usate`;
          allowedDomains = ['centroautovt.it'];
        } else {
          enhancedQuery = `${query} allestimenti versioni site:fiat.it OR site:jeep-official.it OR site:alfaromeo.it OR site:lancia.it`;
          allowedDomains = ['fiat.it','jeep-official.it','alfaromeo.it','lancia.it'];
        }
        const r = await fetch(`${BACKEND_SEARCH}?q=${encodeURIComponent(enhancedQuery)}`);
        if (!r.ok) throw new Error("Errore ricerca");
        const data = await r.json();
        if (data.results && data.results.length){
          const valid = data.results.filter(r => allowedDomains.some(d => r.url.toLowerCase().includes(d)));
          if (!valid.length) return null;
          if (isUsed) return valid.slice(0,6).map(r => `üöó ${r.title}\n${r.description}\nüîó ${r.url}`).join("\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n");
          return valid.slice(0,3).map(r => {
            const b = r.url.includes('fiat')?'Fiat':r.url.includes('jeep')?'Jeep':r.url.includes('alfa')?'Alfa Romeo':'Lancia';
            return `‚îÅ‚îÅ‚îÅ ${b.toUpperCase()} ‚îÅ‚îÅ‚îÅ\n${r.title}\n\n${r.description}\n\nüîó ${r.url}`;
          }).join("\n\n");
        }
        return null;
      } catch { return null; }
    }

    const SYSTEM_PROMPT = `Sei un assistente esperto di auto NUOVE e USATE.
AUTO NUOVE: Fiat, Jeep, Alfa Romeo, Lancia (configuratori ufficiali)
AUTO USATE: CentroAuto VT (https://www.centroautovt.it/)
üìã Risposte SCHEMATICHE e CONCISE (max 10 righe), usa elenchi puntati, solo INFO ESSENZIALI.
‚ö†Ô∏è NO informazioni generiche, S√å a dati concreti e verificabili.`;

    async function sendMessage(){
      const msg = chatInputField.value.trim();
      if (!msg) return;
      addMessage(msg, "user");
      chatInputField.value = "";
      chatSendBtn.disabled = true;
      chatHistory.push({ role:"user", content:msg });
      showTyping();
      try {
        let searchResults = needsSearch(msg) ? await searchCarInfo(msg) : null;
        const messages = [{ role:"system", content:SYSTEM_PROMPT }, ...chatHistory];
        if (searchResults) messages.push({ role:"system", content:`DATI UFFICIALI:\n\n${searchResults}\n\nRispondi usando SOLO questi dati in formato schematico.` });
        const r = await fetch(BACKEND_CHAT, {
          method:"POST", headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ messages })
        });
        if (!r.ok) throw new Error(`Errore ${r.status}`);
        const data = await r.json();
        hideTyping();
        let ai = data.choices?.[0]?.message?.content || "Scusa, non ho capito.";
        ai = ai.replace(/[&<>"']/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]));
        addMessage(ai, "ai");
        chatHistory.push({ role:"assistant", content:ai });
      } catch(err){
        hideTyping();
        addMessage("‚ùå Errore di connessione. Riprova tra poco.", "ai");
      } finally {
        chatSendBtn.disabled = false;
        chatInputField.focus();
      }
    }

    chatSendBtn.addEventListener("click", sendMessage);
    chatInputField.addEventListener("keypress", e => {
      if (e.key === "Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); }
    });
  </script>
</body>
</html>
