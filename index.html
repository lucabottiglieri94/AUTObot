<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI BOTT Automotive</title>

  <style>
    :root{
      --bgTop:#07080b;
      --bgMid:#101216;
      --bgBot:#1a1d23;

      --panel: rgba(17,24,39,.78);
      --line:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#3b82f6;
      --accent2:#60a5fa;
    }

    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(1200px 700px at 18% -12%, rgba(59,130,246,.22), transparent 58%),
        radial-gradient(900px 520px at 72% 8%, rgba(96,165,250,.14), transparent 60%),
        linear-gradient(180deg, var(--bgTop) 0%, var(--bgMid) 48%, var(--bgBot) 100%);
    }

    header{
      position:sticky;
      top:0;
      z-index:10;
      background:rgba(10,10,12,.72);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
    }

    .wrap{max-width:1200px;margin:0 auto;padding:16px}

    .row{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
      min-width: 320px;
    }

    .brandMark{
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .brandLogo{
      width:4cm;
      height:4cm;
      object-fit:contain;
      background:transparent;
      border:none;
      outline:none;
      filter:none;
      mix-blend-mode: screen;
    }

    .brandName{
      font-weight:950;
      letter-spacing:.2px;
      font-size:18px;
      line-height:1;
      background:linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      white-space:nowrap;
    }
    .brandSub{
      opacity:.75;
      white-space:nowrap;
    }

    .btn{
      border:1px solid var(--line);
      background:rgba(17,24,39,.75);
      color:var(--text);
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-size:14px;
      transition:all .2s;
      font-weight:650;
    }
    .btn:hover{
      border-color:rgba(59,130,246,.6);
      background:rgba(17,24,39,.92);
      transform:translateY(-1px);
    }
    .btn.primary{
      border-color:rgba(59,130,246,.55);
      background:rgba(37,99,235,.16);
    }
    .btn.primary:hover{background:rgba(37,99,235,.26)}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}

    .btn.brand-fiat:hover{border-color:rgba(220,38,38,.6);background:rgba(220,38,38,.1)}
    .btn.brand-jeep:hover{border-color:rgba(34,197,94,.6);background:rgba(34,197,94,.1)}
    .btn.brand-alfa:hover{border-color:rgba(239,68,68,.6);background:rgba(239,68,68,.1)}
    .btn.brand-lancia:hover{border-color:rgba(59,130,246,.6);background:rgba(59,130,246,.1)}

    .centroAutoLink{
      display:inline-flex;
      align-items:center;
      padding:6px 12px;
      border:2px solid rgba(34,197,94,.4);
      background:rgba(34,197,94,.08);
      border-radius:12px;
      transition:all .3s ease;
      text-decoration:none;
      box-shadow:0 2px 8px rgba(34,197,94,.15);
    }
    .centroAutoLink:hover{
      border-color:rgba(34,197,94,.7);
      background:rgba(34,197,94,.18);
      transform:translateY(-2px);
      box-shadow:0 4px 16px rgba(34,197,94,.3);
    }
    .centroAutoLogo{
      height:42px;
      width:auto;
      object-fit:contain;
      filter:drop-shadow(0 1px 3px rgba(0,0,0,.2));
    }

    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(17,24,39,.35);
      font-size:12px;
      white-space:nowrap;
    }
    .muted{color:var(--muted)}

    .layout{
      margin-top:16px;
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
      align-items:start;
    }

    .panel{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
    }

    .panelHeader{
      padding:14px 14px 10px 14px;
      border-bottom:1px solid rgba(31,41,55,.75);
      background:rgba(10,12,18,.35);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }

    .panelTitle{font-weight:950;font-size:18px}
    .panelSub{margin-top:6px}

    .newsScroll{
      max-height: calc(100vh - 140px);
      overflow:auto;
      padding:12px;
    }

    .newsScroll::-webkit-scrollbar{width:10px}
    .newsScroll::-webkit-scrollbar-thumb{
      background:rgba(59,130,246,.25);
      border:2px solid rgba(17,24,39,.7);
      border-radius:999px;
    }
    .newsScroll::-webkit-scrollbar-track{background:rgba(0,0,0,.12)}

    #status{margin:10px 0 0 0}
    #newsList{display:grid;gap:12px}

    .newsItem{
      display:block;
      padding:14px;
      border:1px solid var(--line);
      border-radius:14px;
      text-decoration:none;
      color:inherit;
      background:rgba(17,24,39,.35);
      transition:all .2s;
    }
    .newsItem:hover{
      border-color:rgba(59,130,246,.6);
      background:rgba(17,24,39,.55);
      transform:translateX(4px);
    }
    .newsTitle{font-weight:850;margin-bottom:8px}
    .newsMeta{opacity:.75;font-size:12px;margin-top:6px}
    .newsDate{opacity:.75;font-size:12px;margin-top:6px;font-style:italic}

    .rightSpace{
      padding:18px;
      border:1px dashed rgba(31,41,55,.7);
      border-radius:16px;
      background:rgba(0,0,0,.12);
    }

    /* ========== CHATBOT STYLES ========== */
    
    .chatTrigger{
      position:fixed;
      bottom:24px;
      right:24px;
      width:70px;
      height:70px;
      border-radius:50%;
      background:transparent;
      border:none;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 8px 24px rgba(0,0,0,.3);
      transition:all .3s ease;
      z-index:1000;
    }
    .chatTrigger:hover{
      transform:scale(1.1);
      box-shadow:0 12px 32px rgba(0,0,0,.5);
    }
    .chatTrigger img{
      width:70px;
      height:70px;
      object-fit:contain;
    }

    .chatBox{
      position:fixed;
      bottom:24px;
      right:24px;
      width:420px;
      max-width:calc(100vw - 32px);
      height:600px;
      max-height:calc(100vh - 48px);
      background:rgba(17,24,39,.95);
      border:1px solid var(--line);
      border-radius:20px;
      display:none;
      flex-direction:column;
      box-shadow:0 20px 60px rgba(0,0,0,.6);
      z-index:1001;
      overflow:hidden;
      backdrop-filter:blur(20px);
    }
    .chatBox.open{display:flex}
    .chatBox.minimized{
      width:70px;
      height:70px;
      background:transparent;
      border:none;
      border-radius:50%;
      box-shadow:0 8px 24px rgba(0,0,0,.3);
    }
    .chatBox.minimized .chatHeader,
    .chatBox.minimized .chatMessages,
    .chatBox.minimized .chatInput{
      display:none;
    }

    .chatHeader{
      background:linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.15);
    }
    .chatHeaderLeft{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .chatHeaderLogo{
      width:38px;
      height:38px;
      border-radius:50%;
      background:rgba(255,255,255,.15);
      padding:4px;
    }
    .chatHeaderTitle{
      font-weight:700;
      font-size:16px;
      color:#fff;
    }
    .chatHeaderSub{
      font-size:11px;
      color:rgba(255,255,255,.75);
      margin-top:2px;
    }
    .chatHeaderBtns{
      display:flex;
      gap:8px;
    }
    .chatHeaderBtn{
      width:32px;
      height:32px;
      border-radius:8px;
      background:rgba(255,255,255,.15);
      border:none;
      color:#fff;
      cursor:pointer;
      font-size:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all .2s;
      font-weight:700;
    }
    .chatHeaderBtn:hover{
      background:rgba(255,255,255,.25);
      transform:scale(1.05);
    }

    .chatMessages{
      flex:1;
      overflow-y:auto;
      padding:16px;
      background:linear-gradient(180deg, 
        rgba(26,29,35,.95) 0%, 
        rgba(16,18,22,.95) 100%);
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .chatMessages::-webkit-scrollbar{width:8px}
    .chatMessages::-webkit-scrollbar-thumb{
      background:rgba(59,130,246,.3);
      border-radius:999px;
    }
    .chatMessages::-webkit-scrollbar-track{background:rgba(0,0,0,.2)}

    .message{
      display:flex;
      gap:8px;
      animation:slideIn .3s ease;
    }
    @keyframes slideIn{
      from{opacity:0;transform:translateY(10px)}
      to{opacity:1;transform:translateY(0)}
    }

    .message.user{
      flex-direction:row-reverse;
    }
    .messageBubble{
      max-width:85%;
      padding:12px 16px;
      border-radius:18px;
      font-size:14px;
      line-height:1.6;
      word-wrap:break-word;
      white-space:pre-line;
    }
    .message.ai .messageBubble{
      background:linear-gradient(135deg, rgba(59,130,246,.85) 0%, rgba(96,165,250,.85) 100%);
      color:#fff;
      border-bottom-left-radius:4px;
    }
    .message.user .messageBubble{
      background:rgba(255,255,255,.92);
      color:#1a1d23;
      border-bottom-right-radius:4px;
    }

    .typingIndicator{
      display:flex;
      gap:8px;
      padding:12px 16px;
      background:linear-gradient(135deg, rgba(59,130,246,.85) 0%, rgba(96,165,250,.85) 100%);
      border-radius:18px;
      border-bottom-left-radius:4px;
      max-width:75%;
    }
    .typingDot{
      width:8px;
      height:8px;
      border-radius:50%;
      background:rgba(255,255,255,.9);
      animation:bounce 1.4s infinite ease-in-out;
    }
    .typingDot:nth-child(1){animation-delay:0s}
    .typingDot:nth-child(2){animation-delay:.2s}
    .typingDot:nth-child(3){animation-delay:.4s}
    @keyframes bounce{
      0%,80%,100%{transform:scale(0)}
      40%{transform:scale(1)}
    }

    .chatInput{
      padding:16px;
      background:rgba(10,12,18,.95);
      border-top:1px solid var(--line);
      display:flex;
      gap:10px;
    }
    .chatInputField{
      flex:1;
      background:rgba(31,41,55,.6);
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px 16px;
      color:var(--text);
      font-size:14px;
      outline:none;
      transition:all .2s;
      font-family:inherit;
    }
    .chatInputField:focus{
      border-color:var(--accent);
      background:rgba(31,41,55,.8);
    }
    .chatInputField::placeholder{
      color:var(--muted);
    }
    .chatSendBtn{
      width:48px;
      height:48px;
      border-radius:12px;
      background:linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
      border:none;
      color:#fff;
      cursor:pointer;
      font-size:20px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all .2s;
    }
    .chatSendBtn:hover:not(:disabled){
      transform:scale(1.05);
      box-shadow:0 4px 16px rgba(59,130,246,.4);
    }
    .chatSendBtn:disabled{
      opacity:.5;
      cursor:not-allowed;
    }

    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
      .newsScroll{max-height: 60vh}
      .brand{min-width: unset}
      .chatBox{
        width:100%;
        max-width:100%;
        height:100vh;
        max-height:100vh;
        bottom:0;
        right:0;
        border-radius:0;
      }
      .chatTrigger{
        bottom:16px;
        right:16px;
        width:60px;
        height:60px;
      }
    }

    @media (max-width: 768px){
      .btn{padding:8px 10px;font-size:13px}
      .brandLogo{width:30px;height:30px}
      .brandName{font-size:16px}
      .centroAutoLogo{height:36px}
      .centroAutoLink{padding:4px 8px}
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="row">
        <div class="brand">
          <div class="brandMark">
            <img
              class="brandLogo"
              src="https://image2url.com/r2/default/images/1770729951588-711e8f2c-9f48-4ef1-9af3-be4b1f7b5d9f.png"
              alt="AI BOTT logo"
            />
            <div>
              <div class="brandName">AI BOTT</div>
              <div class="brandSub">Automotive</div>
            </div>
          </div>

          <button id="fiatBtn" class="btn brand-fiat">Fiat</button>
          <button id="jeepBtn" class="btn brand-jeep">Jeep</button>
          <button id="alfaBtn" class="btn brand-alfa">Alfa Romeo</button>
          <button id="lanciaBtn" class="btn brand-lancia">Lancia</button>
          
          <a 
            href="https://www.centroautovt.it/" 
            target="_blank" 
            rel="noopener noreferrer"
            class="centroAutoLink"
            title="Visita CentroAuto VT"
          >
            <img 
              src="https://image2url.com/r2/default/images/1770805237740-1db65b1e-5553-4b5b-b28a-750e3520a0a2.png" 
              alt="CentroAuto VT" 
              class="centroAutoLogo"
            />
          </a>
        </div>

        <div class="row" style="gap:10px">
          <span id="userPill" class="pill muted">Non autenticato</span>
          <button id="loginBtn" class="btn primary">Login Google</button>
          <button id="logoutBtn" class="btn" style="display:none">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="layout">
      <aside class="panel">
        <div class="panelHeader">
          <div>
            <div class="panelTitle">üì∞ Ultime News</div>
            <div class="muted panelSub">Visibili solo dopo login.</div>
            <div id="status" class="muted">Effettua il login per caricare le news.</div>
          </div>
          <button id="refreshBtn" class="btn" disabled>üîÑ</button>
        </div>

        <div class="newsScroll">
          <div id="newsList"></div>
        </div>
      </aside>

      <section class="rightSpace">
        <div style="font-weight:950;font-size:18px">Area contenuti</div>
        <div class="muted" style="margin-top:8px;line-height:1.45">
          Qui puoi mettere descrizione, KPI, link rapidi o altri contenuti.
        </div>
      </section>
    </div>
  </main>

  <!-- ========== CHATBOT UI ========== -->
  
  <div class="chatTrigger" id="chatTrigger">
    <img 
      src="https://image2url.com/r2/default/images/1770729951588-711e8f2c-9f48-4ef1-9af3-be4b1f7b5d9f.png" 
      alt="AI Agent"
    />
  </div>

  <div class="chatBox" id="chatBox">
    <img 
      id="chatMinimizedLogo"
      src="https://image2url.com/r2/default/images/1770729951588-711e8f2c-9f48-4ef1-9af3-be4b1f7b5d9f.png" 
      alt="AI Agent"
      style="display:none; width:70px; height:70px; object-fit:contain; cursor:pointer;"
    />
    
    <div class="chatHeader">
      <div class="chatHeaderLeft">
        <img 
          class="chatHeaderLogo" 
          src="https://image2url.com/r2/default/images/1770729951588-711e8f2c-9f48-4ef1-9af3-be4b1f7b5d9f.png" 
          alt="AI"
        />
        <div>
          <div class="chatHeaderTitle">AI BOTT Assistant</div>
          <div class="chatHeaderSub">Esperto auto nuove e usate</div>
        </div>
      </div>
      <div class="chatHeaderBtns">
        <button class="chatHeaderBtn" id="minimizeBtn" title="Minimizza">‚àí</button>
        <button class="chatHeaderBtn" id="closeBtn" title="Chiudi">√ó</button>
      </div>
    </div>

    <div class="chatMessages" id="chatMessages">
      <div class="message ai">
        <div class="messageBubble">üëã Ciao! Sono l'assistente AI BOTT specializzato in auto nuove e usate.

üîç Posso aiutarti con:

üÜï AUTO NUOVE (Fiat, Jeep, Alfa, Lancia)
‚Ä¢ Allestimenti e versioni
‚Ä¢ Dotazioni e optional
‚Ä¢ Motorizzazioni e prezzi

üöó AUTO USATE (CentroAuto VT - DATABASE REALE)
‚Ä¢ Modelli con targhe, km, colori REALI
‚Ä¢ Ford, Jeep, Kia, Lancia, Land Rover
‚Ä¢ MAN, Mazda, MG, Opel, Peugeot
‚Ä¢ Renault, Seat, Smart, Suzuki, VW

Esempi:
"MG ZS usate disponibili"
"Tutte le Ford usate"
"Confronta Compass Longitude e Limited" üí°</div>
      </div>
    </div>

    <div class="chatInput">
      <input 
        type="text" 
        class="chatInputField" 
        id="chatInputField" 
        placeholder="Es: MG ZS usate con tutti i dettagli"
        autocomplete="off"
      />
      <button class="chatSendBtn" id="chatSendBtn">
        ‚û§
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth,
      setPersistence,
      browserLocalPersistence,
      browserSessionPersistence,
      GoogleAuthProvider,
      signInWithPopup,
      signInWithRedirect,
      getRedirectResult,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    // ========== CONFIGURAZIONE BACKEND ==========
    const BACKEND_BASE = "http://localhost:3000"; // üîß CAMBIA CON IL TUO URL VERCEL
    const BACKEND_NEWS = "/api/news";
    const BACKEND_CHAT = "https://auto-backend-three.vercel.app/api/chat";
    const BACKEND_USED_CARS = `${BACKEND_BASE}/api/search-used-cars`;

    const BRAND_LINKS = {
      Fiat: "https://www.fiat.it/omni/configuratore/#/",
      Jeep: "https://www.jeep-official.it/omni/configuratore",
      AlfaRomeo: "https://www.alfaromeo.it/omni/configuratore",
      Lancia: "https://www.lancia.it/omni/configuratore"
    };

    const firebaseConfig = {
      apiKey: "AIzaSyALsFF_dpL39GlPfMyKBFIKtZi5coOk9I8",
      authDomain: "auto-1af60.firebaseapp.com",
      projectId: "auto-1af60",
      storageBucket: "auto-1af60.firebasestorage.app",
      messagingSenderId: "498320258984",
      appId: "1:498320258984:web:bac67d7634273d10464f9d",
      measurementId: "G-WYM78KQWQJ"
    };

    const $ = (id) => document.getElementById(id);
    const setStatus = (t) => { $("status").textContent = t; };

    function escapeHtml(s = "") {
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function safeHost(url) {
      try { return new URL(url).hostname; } catch { return ""; }
    }

    function fmtDate(d) {
      if (!d) return "";
      const dt = new Date(d);
      if (Number.isNaN(dt.getTime())) return String(d);
      return dt.toLocaleString("it-IT", {
        day:"2-digit", month:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit"
      });
    }

    function renderItems(items) {
      const box = $("newsList");
      if (!items || !items.length) {
        box.innerHTML = '<div class="muted" style="padding:20px;text-align:center">Nessuna news disponibile.</div>';
        setStatus("Nessuna news trovata.");
        return;
      }

      box.innerHTML = items.map(n => {
        const link = n.url || n.link || "";
        const title = n.title || "Senza titolo";
        const date = fmtDate(n.date || n.pubDate || "");
        const host = safeHost(link);

        return `
          <a class="newsItem" href="${escapeHtml(link)}" target="_blank" rel="noopener noreferrer">
            <div class="newsTitle">${escapeHtml(title)}</div>
            ${host ? `<div class="newsMeta">üîó ${escapeHtml(host)}</div>` : ""}
            ${date ? `<div class="newsDate">üïê ${escapeHtml(date)}</div>` : ""}
          </a>
        `;
      }).join("");

      setStatus(`‚úÖ ${items.length} news caricate ‚Ä¢ ${new Date().toLocaleString("it-IT")}`);
    }

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt:"select_account", display:"popup" });

    (async function initApp(){
      try { await setPersistence(auth, browserLocalPersistence); }
      catch {
        try { await setPersistence(auth, browserSessionPersistence); } catch {}
      }

      try{
        const result = await getRedirectResult(auth);
        if (result?.user) setStatus("‚úÖ Login riuscito! Benvenuto " + result.user.email);
      }catch(e){
        setStatus("‚ùå Errore login: " + (e.code || e.message));
      }
    })();

    async function loadNews() {
      const user = auth.currentUser;
      if (!user) {
        $("newsList").innerHTML = "";
        setStatus("üîí Effettua il login per vedere le news.");
        return;
      }

      setStatus("‚è≥ Caricamento news...");
      $("refreshBtn").disabled = true;

      try {
        const response = await fetch(BACKEND_NEWS, {
          method:"GET",
          headers:{ "Cache-Control":"no-cache" },
          cache:"no-store"
        });

        if (!response.ok) {
          const errorText = await response.text().catch(() => "");
          throw new Error(`HTTP ${response.status}${errorText ? " - " + errorText : ""}`);
        }

        const data = await response.json();

        if (data.items && Array.isArray(data.items)) renderItems(data.items);
        else if (Array.isArray(data)) renderItems(data);
        else throw new Error("Formato dati non valido");
      } catch (err) {
        $("newsList").innerHTML = '<div class="muted" style="padding:20px;text-align:center">‚ùå Errore caricamento news</div>';
        setStatus("‚ùå Errore: " + (err?.message || err));
      } finally {
        $("refreshBtn").disabled = !auth.currentUser;
      }
    }

    $("loginBtn").addEventListener("click", async () => {
      try {
        setStatus("üîê Apertura login Google...");

        try {
          const result = await signInWithPopup(auth, provider);
          setStatus("‚úÖ Login riuscito! Benvenuto " + result.user.email);
        } catch (popupError) {
          if (popupError.code === "auth/popup-blocked" ||
              popupError.code === "auth/popup-closed-by-user" ||
              popupError.code === "auth/cancelled-popup-request") {
            setStatus("üîÑ Reindirizzamento in corso...");
            await signInWithRedirect(auth, provider);
          } else {
            throw popupError;
          }
        }
      } catch (e) {
        let errorMsg = "Errore sconosciuto";
        if (e.code === "auth/unauthorized-domain") errorMsg = "Dominio non autorizzato in Firebase Console";
        else if (e.code === "auth/popup-blocked") errorMsg = "Popup bloccato dal browser";
        else errorMsg = e.code || e.message;
        setStatus("‚ùå " + errorMsg);
      }
    });

    $("logoutBtn").addEventListener("click", async () => {
      try {
        await signOut(auth);
        $("newsList").innerHTML = "";
        setStatus("üëã Logout effettuato.");
      } catch (e) {
        setStatus("‚ùå Errore logout: " + (e.code || e.message));
      }
    });

    $("refreshBtn").addEventListener("click", loadNews);

    $("fiatBtn").addEventListener("click", () => window.open(BRAND_LINKS.Fiat, "_blank", "noopener,noreferrer"));
    $("jeepBtn").addEventListener("click", () => window.open(BRAND_LINKS.Jeep, "_blank", "noopener,noreferrer"));
    $("alfaBtn").addEventListener("click", () => window.open(BRAND_LINKS.AlfaRomeo, "_blank", "noopener,noreferrer"));
    $("lanciaBtn").addEventListener("click", () => window.open(BRAND_LINKS.Lancia, "_blank", "noopener,noreferrer"));

    onAuthStateChanged(auth, (user) => {
      if (user) {
        $("userPill").textContent = "‚úÖ " + (user.email || "Utente");
        $("userPill").classList.remove("muted");
        $("userPill").style.borderColor = "rgba(34,197,94,.5)";
        $("userPill").style.background = "rgba(34,197,94,.1)";

        $("loginBtn").style.display = "none";
        $("logoutBtn").style.display = "inline-block";
        $("refreshBtn").disabled = false;

        loadNews();
      } else {
        $("userPill").textContent = "üîí Non autenticato";
        $("userPill").classList.add("muted");
        $("userPill").style.borderColor = "";
        $("userPill").style.background = "";

        $("loginBtn").style.display = "inline-block";
        $("logoutBtn").style.display = "none";
        $("refreshBtn").disabled = true;

        $("newsList").innerHTML = "";
        setStatus("üîí Effettua il login per caricare le news.");
      }
    });

    // ========== CHATBOT LOGIC - CON DATABASE REALE ========== 
    
    let chatHistory = [];
    let isMinimized = false;

    const chatTrigger = $("chatTrigger");
    const chatBox = $("chatBox");
    const chatMessages = $("chatMessages");
    const chatInputField = $("chatInputField");
    const chatSendBtn = $("chatSendBtn");
    const minimizeBtn = $("minimizeBtn");
    const closeBtn = $("closeBtn");

    chatTrigger.addEventListener("click", () => {
      chatBox.classList.add("open");
      chatBox.classList.remove("minimized");
      chatTrigger.style.display = "none";
      $("chatMinimizedLogo").style.display = "none";
      chatInputField.focus();
    });

    minimizeBtn.addEventListener("click", () => {
      chatBox.classList.add("minimized");
      isMinimized = true;
      $("chatMinimizedLogo").style.display = "block";
    });

    closeBtn.addEventListener("click", () => {
      chatBox.classList.remove("open");
      chatBox.classList.remove("minimized");
      chatTrigger.style.display = "flex";
    });

    chatBox.querySelector(".chatHeader").addEventListener("click", (e) => {
      if (isMinimized && !e.target.closest("button")) {
        chatBox.classList.remove("minimized");
        isMinimized = false;
        $("chatMinimizedLogo").style.display = "none";
      }
    });

    $("chatMinimizedLogo").addEventListener("click", () => {
      chatBox.classList.remove("minimized");
      isMinimized = false;
      $("chatMinimizedLogo").style.display = "none";
      chatInputField.focus();
    });

    function addMessage(text, sender) {
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${sender}`;
      
      const content = sender === 'ai' ? text : escapeHtml(text);
      
      messageDiv.innerHTML = `
        <div class="messageBubble">${content}</div>
      `;
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function showTyping() {
      const typingDiv = document.createElement("div");
      typingDiv.className = "message ai";
      typingDiv.id = "typingIndicator";
      typingDiv.innerHTML = `
        <div class="typingIndicator">
          <div class="typingDot"></div>
          <div class="typingDot"></div>
          <div class="typingDot"></div>
        </div>
      `;
      chatMessages.appendChild(typingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function hideTyping() {
      const typing = $("typingIndicator");
      if (typing) typing.remove();
    }

    // Verifica se la domanda riguarda auto USATE
    function isUsedCarQuery(text) {
      const lowerText = text.toLowerCase();
      const usedKeywords = [
        'usato', 'usata', 'usati', 'usate', 'seconda mano', 'km zero',
        'centroauto', 'centro auto', 'stock', 'disponibile',
        'ford', 'mazda', 'kia', 'peugeot', 'renault', 'opel', 
        'volkswagen', 'mg', 'seat', 'smart', 'suzuki', 'land rover'
      ];
      
      return usedKeywords.some(keyword => lowerText.includes(keyword));
    }

    // RICERCA NEL DATABASE AUTO USATE
    async function searchUsedCars(query) {
      try {
        console.log('üîç Cercando auto usate nel database:', query);
        
        const response = await fetch(BACKEND_USED_CARS, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query })
        });

        if (!response.ok) {
          throw new Error(`Errore ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success && data.cars && data.cars.length > 0) {
          console.log(`‚úÖ Trovate ${data.cars.length} auto nel database`);
          
          // Formatta i risultati in modo dettagliato
          return data.cars.map(car => {
            let carInfo = `‚îÅ‚îÅ‚îÅ ${car.brand} ${car.model} ‚îÅ‚îÅ‚îÅ\n`;
            if (car.price) carInfo += `üí∞ Prezzo: ${car.price}\n`;
            if (car.year) carInfo += `üìÖ Anno: ${car.year}\n`;
            if (car.km) carInfo += `üõ£Ô∏è Km: ${car.km}\n`;
            if (car.fuel) carInfo += `‚õΩ Carburante: ${car.fuel}\n`;
            if (car.transmission) carInfo += `‚öôÔ∏è Cambio: ${car.transmission}\n`;
            if (car.hp) carInfo += `üèéÔ∏è Potenza: ${car.hp}\n`;
            if (car.color) carInfo += `üé® Colore: ${car.color}\n`;
            if (car.bodyType) carInfo += `üöó Tipo: ${car.bodyType}\n`;
            if (car.doors) carInfo += `üö™ Porte: ${car.doors}\n`;
            
            // Aggiungi fino a 3 features principali
            if (car.features && car.features.length > 0) {
              const topFeatures = car.features.slice(0, 3);
              carInfo += `üéØ Accessori: ${topFeatures.join(', ')}\n`;
            }
            
            if (car.url) carInfo += `üîó Link: ${car.url}\n`;
            
            return carInfo;
          }).join('\n');
        }
        
        console.log('‚ö†Ô∏è Nessuna auto trovata nel database');
        return null;
      } catch (error) {
        console.error('‚ùå Errore ricerca database:', error);
        return null;
      }
    }

    // SISTEMA PROMPT AGGIORNATO
    const SYSTEM_PROMPT = `Sei un assistente esperto di auto NUOVE e USATE con DATABASE REALE.

AUTO NUOVE: Fiat, Jeep, Alfa Romeo, Lancia (configuratori ufficiali)
AUTO USATE: Database CentroAuto VT con dati REALI (targhe, km, colori, accessori)

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìã REGOLE FONDAMENTALI:
1. Risposte SCHEMATICHE e CONCISE
2. Usa ELENCHI PUNTATI per chiarezza
3. Per AUTO USATE: mostra SEMPRE tutti i dettagli disponibili (prezzo, km, anno, colore, link)
4. SEMPRE basati SOLO sui dati forniti

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üöó FORMATO PER AUTO USATE (dal database):

Quando ricevi dati dal database, presentali cos√¨:

‚îÅ‚îÅ‚îÅ MARCA MODELLO ‚îÅ‚îÅ‚îÅ
üí∞ Prezzo: ‚Ç¨XX.XXX
üìÖ Anno: XX/XXXX
üõ£Ô∏è Km: XX.XXX
‚õΩ Carburante: [tipo]
‚öôÔ∏è Cambio: [tipo]
üèéÔ∏è Potenza: XX CV
üé® Colore: [colore]
üéØ Accessori: [lista]
üîó Link: [url]

IMPORTANTE:
- Mostra TUTTI i dettagli disponibili
- Non inventare dati se non presenti
- Se il database √® vuoto, dillo chiaramente
- Max 3-4 auto per risposta per leggibilit√†

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üÜï FORMATO PER AUTO NUOVE:

Per INFO GENERALI:
‚úì Punto chiave 1
‚úì Punto chiave 2

Per CONFRONTI:
üî¥ ALLESTIMENTO 1
‚Ä¢ Caratteristica 1
‚Ä¢ Caratteristica 2

üîµ ALLESTIMENTO 2  
‚Ä¢ Caratteristica 1
‚Ä¢ Caratteristica 2

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚ö†Ô∏è IMPORTANTE:
- Database auto usate = dati REALI e precisi
- Sii sempre trasparente su cosa sai e cosa no
- Se chiede confronto tra usate, usa i dati reali dal database`;

    // Send message to AI
    async function sendMessage() {
      const userMessage = chatInputField.value.trim();
      if (!userMessage) return;

      addMessage(userMessage, "user");
      chatInputField.value = "";
      chatSendBtn.disabled = true;

      chatHistory.push({ role: "user", content: userMessage });

      showTyping();

      try {
        let contextData = null;

        // Se chiede auto USATE, interroga il DATABASE
        if (isUsedCarQuery(userMessage)) {
          contextData = await searchUsedCars(userMessage);
        }

        // Prepara i messaggi per l'API
        const messages = [
          { role: "system", content: SYSTEM_PROMPT },
          ...chatHistory
        ];

        // Se ci sono dati dal database, aggiungili al contesto
        if (contextData) {
          messages.push({
            role: "system",
            content: `DATI REALI DAL DATABASE CENTROAUTO:\n\n${contextData}\n\nQuesti sono i dati REALI delle auto in stock. Presentali tutti in modo chiaro e dettagliato.`
          });
        }

        const response = await fetch(BACKEND_CHAT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages }),
        });

        if (!response.ok) throw new Error(`Errore ${response.status}`);

        const data = await response.json();
        
        hideTyping();

        let aiMessage = data.choices?.[0]?.message?.content || "Scusa, non ho capito.";
        
        aiMessage = aiMessage.replace(/[&<>"']/g, c => ({
          "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
        }[c]));
        
        addMessage(aiMessage, "ai");

        chatHistory.push({ role: "assistant", content: aiMessage });

      } catch (error) {
        hideTyping();
        console.error("Errore chat:", error);
        addMessage("‚ùå Errore di connessione. Riprova tra poco.", "ai");
      } finally {
        chatSendBtn.disabled = false;
        chatInputField.focus();
      }
    }

    chatSendBtn.addEventListener("click", sendMessage);

    chatInputField.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
  </script>
</body>
</html>
