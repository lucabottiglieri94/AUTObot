<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI BOTT Automotive - Self Learning</title>

  <style>
    :root{
      --bgTop:#07080b;
      --bgMid:#101216;
      --bgBot:#1a1d23;

      --panel: rgba(17,24,39,.78);
      --line:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#3b82f6;
      --accent2:#60a5fa;
    }

    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(1200px 700px at 18% -12%, rgba(59,130,246,.22), transparent 58%),
        radial-gradient(900px 520px at 72% 8%, rgba(96,165,250,.14), transparent 60%),
        linear-gradient(180deg, var(--bgTop) 0%, var(--bgMid) 48%, var(--bgBot) 100%);
    }

    header{
      position:sticky;
      top:0;
      z-index:10;
      background:rgba(10,10,12,.72);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
    }

    .wrap{max-width:1200px;margin:0 auto;padding:16px}

    .row{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
      min-width: 320px;
    }

    .brandMark{
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .brandLogo{
      width:4cm;
      height:4cm;
      object-fit:contain;
      background:transparent;
      border:none;
      outline:none;
      filter:none;
      mix-blend-mode: screen;
    }

    .brandName{
      font-weight:950;
      letter-spacing:.2px;
      font-size:18px;
      line-height:1;
      background:linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      white-space:nowrap;
    }
    .brandSub{
      opacity:.75;
      white-space:nowrap;
    }

    .btn{
      border:1px solid var(--line);
      background:rgba(17,24,39,.75);
      color:var(--text);
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-size:14px;
      transition:all .2s;
      font-weight:650;
    }
    .btn:hover{
      border-color:rgba(59,130,246,.6);
      background:rgba(17,24,39,.92);
      transform:translateY(-1px);
    }
    .btn.primary{
      border-color:rgba(59,130,246,.55);
      background:rgba(37,99,235,.16);
    }
    .btn.primary:hover{background:rgba(37,99,235,.26)}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}

    .btn.brand-fiat:hover{border-color:rgba(220,38,38,.6);background:rgba(220,38,38,.1)}
    .btn.brand-jeep:hover{border-color:rgba(34,197,94,.6);background:rgba(34,197,94,.1)}
    .btn.brand-alfa:hover{border-color:rgba(239,68,68,.6);background:rgba(239,68,68,.1)}
    .btn.brand-lancia:hover{border-color:rgba(59,130,246,.6);background:rgba(59,130,246,.1)}

    .centroAutoLink{
      display:inline-flex;
      align-items:center;
      padding:6px 12px;
      border:2px solid rgba(34,197,94,.4);
      background:rgba(34,197,94,.08);
      border-radius:12px;
      transition:all .3s ease;
      text-decoration:none;
      box-shadow:0 2px 8px rgba(34,197,94,.15);
    }
    .centroAutoLink:hover{
      border-color:rgba(34,197,94,.7);
      background:rgba(34,197,94,.18);
      transform:translateY(-2px);
      box-shadow:0 4px 16px rgba(34,197,94,.3);
    }
    .centroAutoLogo{
      height:42px;
      width:auto;
      object-fit:contain;
      filter:drop-shadow(0 1px 3px rgba(0,0,0,.2));
    }

    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(17,24,39,.35);
      font-size:12px;
      white-space:nowrap;
    }
    .muted{color:var(--muted)}

    .layout{
      margin-top:16px;
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
      align-items:start;
    }

    .panel{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
    }

    .panelHeader{
      padding:14px 14px 10px 14px;
      border-bottom:1px solid rgba(31,41,55,.75);
      background:rgba(10,12,18,.35);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }

    .panelTitle{font-weight:950;font-size:18px}
    .panelSub{margin-top:6px}

    .newsScroll{
      max-height: calc(100vh - 140px);
      overflow:auto;
      padding:12px;
    }

    .newsScroll::-webkit-scrollbar{width:10px}
    .newsScroll::-webkit-scrollbar-thumb{
      background:rgba(59,130,246,.25);
      border:2px solid rgba(17,24,39,.7);
      border-radius:999px;
    }
    .newsScroll::-webkit-scrollbar-track{background:rgba(0,0,0,.12)}

    #status{margin:10px 0 0 0}
    #newsList{display:grid;gap:12px}

    .newsItem{
      display:block;
      padding:14px;
      border:1px solid var(--line);
      border-radius:14px;
      text-decoration:none;
      color:inherit;
      background:rgba(17,24,39,.35);
      transition:all .2s;
    }
    .newsItem:hover{
      border-color:rgba(59,130,246,.6);
      background:rgba(17,24,39,.55);
      transform:translateX(4px);
    }
    .newsTitle{font-weight:850;margin-bottom:8px}
    .newsMeta{opacity:.75;font-size:12px;margin-top:6px}
    .newsDate{opacity:.75;font-size:12px;margin-top:6px;font-style:italic}

    .rightSpace{
      padding:18px;
      border:1px dashed rgba(31,41,55,.7);
      border-radius:16px;
      background:rgba(0,0,0,.12);
    }

    /* ========== ADMIN PANEL ========== */
    .adminPanel{
      position:fixed;
      top:80px;
      right:24px;
      width:360px;
      max-height:calc(100vh - 120px);
      background:rgba(17,24,39,.95);
      border:2px solid rgba(251,191,36,.6);
      border-radius:16px;
      overflow:hidden;
      z-index:999;
      display:none;
      box-shadow:0 20px 60px rgba(251,191,36,.3);
    }
    .adminPanel.open{display:flex;flex-direction:column}

    .adminHeader{
      background:linear-gradient(135deg, rgba(251,191,36,.85), rgba(245,158,11,.85));
      padding:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      color:#1a1d23;
      font-weight:700;
    }

    .adminContent{
      flex:1;
      overflow-y:auto;
      padding:16px;
    }

    .adminSection{
      margin-bottom:20px;
      padding:12px;
      background:rgba(31,41,55,.5);
      border-radius:10px;
      border:1px solid var(--line);
    }

    .adminSectionTitle{
      font-weight:700;
      margin-bottom:10px;
      color:var(--accent2);
      font-size:14px;
    }

    .adminStat{
      display:flex;
      justify-content:space-between;
      padding:6px 0;
      font-size:13px;
    }

    .adminBtn{
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid var(--accent);
      background:rgba(59,130,246,.15);
      color:var(--text);
      cursor:pointer;
      font-size:13px;
      font-weight:600;
      transition:all .2s;
      margin-top:8px;
    }
    .adminBtn:hover{
      background:rgba(59,130,246,.25);
      transform:translateY(-1px);
    }

    .adminBtnDanger{
      border-color:rgba(239,68,68,.6);
      background:rgba(239,68,68,.15);
    }
    .adminBtnDanger:hover{
      background:rgba(239,68,68,.25);
    }

    /* ========== CHATBOT STYLES ========== */
    
    .chatTrigger{
      position:fixed;
      bottom:24px;
      right:24px;
      width:70px;
      height:70px;
      border-radius:50%;
      background:transparent;
      border:none;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 8px 24px rgba(0,0,0,.3);
      transition:all .3s ease;
      z-index:1000;
    }
    .chatTrigger:hover{
      transform:scale(1.1);
      box-shadow:0 12px 32px rgba(0,0,0,.5);
    }
    .chatTrigger img{
      width:70px;
      height:70px;
      object-fit:contain;
    }

    .chatBox{
      position:fixed;
      bottom:24px;
      right:24px;
      width:420px;
      max-width:calc(100vw - 32px);
      height:600px;
      max-height:calc(100vh - 48px);
      background:rgba(17,24,39,.95);
      border:1px solid var(--line);
      border-radius:20px;
      display:none;
      flex-direction:column;
      box-shadow:0 20px 60px rgba(0,0,0,.6);
      z-index:1001;
      overflow:hidden;
      backdrop-filter:blur(20px);
    }
    .chatBox.open{display:flex}
    .chatBox.minimized{
      width:70px;
      height:70px;
      background:transparent;
      border:none;
      border-radius:50%;
      box-shadow:0 8px 24px rgba(0,0,0,.3);
    }
    .chatBox.minimized .chatHeader,
    .chatBox.minimized .chatMessages,
    .chatBox.minimized .chatInput{
      display:none;
    }

    .chatHeader{
      background:linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.15);
    }
    .chatHeaderLeft{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .chatHeaderLogo{
      width:38px;
      height:38px;
      border-radius:50%;
      background:rgba(255,255,255,.15);
      padding:4px;
    }
    .chatHeaderTitle{
      font-weight:700;
      font-size:16px;
      color:#fff;
    }
    .chatHeaderSub{
      font-size:11px;
      color:rgba(255,255,255,.75);
      margin-top:2px;
    }
    .chatHeaderBtns{
      display:flex;
      gap:8px;
    }
    .chatHeaderBtn{
      width:32px;
      height:32px;
      border-radius:8px;
      background:rgba(255,255,255,.15);
      border:none;
      color:#fff;
      cursor:pointer;
      font-size:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all .2s;
      font-weight:700;
    }
    .chatHeaderBtn:hover{
      background:rgba(255,255,255,.25);
      transform:scale(1.05);
    }

    .chatMessages{
      flex:1;
      overflow-y:auto;
      padding:16px;
      background:linear-gradient(180deg, 
        rgba(26,29,35,.95) 0%, 
        rgba(16,18,22,.95) 100%);
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .chatMessages::-webkit-scrollbar{width:8px}
    .chatMessages::-webkit-scrollbar-thumb{
      background:rgba(59,130,246,.3);
      border-radius:999px;
    }
    .chatMessages::-webkit-scrollbar-track{background:rgba(0,0,0,.2)}

    .message{
      display:flex;
      gap:8px;
      animation:slideIn .3s ease;
    }
    @keyframes slideIn{
      from{opacity:0;transform:translateY(10px)}
      to{opacity:1;transform:translateY(0)}
    }

    .message.user{
      flex-direction:row-reverse;
    }
    .messageBubble{
      max-width:85%;
      padding:12px 16px;
      border-radius:18px;
      font-size:14px;
      line-height:1.6;
      word-wrap:break-word;
      white-space:pre-line;
    }
    .message.ai .messageBubble{
      background:linear-gradient(135deg, rgba(59,130,246,.85) 0%, rgba(96,165,250,.85) 100%);
      color:#fff;
      border-bottom-left-radius:4px;
    }
    .message.user .messageBubble{
      background:rgba(255,255,255,.92);
      color:#1a1d23;
      border-bottom-right-radius:4px;
    }

    /* CORREZIONE OPERATORE */
    .message.correction .messageBubble{
      background:linear-gradient(135deg, rgba(251,191,36,.85) 0%, rgba(245,158,11,.85) 100%);
      color:#1a1d23;
      border:2px solid rgba(251,191,36,.6);
      font-weight:600;
    }

    .messageBubble a {
      color: #fff;
      text-decoration: underline;
      font-weight: 600;
    }
    .messageBubble a:hover {
      color: #fbbf24;
    }

    .correctBtn{
      margin-top:8px;
      padding:8px 12px;
      border-radius:8px;
      background:rgba(251,191,36,.2);
      border:1px solid rgba(251,191,36,.5);
      color:#fbbf24;
      font-size:12px;
      cursor:pointer;
      transition:all .2s;
    }
    .correctBtn:hover{
      background:rgba(251,191,36,.3);
      transform:translateY(-1px);
    }

    .typingIndicator{
      display:flex;
      gap:8px;
      padding:12px 16px;
      background:linear-gradient(135deg, rgba(59,130,246,.85) 0%, rgba(96,165,250,.85) 100%);
      border-radius:18px;
      border-bottom-left-radius:4px;
      max-width:75%;
    }
    .typingDot{
      width:8px;
      height:8px;
      border-radius:50%;
      background:rgba(255,255,255,.9);
      animation:bounce 1.4s infinite ease-in-out;
    }
    .typingDot:nth-child(1){animation-delay:0s}
    .typingDot:nth-child(2){animation-delay:.2s}
    .typingDot:nth-child(3){animation-delay:.4s}
    @keyframes bounce{
      0%,80%,100%{transform:scale(0)}
      40%{transform:scale(1)}
    }

    .chatInput{
      padding:16px;
      background:rgba(10,12,18,.95);
      border-top:1px solid var(--line);
      display:flex;
      gap:10px;
    }
    .chatInputField{
      flex:1;
      background:rgba(31,41,55,.6);
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px 16px;
      color:var(--text);
      font-size:14px;
      outline:none;
      transition:all .2s;
      font-family:inherit;
    }
    .chatInputField:focus{
      border-color:var(--accent);
      background:rgba(31,41,55,.8);
    }
    .chatInputField::placeholder{
      color:var(--muted);
    }
    .chatSendBtn{
      width:48px;
      height:48px;
      border-radius:12px;
      background:linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
      border:none;
      color:#fff;
      cursor:pointer;
      font-size:20px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all .2s;
    }
    .chatSendBtn:hover:not(:disabled){
      transform:scale(1.05);
      box-shadow:0 4px 16px rgba(59,130,246,.4);
    }
    .chatSendBtn:disabled{
      opacity:.5;
      cursor:not-allowed;
    }

    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
      .newsScroll{max-height: 60vh}
      .brand{min-width: unset}
      .chatBox{
        width:100%;
        max-width:100%;
        height:100vh;
        max-height:100vh;
        bottom:0;
        right:0;
        border-radius:0;
      }
      .chatTrigger{
        bottom:16px;
        right:16px;
        width:60px;
        height:60px;
      }
      .adminPanel{
        width:100%;
        max-width:100%;
        top:60px;
        right:0;
        border-radius:0;
      }
    }

    @media (max-width: 768px){
      .btn{padding:8px 10px;font-size:13px}
      .brandLogo{width:30px;height:30px}
      .brandName{font-size:16px}
      .centroAutoLogo{height:36px}
      .centroAutoLink{padding:4px 8px}
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="row">
        <div class="brand">
          <div class="brandMark">
            <img
              class="brandLogo"
              src="https://image2url.com/r2/default/images/1770729951588-711e8f2c-9f48-4ef1-9af3-be4b1f7b5d9f.png"
              alt="AI BOTT logo"
            />
            <div>
              <div class="brandName">AI BOTT</div>
              <div class="brandSub">Self-Learning System</div>
            </div>
          </div>

          <button id="fiatBtn" class="btn brand-fiat">Fiat</button>
          <button id="jeepBtn" class="btn brand-jeep">Jeep</button>
          <button id="alfaBtn" class="btn brand-alfa">Alfa Romeo</button>
          <button id="lanciaBtn" class="btn brand-lancia">Lancia</button>
          
          <a 
            href="https://www.centroautovt.it/" 
            target="_blank" 
            rel="noopener noreferrer"
            class="centroAutoLink"
            title="Visita CentroAuto VT"
          >
            <img 
              src="https://image2url.com/r2/default/images/1770805237740-1db65b1e-5553-4b5b-b28a-750e3520a0a2.png" 
              alt="CentroAuto VT" 
              class="centroAutoLogo"
            />
          </a>
        </div>

        <div class="row" style="gap:10px">
          <span id="userPill" class="pill muted">Non autenticato</span>
          <button id="adminBtn" class="btn" style="display:none;background:rgba(251,191,36,.15);border-color:rgba(251,191,36,.5)">üîß Admin</button>
          <button id="loginBtn" class="btn primary">Login Google</button>
          <button id="logoutBtn" class="btn" style="display:none">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="layout">
      <aside class="panel">
        <div class="panelHeader">
          <div>
            <div class="panelTitle">üì∞ Ultime News</div>
            <div class="muted panelSub">Visibili solo dopo login.</div>
            <div id="status" class="muted">Effettua il login per caricare le news.</div>
          </div>
          <button id="refreshBtn" class="btn" disabled>üîÑ</button>
        </div>

        <div class="newsScroll">
          <div id="newsList"></div>
        </div>
      </aside>

      <section class="rightSpace">
        <div style="font-weight:950;font-size:18px">ü§ñ Sistema Auto-Apprendimento</div>
        <div class="muted" style="margin-top:8px;line-height:1.45">
          Il bot impara dalle correzioni degli operatori e si aggiorna automaticamente:
          <br><br>
          ‚Ä¢ <b>Auto Nuove</b>: Aggiornamento ogni 15 giorni
          <br>
          ‚Ä¢ <b>Auto Usate</b>: Aggiornamento ogni 7 giorni
          <br>
          ‚Ä¢ <b>Correzioni</b>: Apprese in tempo reale
        </div>
      </section>
    </div>
  </main>

  <!-- ========== ADMIN PANEL ========== -->
  <div class="adminPanel" id="adminPanel">
    <div class="adminHeader">
      <span>üîß Pannello Admin</span>
      <button class="chatHeaderBtn" id="closeAdminBtn" style="background:rgba(0,0,0,.2)">√ó</button>
    </div>
    <div class="adminContent">
      <div class="adminSection">
        <div class="adminSectionTitle">üìä Statistiche Sistema</div>
        <div class="adminStat">
          <span>Correzioni applicate:</span>
          <span id="correctionsCount">0</span>
        </div>
        <div class="adminStat">
          <span>Ultimo aggiornamento NUOVO:</span>
          <span id="lastUpdateNew">-</span>
        </div>
        <div class="adminStat">
          <span>Ultimo aggiornamento USATO:</span>
          <span id="lastUpdateUsed">-</span>
        </div>
        <div class="adminStat">
          <span>Prossimo aggiornamento NUOVO:</span>
          <span id="nextUpdateNew">-</span>
        </div>
        <div class="adminStat">
          <span>Prossimo aggiornamento USATO:</span>
          <span id="nextUpdateUsed">-</span>
        </div>
      </div>

      <div class="adminSection">
        <div class="adminSectionTitle">üîÑ Aggiornamenti Manuali</div>
        <button class="adminBtn" id="forceUpdateNew">Forza Aggiornamento AUTO NUOVE</button>
        <button class="adminBtn" id="forceUpdateUsed">Forza Aggiornamento AUTO USATE</button>
      </div>

      <div class="adminSection">
        <div class="adminSectionTitle">üìù Ultime Correzioni</div>
        <div id="recentCorrections" style="font-size:12px;max-height:200px;overflow-y:auto">
          Nessuna correzione ancora
        </div>
      </div>

      <div class="adminSection">
        <div class="adminSectionTitle">‚ö†Ô∏è Zona Pericolosa</div>
        <button class="adminBtn adminBtnDanger" id="resetLearning">Reset Apprendimento</button>
      </div>
    </div>
  </div>

  <!-- ========== CHATBOT UI ========== -->
  
  <div class="chatTrigger" id="chatTrigger">
    <img 
      src="https://image2url.com/r2/default/images/1770729951588-711e8f2c-9f48-4ef1-9af3-be4b1f7b5d9f.png" 
      alt="AI Agent"
    />
  </div>

  <div class="chatBox" id="chatBox">
    <img 
      id="chatMinimizedLogo"
      src="https://image2url.com/r2/default/images/1770729951588-711e8f2c-9f48-4ef1-9af3-be4b1f7b5d9f.png" 
      alt="AI Agent"
      style="display:none; width:70px; height:70px; object-fit:contain; cursor:pointer;"
    />
    
    <div class="chatHeader">
      <div class="chatHeaderLeft">
        <img 
          class="chatHeaderLogo" 
          src="https://image2url.com/r2/default/images/1770729951588-711e8f2c-9f48-4ef1-9af3-be4b1f7b5d9f.png" 
          alt="AI"
        />
        <div>
          <div class="chatHeaderTitle">AI BOTT Assistant</div>
          <div class="chatHeaderSub">Self-Learning System</div>
        </div>
      </div>
      <div class="chatHeaderBtns">
        <button class="chatHeaderBtn" id="minimizeBtn" title="Minimizza">‚àí</button>
        <button class="chatHeaderBtn" id="closeBtn" title="Chiudi">√ó</button>
      </div>
    </div>

    <div class="chatMessages" id="chatMessages">
      <div class="message ai">
        <div class="messageBubble">üëã Ciao capo! Come posso aiutarti?
        
üß† Sistema auto-apprendimento attivo!</div>
      </div>
    </div>

    <div class="chatInput">
      <input 
        type="text" 
        class="chatInputField" 
        id="chatInputField" 
        placeholder="Chiedimi di auto nuove o usate..."
        autocomplete="off"
      />
      <button class="chatSendBtn" id="chatSendBtn">
        ‚û§
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth,
      setPersistence,
      browserLocalPersistence,
      browserSessionPersistence,
      GoogleAuthProvider,
      signInWithPopup,
      signInWithRedirect,
      getRedirectResult,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      addDoc,
      query,
      orderBy,
      limit,
      getDocs,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const BACKEND_NEWS = "/api/news";
    const BACKEND_CHAT = "https://auto-backend-three.vercel.app/api/chat";
    const BACKEND_SEARCH = "https://auto-backend-three.vercel.app/api/search";

    const BRAND_LINKS = {
      Fiat: "https://www.fiat.it/omni/configuratore/#/",
      Jeep: "https://www.jeep-official.it/omni/configuratore",
      AlfaRomeo: "https://www.alfaromeo.it/omni/configuratore",
      Lancia: "https://www.lancia.it/omni/configuratore"
    };

    const firebaseConfig = {
      apiKey: "AIzaSyALsFF_dpL39GlPfMyKBFIKtZi5coOk9I8",
      authDomain: "auto-1af60.firebaseapp.com",
      projectId: "auto-1af60",
      storageBucket: "auto-1af60.firebasestorage.app",
      messagingSenderId: "498320258984",
      appId: "1:498320258984:web:bac67d7634273d10464f9d",
      measurementId: "G-WYM78KQWQJ"
    };

    const $ = (id) => document.getElementById(id);
    const setStatus = (t) => { $("status").textContent = t; };

    function escapeHtml(s = "") {
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function safeHost(url) {
      try { return new URL(url).hostname; } catch { return ""; }
    }

    function fmtDate(d) {
      if (!d) return "";
      const dt = new Date(d);
      if (Number.isNaN(dt.getTime())) return String(d);
      return dt.toLocaleString("it-IT", {
        day:"2-digit", month:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit"
      });
    }

    function renderItems(items) {
      const box = $("newsList");
      if (!items || !items.length) {
        box.innerHTML = '<div class="muted" style="padding:20px;text-align:center">Nessuna news disponibile.</div>';
        setStatus("Nessuna news trovata.");
        return;
      }

      box.innerHTML = items.map(n => {
        const link = n.url || n.link || "";
        const title = n.title || "Senza titolo";
        const date = fmtDate(n.date || n.pubDate || "");
        const host = safeHost(link);

        return `
          <a class="newsItem" href="${escapeHtml(link)}" target="_blank" rel="noopener noreferrer">
            <div class="newsTitle">${escapeHtml(title)}</div>
            ${host ? `<div class="newsMeta">üîó ${escapeHtml(host)}</div>` : ""}
            ${date ? `<div class="newsDate">üïê ${escapeHtml(date)}</div>` : ""}
          </a>
        `;
      }).join("");

      setStatus(`‚úÖ ${items.length} news caricate ‚Ä¢ ${new Date().toLocaleString("it-IT")}`);
    }

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt:"select_account", display:"popup" });

    // ========== üß† SISTEMA AUTO-APPRENDIMENTO ========== 

    let learningData = {
      corrections: [],
      lastUpdateNew: null,
      lastUpdateUsed: null,
      newCarsData: {},
      usedCarsData: {}
    };

    // Carica dati apprendimento da Firebase
    async function loadLearningData() {
      try {
        const docRef = doc(db, 'ai-learning', 'knowledge-base');
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          learningData = docSnap.data();
          console.log('‚úÖ Dati apprendimento caricati:', learningData);
          updateAdminStats();
        } else {
          // Inizializza per la prima volta
          await setDoc(docRef, {
            corrections: [],
            lastUpdateNew: serverTimestamp(),
            lastUpdateUsed: serverTimestamp(),
            newCarsData: NEW_CARS_DATABASE,
            usedCarsData: USED_CARS_DB
          });
          console.log('‚úÖ Database apprendimento inizializzato');
        }
      } catch (error) {
        console.error('‚ùå Errore caricamento dati:', error);
      }
    }

    // Salva correzione operatore
    async function saveCorrection(userMessage, aiResponse, correction) {
      try {
        const correctionData = {
          timestamp: new Date().toISOString(),
          userMessage: userMessage,
          aiResponse: aiResponse,
          correction: correction,
          operator: auth.currentUser?.email || 'unknown'
        };

        // Aggiungi alla collezione correzioni
        await addDoc(collection(db, 'ai-learning', 'knowledge-base', 'corrections'), correctionData);

        // Aggiorna il counter
        const docRef = doc(db, 'ai-learning', 'knowledge-base');
        const docSnap = await getDoc(docRef);
        const currentCorrections = docSnap.data()?.corrections || [];
        
        await updateDoc(docRef, {
          corrections: [...currentCorrections, correctionData]
        });

        console.log('‚úÖ Correzione salvata:', correctionData);
        
        // Applica la correzione al database
        await applyCorrection(correction);
        
        return true;
      } catch (error) {
        console.error('‚ùå Errore salvataggio correzione:', error);
        return false;
      }
    }

    // Applica correzione al database
    async function applyCorrection(correction) {
      // Parse della correzione usando AI
      try {
        const messages = [
          {
            role: "system",
            content: `Sei un parser di correzioni. Estrai le informazioni strutturate dalla correzione dell'operatore.
            
Rispondi SOLO con un JSON in questo formato:
{
  "type": "new" o "used",
  "action": "add", "remove", "update",
  "brand": "nome marca",
  "model": "nome modello",
  "trim": "nome allestimento",
  "details": "dettagli specifici"
}

Esempio correzione: "Il pack Tech non si pu√≤ mettere sulla Grande Panda La Prima perch√© √® full optional di suo"
Output: {"type":"new","action":"remove","brand":"fiat","model":"grande-panda","trim":"La Prima","details":"Pack Tech non disponibile - full optional di serie"}`
          },
          {
            role: "user",
            content: correction
          }
        ];

        const response = await fetch(BACKEND_CHAT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages }),
        });

        if (!response.ok) throw new Error("Errore parsing");

        const data = await response.json();
        const parsedCorrection = JSON.parse(data.choices[0].message.content);

        // Aggiorna il database locale
        if (parsedCorrection.type === 'new') {
          // Aggiorna auto nuove
          const docRef = doc(db, 'ai-learning', 'knowledge-base');
          const docSnap = await getDoc(docRef);
          const currentData = docSnap.data().newCarsData;

          // Applica la modifica
          if (parsedCorrection.action === 'update' || parsedCorrection.action === 'add') {
            if (!currentData[parsedCorrection.brand].models[parsedCorrection.model].restrictions) {
              currentData[parsedCorrection.brand].models[parsedCorrection.model].restrictions = {};
            }
            currentData[parsedCorrection.brand].models[parsedCorrection.model].restrictions[parsedCorrection.trim] = parsedCorrection.details;
          }

          await updateDoc(docRef, {
            newCarsData: currentData
          });

          console.log('‚úÖ Correzione applicata al database nuove');
        }

        await loadLearningData(); // Ricarica i dati
        updateAdminStats();

      } catch (error) {
        console.error('‚ùå Errore applicazione correzione:', error);
      }
    }

    // Verifica se serve aggiornamento
    function needsUpdate(lastUpdate, daysInterval) {
      if (!lastUpdate) return true;
      const lastUpdateDate = lastUpdate.toDate ? lastUpdate.toDate() : new Date(lastUpdate);
      const now = new Date();
      const diffDays = (now - lastUpdateDate) / (1000 * 60 * 60 * 24);
      return diffDays >= daysInterval;
    }

    // Auto-aggiornamento schedulato
    async function checkAutoUpdates() {
      try {
        const docRef = doc(db, 'ai-learning', 'knowledge-base');
        const docSnap = await getDoc(docRef);
        const data = docSnap.data();

        // Verifica AUTO NUOVE (ogni 15 giorni)
        if (needsUpdate(data.lastUpdateNew, 15)) {
          console.log('üîÑ Avvio aggiornamento AUTO NUOVE...');
          await updateNewCarsData();
        }

        // Verifica AUTO USATE (ogni 7 giorni)
        if (needsUpdate(data.lastUpdateUsed, 7)) {
          console.log('üîÑ Avvio aggiornamento AUTO USATE...');
          await updateUsedCarsData();
        }

      } catch (error) {
        console.error('‚ùå Errore check aggiornamenti:', error);
      }
    }

    // Aggiorna dati auto nuove
    async function updateNewCarsData() {
      try {
        // Cerca aggiornamenti sui configuratori
        const searchPromises = [
          fetch(`${BACKEND_SEARCH}?q=Fiat nuovi modelli 2025 site:fiat.it`),
          fetch(`${BACKEND_SEARCH}?q=Jeep nuovi modelli 2025 site:jeep-official.it`),
          fetch(`${BACKEND_SEARCH}?q=Alfa Romeo nuovi modelli 2025 site:alfaromeo.it`),
          fetch(`${BACKEND_SEARCH}?q=Lancia nuovi modelli 2025 site:lancia.it`)
        ];

        const results = await Promise.all(searchPromises);
        
        // Aggiorna timestamp
        const docRef = doc(db, 'ai-learning', 'knowledge-base');
        await updateDoc(docRef, {
          lastUpdateNew: serverTimestamp()
        });

        console.log('‚úÖ Auto nuove aggiornate');
        await loadLearningData();
        updateAdminStats();

      } catch (error) {
        console.error('‚ùå Errore aggiornamento auto nuove:', error);
      }
    }

    // Aggiorna dati auto usate
    async function updateUsedCarsData() {
      try {
        // Scrape CentroAuto per nuove disponibilit√†
        const response = await fetch(`${BACKEND_SEARCH}?q=site:centroautovt.it/ricerca-auto/usate`);
        
        // Aggiorna timestamp
        const docRef = doc(db, 'ai-learning', 'knowledge-base');
        await updateDoc(docRef, {
          lastUpdateUsed: serverTimestamp()
        });

        console.log('‚úÖ Auto usate aggiornate');
        await loadLearningData();
        updateAdminStats();

      } catch (error) {
        console.error('‚ùå Errore aggiornamento auto usate:', error);
      }
    }

    // Aggiorna statistiche admin panel
    function updateAdminStats() {
      const correctionsCount = learningData.corrections?.length || 0;
      $('correctionsCount').textContent = correctionsCount;

      if (learningData.lastUpdateNew) {
        const lastNew = learningData.lastUpdateNew.toDate ? learningData.lastUpdateNew.toDate() : new Date(learningData.lastUpdateNew);
        $('lastUpdateNew').textContent = fmtDate(lastNew);
        
        const nextNew = new Date(lastNew);
        nextNew.setDate(nextNew.getDate() + 15);
        $('nextUpdateNew').textContent = fmtDate(nextNew);
      }

      if (learningData.lastUpdateUsed) {
        const lastUsed = learningData.lastUpdateUsed.toDate ? learningData.lastUpdateUsed.toDate() : new Date(learningData.lastUpdateUsed);
        $('lastUpdateUsed').textContent = fmtDate(lastUsed);
        
        const nextUsed = new Date(lastUsed);
        nextUsed.setDate(nextUsed.getDate() + 7);
        $('nextUpdateUsed').textContent = fmtDate(nextUsed);
      }

      // Mostra ultime correzioni
      if (correctionsCount > 0) {
        const recent = learningData.corrections.slice(-5).reverse();
        $('recentCorrections').innerHTML = recent.map(c => `
          <div style="padding:8px;margin-bottom:8px;background:rgba(59,130,246,.1);border-radius:6px;border:1px solid var(--line)">
            <div style="font-weight:600;margin-bottom:4px">${escapeHtml(c.operator)}</div>
            <div style="opacity:.8">${escapeHtml(c.correction.substring(0, 80))}...</div>
            <div style="opacity:.6;font-size:11px;margin-top:4px">${fmtDate(c.timestamp)}</div>
          </div>
        `).join('');
      }
    }

    // ========== DATABASE AUTO (con integrazione learning) ========== 

    const NEW_CARS_DATABASE = {
      'fiat': {
        brand: 'Fiat',
        site: 'fiat.it',
        models: {
          '500': {
            name: '500 Elettrica',
            trims: ['Action', 'Passion', 'Icon', 'La Prima'],
            keywords: ['500', 'cinquecento', '500e', '500 elettrica']
          },
          '500x': {
            name: '500X',
            trims: ['City Cross', 'Cross', 'Sport'],
            keywords: ['500x', 'cinquecento x']
          },
          'panda': {
            name: 'Panda',
            trims: ['Easy', 'Cross', 'Sport'],
            packs: {
              'Cross': ['Pack Comfort', 'Pack Style', 'Pack Tech']
            },
            keywords: ['panda']
          },
          'grande-panda': {
            name: 'Grande Panda',
            trims: ['Pop', 'Icon', 'La Prima'],
            keywords: ['grande panda', 'grandepanda', 'panda grande']
          },
          '600': {
            name: '600',
            trims: ['RED', 'La Prima'],
            keywords: ['600', 'seicento', '600 ibrida', '600 elettrica']
          },
          'tipo': {
            name: 'Tipo',
            trims: ['City Life', 'City Cross', 'Cross', 'Sport'],
            keywords: ['tipo']
          },
          'ducato': {
            name: 'Ducato',
            trims: ['Furgone', 'Combi', 'Passo Corto', 'Passo Medio', 'Passo Lungo'],
            keywords: ['ducato']
          }
        }
      },
      'jeep': {
        brand: 'Jeep',
        site: 'jeep-official.it',
        models: {
          'avenger': {
            name: 'Avenger',
            trims: ['Longitude', 'Altitude', 'Summit', 'The North Face Edition'],
            keywords: ['avenger']
          },
          'renegade': {
            name: 'Renegade',
            trims: ['Longitude', 'Limited', 'Trailhawk', '80th Anniversary'],
            keywords: ['renegade']
          },
          'compass': {
            name: 'Compass',
            trims: ['Longitude', 'Limited', 'Trailhawk', 'S', '80th Anniversary'],
            keywords: ['compass']
          },
          'wrangler': {
            name: 'Wrangler',
            trims: ['Sport', 'Sahara', 'Rubicon', '4xe'],
            keywords: ['wrangler']
          },
          'grand-cherokee': {
            name: 'Grand Cherokee',
            trims: ['Limited', 'Overland', 'Summit', 'Trailhawk', '4xe'],
            keywords: ['grand cherokee', 'grandcherokee']
          },
          'gladiator': {
            name: 'Gladiator',
            trims: ['Sport', 'Overland', 'Rubicon'],
            keywords: ['gladiator']
          }
        }
      },
      'alfa': {
        brand: 'Alfa Romeo',
        site: 'alfaromeo.it',
        models: {
          'junior': {
            name: 'Junior',
            trims: ['Ibrida Q4', 'Elettrica', 'Speciale', 'Veloce'],
            keywords: ['junior', 'alfa junior']
          },
          'tonale': {
            name: 'Tonale',
            trims: ['Super', 'Sprint', 'Ti', 'Veloce', 'Q4'],
            keywords: ['tonale']
          },
          'stelvio': {
            name: 'Stelvio',
            trims: ['Super', 'Sprint', 'Ti', 'Veloce', 'Quadrifoglio'],
            keywords: ['stelvio']
          },
          'giulia': {
            name: 'Giulia',
            trims: ['Super', 'Sprint', 'Ti', 'Veloce', 'Quadrifoglio'],
            keywords: ['giulia']
          }
        }
      },
      'lancia': {
        brand: 'Lancia',
        site: 'lancia.it',
        models: {
          'ypsilon': {
            name: 'Ypsilon',
            trims: ['Cassina', 'Edizione Limitata', 'LX', 'Elettrica'],
            keywords: ['ypsilon', 'ipsilon', 'y']
          }
        }
      }
    };

    const USED_CARS_DB = {
      'ford': {
        name: 'Ford',
        count: 9,
        link: 'https://www.centroautovt.it/ricerca-auto/usate?brand=Ford',
        models: ['fiesta', 'focus', 'kuga', 'ecosport', 'puma', 'transit']
      },
      'jeep': {
        name: 'Jeep',
        count: 13,
        link: 'https://www.centroautovt.it/ricerca-auto/usate?brand=Jeep',
        models: ['renegade', 'compass', 'wrangler', 'cherokee']
      },
      'kia': {
        name: 'Kia',
        count: 1,
        link: 'https://www.centroautovt.it/ricerca-auto/usate?brand=Kia',
        models: ['sportage', 'picanto', 'rio', 'ceed', 'niro']
      },
      'lancia': {
        name: 'Lancia',
        count: 4,
        link: 'https://www.centroautovt.it/ricerca-auto/usate?brand=Lancia',
        models: ['ypsilon', 'delta']
      },
      'volkswagen': {
        name: 'Volkswagen',
        count: 4,
        link: 'https://www.centroautovt.it/ricerca-auto/usate?brand=Volkswagen',
        models: ['golf', 'polo', 'tiguan', 'passat', 't-roc', 'id.3', 'id.4']
      }
    };

    // ========== RESTO DEL CODICE CHATBOT ========== 

    (async function initApp(){
      try { await setPersistence(auth, browserLocalPersistence); }
      catch {
        try { await setPersistence(auth, browserSessionPersistence); } catch {}
      }

      try{
        const result = await getRedirectResult(auth);
        if (result?.user) setStatus("‚úÖ Login riuscito! Benvenuto " + result.user.email);
      }catch(e){
        setStatus("‚ùå Errore login: " + (e.code || e.message));
      }

      // Carica dati apprendimento
      await loadLearningData();

      // Check aggiornamenti automatici ogni ora
      setInterval(checkAutoUpdates, 60 * 60 * 1000);
      checkAutoUpdates(); // Prima esecuzione
    })();

    async function loadNews() {
      const user = auth.currentUser;
      if (!user) {
        $("newsList").innerHTML = "";
        setStatus("üîí Effettua il login per vedere le news.");
        return;
      }

      setStatus("‚è≥ Caricamento news...");
      $("refreshBtn").disabled = true;

      try {
        const response = await fetch(BACKEND_NEWS, {
          method:"GET",
          headers:{ "Cache-Control":"no-cache" },
          cache:"no-store"
        });

        if (!response.ok) {
          const errorText = await response.text().catch(() => "");
          throw new Error(`HTTP ${response.status}${errorText ? " - " + errorText : ""}`);
        }

        const data = await response.json();

        if (data.items && Array.isArray(data.items)) renderItems(data.items);
        else if (Array.isArray(data)) renderItems(data);
        else throw new Error("Formato dati non valido");
      } catch (err) {
        $("newsList").innerHTML = '<div class="muted" style="padding:20px;text-align:center">‚ùå Errore caricamento news</div>';
        setStatus("‚ùå Errore: " + (err?.message || err));
      } finally {
        $("refreshBtn").disabled = !auth.currentUser;
      }
    }

    $("loginBtn").addEventListener("click", async () => {
      try {
        setStatus("üîê Apertura login Google...");

        try {
          const result = await signInWithPopup(auth, provider);
          setStatus("‚úÖ Login riuscito! Benvenuto " + result.user.email);
        } catch (popupError) {
          if (popupError.code === "auth/popup-blocked" ||
              popupError.code === "auth/popup-closed-by-user" ||
              popupError.code === "auth/cancelled-popup-request") {
            setStatus("üîÑ Reindirizzamento in corso...");
            await signInWithRedirect(auth, provider);
          } else {
            throw popupError;
          }
        }
      } catch (e) {
        let errorMsg = "Errore sconosciuto";
        if (e.code === "auth/unauthorized-domain") errorMsg = "Dominio non autorizzato in Firebase Console";
        else if (e.code === "auth/popup-blocked") errorMsg = "Popup bloccato dal browser";
        else errorMsg = e.code || e.message;
        setStatus("‚ùå " + errorMsg);
      }
    });

    $("logoutBtn").addEventListener("click", async () => {
      try {
        await signOut(auth);
        $("newsList").innerHTML = "";
        setStatus("üëã Logout effettuato.");
      } catch (e) {
        setStatus("‚ùå Errore logout: " + (e.code || e.message));
      }
    });

    $("refreshBtn").addEventListener("click", loadNews);

    $("fiatBtn").addEventListener("click", () => window.open(BRAND_LINKS.Fiat, "_blank", "noopener,noreferrer"));
    $("jeepBtn").addEventListener("click", () => window.open(BRAND_LINKS.Jeep, "_blank", "noopener,noreferrer"));
    $("alfaBtn").addEventListener("click", () => window.open(BRAND_LINKS.AlfaRomeo, "_blank", "noopener,noreferrer"));
    $("lanciaBtn").addEventListener("click", () => window.open(BRAND_LINKS.Lancia, "_blank", "noopener,noreferrer"));

    // Admin Panel
    $("adminBtn").addEventListener("click", () => {
      if (!isAdmin) {
        alert('üö´ ACCESSO NEGATO!\n\nSolo l\'amministratore pu√≤ accedere al pannello.\n\nEmail autorizzata: lucabottiglieri94@gmail.com');
        return;
      }
      $("adminPanel").classList.toggle("open");
    });

    $("closeAdminBtn").addEventListener("click", () => {
      $("adminPanel").classList.remove("open");
    });

    $("forceUpdateNew").addEventListener("click", async () => {
      if (!isAdmin) {
        alert('üö´ ACCESSO NEGATO!');
        return;
      }
      await updateNewCarsData();
    });
    
    $("forceUpdateUsed").addEventListener("click", async () => {
      if (!isAdmin) {
        alert('üö´ ACCESSO NEGATO!');
        return;
      }
      await updateUsedCarsData();
    });

    $("resetLearning").addEventListener("click", async () => {
      if (!isAdmin) {
        alert('üö´ ACCESSO NEGATO!');
        return;
      }
      
      if (confirm('‚ö†Ô∏è Sei sicuro? Questo canceller√† TUTTE le correzioni apprese!')) {
        try {
          const docRef = doc(db, 'ai-learning', 'knowledge-base');
          await updateDoc(docRef, {
            corrections: [],
            newCarsData: NEW_CARS_DATABASE,
            usedCarsData: USED_CARS_DB
          });
          alert('‚úÖ Sistema resettato!');
          await loadLearningData();
        } catch (error) {
          alert('‚ùå Errore reset: ' + error.message);
        }
      }
    });

    // ========== üîê AUTORIZZAZIONE ADMIN ========== 
    const ADMIN_EMAIL = "lucabottiglieri94@gmail.com";
    let isAdmin = false;

    function checkAdminAccess(email) {
      return email && email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
    }

    onAuthStateChanged(auth, (user) => {
      if (user) {
        isAdmin = checkAdminAccess(user.email);
        
        $("userPill").textContent = "‚úÖ " + (user.email || "Utente");
        $("userPill").classList.remove("muted");
        $("userPill").style.borderColor = "rgba(34,197,94,.5)";
        $("userPill").style.background = "rgba(34,197,94,.1)";

        // Badge ADMIN
        if (isAdmin) {
          $("userPill").textContent = "üëë ADMIN ‚Ä¢ " + user.email;
          $("userPill").style.borderColor = "rgba(251,191,36,.6)";
          $("userPill").style.background = "rgba(251,191,36,.15)";
        }

        $("loginBtn").style.display = "none";
        $("logoutBtn").style.display = "inline-block";
        
        // Mostra pulsante admin SOLO se √® l'admin
        $("adminBtn").style.display = isAdmin ? "inline-block" : "none";
        
        $("refreshBtn").disabled = false;

        loadNews();
      } else {
        isAdmin = false;
        
        $("userPill").textContent = "üîí Non autenticato";
        $("userPill").classList.add("muted");
        $("userPill").style.borderColor = "";
        $("userPill").style.background = "";

        $("loginBtn").style.display = "inline-block";
        $("logoutBtn").style.display = "none";
        $("adminBtn").style.display = "none";
        $("refreshBtn").disabled = true;

        $("newsList").innerHTML = "";
        setStatus("üîí Effettua il login per caricare le news.");
      }
    });

    // ========== CHATBOT CON CORREZIONI ========== 

    let isMinimized = false;
    let lastAiResponse = "";
    let lastUserMessage = "";

    const chatTrigger = $("chatTrigger");
    const chatBox = $("chatBox");
    const chatMessages = $("chatMessages");
    const chatInputField = $("chatInputField");
    const chatSendBtn = $("chatSendBtn");
    const minimizeBtn = $("minimizeBtn");
    const closeBtn = $("closeBtn");

    chatTrigger.addEventListener("click", () => {
      chatBox.classList.add("open");
      chatBox.classList.remove("minimized");
      chatTrigger.style.display = "none";
      $("chatMinimizedLogo").style.display = "none";
      chatInputField.focus();
    });

    minimizeBtn.addEventListener("click", () => {
      chatBox.classList.add("minimized");
      isMinimized = true;
      $("chatMinimizedLogo").style.display = "block";
    });

    closeBtn.addEventListener("click", () => {
      chatBox.classList.remove("open");
      chatBox.classList.remove("minimized");
      chatTrigger.style.display = "flex";
    });

    chatBox.querySelector(".chatHeader").addEventListener("click", (e) => {
      if (isMinimized && !e.target.closest("button")) {
        chatBox.classList.remove("minimized");
        isMinimized = false;
        $("chatMinimizedLogo").style.display = "none";
      }
    });

    $("chatMinimizedLogo").addEventListener("click", () => {
      chatBox.classList.remove("minimized");
      isMinimized = false;
      $("chatMinimizedLogo").style.display = "none";
      chatInputField.focus();
    });

    function addMessage(html, sender, showCorrectBtn = false) {
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${sender}`;
      
      let content = `<div class="messageBubble">${html}</div>`;
      
      // Mostra pulsante correzione SOLO se √® admin
      if (showCorrectBtn && isAdmin) {
        content += `<button class="correctBtn" onclick="promptCorrection()">‚úèÔ∏è Correggi questa risposta</button>`;
      }
      
      messageDiv.innerHTML = content;
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function showTyping() {
      const typingDiv = document.createElement("div");
      typingDiv.className = "message ai";
      typingDiv.id = "typingIndicator";
      typingDiv.innerHTML = `
        <div class="typingIndicator">
          <div class="typingDot"></div>
          <div class="typingDot"></div>
          <div class="typingDot"></div>
        </div>
      `;
      chatMessages.appendChild(typingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function hideTyping() {
      const typing = $("typingIndicator");
      if (typing) typing.remove();
    }

    // ========== üîç RICONOSCIMENTO DOMANDE TECNICHE ========== 
    
    function isTechnicalQuery(text) {
      const technicalPatterns = [
        // Dimensioni
        /quanto.*lunga/i,
        /quanto.*larga/i,
        /quanto.*alta/i,
        /dimensioni/i,
        /lunghezza/i,
        /larghezza/i,
        /altezza/i,
        /misure/i,
        
        // Motore
        /che motore/i,
        /motore/i,
        /motorizzazione/i,
        /cilindrata/i,
        /cavalli/i,
        /\bcv\b/i,
        /\bkw\b/i,
        /potenza/i,
        
        // Prestazioni
        /accelerazione/i,
        /0-100/i,
        /velocit√† massima/i,
        /velocit√† max/i,
        /prestazioni/i,
        
        // Consumi
        /consumi/i,
        /km\/l/i,
        /l\/100km/i,
        /quanto consuma/i,
        /autonomia/i,
        
        // Peso
        /peso/i,
        /quanto pesa/i,
        
        // Prezzo
        /prezzo/i,
        /quanto costa/i,
        /costo/i,
        
        // Bagagliaio
        /bagagliaio/i,
        /capacit√† bagagliaio/i,
        /litri bagagliaio/i,
        
        // Scheda tecnica
        /scheda tecnica/i,
        /dati tecnici/i,
        /specifiche/i
      ];
      
      return technicalPatterns.some(pattern => pattern.test(text));
    }
    
    // ========== üåê RICERCA GOOGLE DIRETTA ========== 
    
    async function searchGoogleDirect(query) {
      try {
        // Costruisci URL Google Search con la query esatta dell'utente
        const googleSearchUrl = `https://www.google.com/search?q=${encodeURIComponent(query)}&hl=it&udm=50`;
        
        addMessage(`üîç <b>RICERCA GOOGLE IN CORSO...</b><br>Query: "${escapeHtml(query)}"<br><br><a href="${googleSearchUrl}" target="_blank">üîó Vedi risultati su Google</a>`, 'ai');
        
        // Usa il backend search che fa scraping intelligente
        const searchResponse = await fetch(`${BACKEND_SEARCH}?q=${encodeURIComponent(query)}`);
        
        if (!searchResponse.ok) {
          throw new Error('Errore ricerca Google');
        }
        
        const searchData = await searchResponse.json();
        
        if (!searchData.results || searchData.results.length === 0) {
          return null;
        }
        
        // Prendi i primi 3 risultati pi√π rilevanti
        const topResults = searchData.results.slice(0, 3);
        
        // Costruisci contesto dai risultati Google
        let googleContext = `RISULTATI GOOGLE SEARCH per "${query}":\n\n`;
        
        topResults.forEach((result, index) => {
          googleContext += `‚îÅ‚îÅ‚îÅ RISULTATO ${index + 1} ‚îÅ‚îÅ‚îÅ\n`;
          googleContext += `Fonte: ${result.url}\n`;
          googleContext += `Titolo: ${result.title}\n\n`;
          googleContext += `${result.description}\n\n`;
        });
        
        return {
          context: googleContext,
          results: topResults
        };
        
      } catch (error) {
        console.error('Errore ricerca Google:', error);
        return null;
      }
    }
    
    // ========== üìä ESTRAI DATI TECNICI DAI RISULTATI ========== 
    
    async function extractTechnicalData(googleResults, originalQuery) {
      try {
        const messages = [
          {
            role: "system",
            content: `Sei un estrattore di dati tecnici automotive. 
            
Analizza i risultati Google forniti e estrai SOLO i dati tecnici PRECISI e NUMERICI.

REGOLE CRITICHE:
1. Usa SOLO numeri ESATTI trovati nei risultati
2. Se un dato non √® presente ‚Üí scrivi "Non trovato"
3. Mantieni le unit√† di misura (mm, kg, CV, km/h, ecc.)
4. Non inventare o stimare MAI
5. Cita sempre la fonte

FORMATO RISPOSTA:
üìä [NOME AUTO]

‚úì Dato trovato: valore (fonte)
‚úó Dato non trovato

Esempi:
‚úì Lunghezza: 4171 mm (Fiat.it)
‚úì Potenza: 156 CV (AutoScout24)
‚úó Peso: Non trovato nei risultati

IMPORTANTE: Rispondi in modo SCHEMATICO, NON in prosa narrativa.`
          },
          {
            role: "user",
            content: `Domanda originale: "${originalQuery}"\n\n${googleResults.context}`
          }
        ];
        
        const response = await fetch(BACKEND_CHAT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages }),
        });
        
        if (!response.ok) throw new Error('Errore estrazione dati');
        
        const data = await response.json();
        const extractedData = data.choices?.[0]?.message?.content || null;
        
        return extractedData;
        
      } catch (error) {
        console.error('Errore estrazione:', error);
        return null;
      }
    }

    let isMinimized = false;
    let lastAiResponse = "";
    let lastUserMessage = "";

    const chatTrigger = $("chatTrigger");
    const chatBox = $("chatBox");
    const chatMessages = $("chatMessages");
    const chatInputField = $("chatInputField");
    const chatSendBtn = $("chatSendBtn");
    const minimizeBtn = $("minimizeBtn");
    const closeBtn = $("closeBtn");

    chatTrigger.addEventListener("click", () => {
      chatBox.classList.add("open");
      chatBox.classList.remove("minimized");
      chatTrigger.style.display = "none";
      $("chatMinimizedLogo").style.display = "none";
      chatInputField.focus();
    });

    minimizeBtn.addEventListener("click", () => {
      chatBox.classList.add("minimized");
      isMinimized = true;
      $("chatMinimizedLogo").style.display = "block";
    });

    closeBtn.addEventListener("click", () => {
      chatBox.classList.remove("open");
      chatBox.classList.remove("minimized");
      chatTrigger.style.display = "flex";
    });

    chatBox.querySelector(".chatHeader").addEventListener("click", (e) => {
      if (isMinimized && !e.target.closest("button")) {
        chatBox.classList.remove("minimized");
        isMinimized = false;
        $("chatMinimizedLogo").style.display = "none";
      }
    });

    $("chatMinimizedLogo").addEventListener("click", () => {
      chatBox.classList.remove("minimized");
      isMinimized = false;
      $("chatMinimizedLogo").style.display = "none";
      chatInputField.focus();
    });

    function addMessage(html, sender, showCorrectBtn = false) {
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${sender}`;
      
      let content = `<div class="messageBubble">${html}</div>`;
      
      // Mostra pulsante correzione SOLO se √® admin
      if (showCorrectBtn && isAdmin) {
        content += `<button class="correctBtn" onclick="promptCorrection()">‚úèÔ∏è Correggi questa risposta</button>`;
      }
      
      messageDiv.innerHTML = content;
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    window.promptCorrection = async function() {
      // ‚úÖ CONTROLLO ADMIN
      if (!isAdmin) {
        alert('üö´ ACCESSO NEGATO!\n\nSolo l\'amministratore pu√≤ correggere il bot.\n\nEmail autorizzata: lucabottiglieri94@gmail.com');
        return;
      }
      
      const correction = prompt('üìù Inserisci la correzione:\n\nEsempi:\n- "Hai sbagliato le misure della 600"\n- "Il pack Tech non si pu√≤ sulla La Prima perch√© √® full optional"');
      
      if (!correction || !correction.trim()) return;
      
      // ‚ö° RILEVAMENTO AUTOMATICO ERRORI TECNICI
      const technicalErrorPatterns = [
        /hai sbagliato.*misure/i,
        /hai sbagliato.*dimensioni/i,
        /hai sbagliato.*peso/i,
        /hai sbagliato.*potenza/i,
        /hai sbagliato.*prestazioni/i,
        /hai sbagliato.*consumi/i,
        /hai sbagliato.*prezzo/i,
        /misure sbagliate/i,
        /dati sbagliati/i,
        /informazioni errate/i,
        /dati tecnici errati/i
      ];
      
      const isTechnicalError = technicalErrorPatterns.some(pattern => pattern.test(correction));
      
      if (isTechnicalError) {
        // üîç AUTO-FETCH DAI CONFIGURATORI
        addMessage(`üîç <b>RILEVATO ERRORE TECNICO</b><br>Vado a prendere i dati corretti dal configuratore...`, 'correction');
        
        showTyping();
        
        try {
          // Estrai il modello dalla correzione
          const modelMatch = correction.match(/(500|600|panda|tipo|ducato|grande panda|avenger|renegade|compass|wrangler|junior|tonale|stelvio|giulia|ypsilon)/i);
          
          if (modelMatch) {
            const modelName = modelMatch[0].toLowerCase();
            
            // Cerca dati UFFICIALI sul configuratore
            const detectedModel = detectNewCarModelByName(modelName);
            
            if (detectedModel) {
              const searchQuery = `${detectedModel.brand} ${detectedModel.model} scheda tecnica dimensioni peso prestazioni site:${detectedModel.site}`;
              
              const searchResponse = await fetch(`${BACKEND_SEARCH}?q=${encodeURIComponent(searchQuery)}`);
              const searchData = await searchResponse.json();
              
              if (searchData.results && searchData.results.length > 0) {
                const officialData = searchData.results[0];
                
                hideTyping();
                
                // Mostra dati ufficiali trovati
                addMessage(`‚úÖ <b>DATI UFFICIALI TROVATI</b><br><br>` +
                  `üìä Fonte: ${officialData.url}<br><br>` +
                  `${officialData.description}<br><br>` +
                  `<a href="${officialData.url}" target="_blank">üîó Vedi scheda tecnica completa</a>`, 'correction');
                
                // Usa AI per estrarre i dati strutturati
                const extractMessages = [
                  {
                    role: "system",
                    content: `Estrai i dati tecnici dal testo fornito e restituiscili in formato JSON strutturato.
                    
Formato richiesto:
{
  "model": "nome modello",
  "dimensions": {
    "length": "valore in mm",
    "width": "valore in mm",
    "height": "valore in mm"
  },
  "weight": "valore in kg",
  "performance": {
    "power": "valore CV/kW",
    "acceleration": "0-100 km/h",
    "top_speed": "velocit√† max"
  },
  "consumption": "consumi medi",
  "price_from": "prezzo base"
}

Se un dato non √® presente, usa null.`
                  },
                  {
                    role: "user",
                    content: `${officialData.title}\n\n${officialData.description}`
                  }
                ];
                
                const extractResponse = await fetch(BACKEND_CHAT, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ messages: extractMessages }),
                });
                
                if (extractResponse.ok) {
                  const extractData = await extractResponse.json();
                  let technicalData = null;
                  
                  try {
                    const content = extractData.choices[0].message.content;
                    // Rimuovi eventuali markdown code blocks
                    const jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```/) || content.match(/```\s*([\s\S]*?)\s*```/);
                    const jsonString = jsonMatch ? jsonMatch[1] : content;
                    technicalData = JSON.parse(jsonString);
                  } catch (e) {
                    console.error('Errore parsing JSON:', e);
                  }
                  
                  if (technicalData) {
                    // Salva i dati tecnici nel database
                    const docRef = doc(db, 'ai-learning', 'knowledge-base');
                    const docSnap = await getDoc(docRef);
                    const currentData = docSnap.data().newCarsData || NEW_CARS_DATABASE;
                    
                    // Trova e aggiorna il modello
                    for (const [brandKey, brandData] of Object.entries(currentData)) {
                      for (const [modelKey, modelData] of Object.entries(brandData.models)) {
                        if (modelData.name.toLowerCase().includes(modelName) || 
                            modelData.keywords.some(kw => kw.includes(modelName))) {
                          
                          if (!modelData.technical) {
                            modelData.technical = {};
                          }
                          
                          modelData.technical = {
                            ...modelData.technical,
                            ...technicalData,
                            lastUpdate: new Date().toISOString(),
                            source: officialData.url
                          };
                          
                          console.log('‚úÖ Dati tecnici aggiornati:', modelData.technical);
                          break;
                        }
                      }
                    }
                    
                    await updateDoc(docRef, {
                      newCarsData: currentData
                    });
                    
                    addMessage(`‚úÖ <b>DATI TECNICI AGGIORNATI!</b><br><br>` +
                      `Ho salvato i dati ufficiali del configuratore.<br>` +
                      `Ora so le informazioni corrette! üß†`, 'ai');
                  }
                }
              } else {
                hideTyping();
                addMessage(`‚ùå Non ho trovato dati sul configuratore ufficiale.<br>Per favore fornisci i dati corretti manualmente.`, 'ai');
              }
            } else {
              hideTyping();
              addMessage(`‚ùå Non ho riconosciuto il modello. Specifica meglio quale auto (es: "Fiat 600").`, 'ai');
            }
          } else {
            hideTyping();
            addMessage(`‚ùå Non ho capito di quale modello parli. Specifica il nome (es: "600", "Compass").`, 'ai');
          }
        } catch (error) {
          hideTyping();
          console.error('Errore fetch dati:', error);
          addMessage(`‚ùå Errore nel recupero dati. Riprova o fornisci i dati manualmente.`, 'ai');
        }
      } else {
        // Correzione manuale normale
        addMessage(`üìù <b>CORREZIONE ADMIN:</b><br>${escapeHtml(correction)}`, 'correction');
        
        const saved = await saveCorrection(lastUserMessage, lastAiResponse, correction);
        
        if (saved) {
          addMessage('‚úÖ <b>Correzione appresa!</b><br>Ho aggiornato la mia conoscenza. Grazie capo! üß†', 'ai');
        } else {
          addMessage('‚ùå Errore nel salvare la correzione. Riprova!', 'ai');
        }
      }
    };
    
    // Funzione helper per riconoscere modello dal nome
    function detectNewCarModelByName(modelName) {
      const lowerModel = modelName.toLowerCase();
      const database = learningData.newCarsData || NEW_CARS_DATABASE;
      
      for (const [brandKey, brandData] of Object.entries(database)) {
        for (const [modelKey, modelData] of Object.entries(brandData.models)) {
          if (modelData.name.toLowerCase().includes(lowerModel) || 
              modelData.keywords.some(kw => kw.includes(lowerModel))) {
            return {
              brand: brandData.brand,
              brandKey: brandKey,
              model: modelData.name,
              modelKey: modelKey,
              trims: modelData.trims,
              site: brandData.site,
              restrictions: modelData.restrictions || {},
              technical: modelData.technical || {}
            };
          }
        }
      }
      
      return null;
    }

    function showTyping() {
      const typingDiv = document.createElement("div");
      typingDiv.className = "message ai";
      typingDiv.id = "typingIndicator";
      typingDiv.innerHTML = `
        <div class="typingIndicator">
          <div class="typingDot"></div>
          <div class="typingDot"></div>
          <div class="typingDot"></div>
        </div>
      `;
      chatMessages.appendChild(typingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function hideTyping() {
      const typing = $("typingIndicator");
      if (typing) typing.remove();
    }

    function detectNewCarModel(query) {
      const lowerQuery = query.toLowerCase();
      const database = learningData.newCarsData || NEW_CARS_DATABASE;
      
      for (const [brandKey, brandData] of Object.entries(database)) {
        for (const [modelKey, modelData] of Object.entries(brandData.models)) {
          if (modelData.keywords.some(kw => lowerQuery.includes(kw))) {
            return {
              brand: brandData.brand,
              brandKey: brandKey,
              model: modelData.name,
              modelKey: modelKey,
              trims: modelData.trims,
              site: brandData.site,
              restrictions: modelData.restrictions || {}
            };
          }
        }
      }
      
      return null;
    }

    function isUsedCarQuery(text) {
      const lowerText = text.toLowerCase();
      const explicitUsedKeywords = ['usato', 'usata', 'usati', 'usate', 'seconda mano', 'km zero', 'centroauto', 'centro auto', 'stock', 'occasione', 'occasioni'];
      if (explicitUsedKeywords.some(kw => lowerText.includes(kw))) return true;
      
      const onlyUsedBrands = ['ford', 'kia', 'mazda', 'mg', 'opel', 'peugeot', 'renault', 'seat', 'smart', 'suzuki', 'volkswagen', 'land rover'];
      if (onlyUsedBrands.some(brand => lowerText.includes(brand))) return true;
      
      const usedOnlyModels = ['fiesta', 'focus', 'kuga', 'ecosport', 'sportage', 'picanto', 'cx-5', 'mokka', '208', '308', '2008', '3008', 'clio', 'captur', 'megane', 't-roc'];
      if (usedOnlyModels.some(model => lowerText.includes(model))) return true;
      
      return false;
    }

    function getUsedCarsResponse(query) {
      const lowerQuery = query.toLowerCase();
      const database = learningData.usedCarsData || USED_CARS_DB;
      
      for (const [brandKey, brandData] of Object.entries(database)) {
        if (lowerQuery.includes(brandKey)) {
          let response = `üöó <b>${brandData.name.toUpperCase()} USATE</b> su CentroAuto\n\n`;
          
          if (brandData.count) {
            response += `üìä <b>${brandData.count} veicoli</b> disponibili\n\n`;
          }
          
          if (brandData.models && brandData.models.length > 0) {
            response += `üè∑Ô∏è <b>Modelli disponibili:</b>\n`;
            response += brandData.models.map(m => `‚Ä¢ ${m.charAt(0).toUpperCase() + m.slice(1)}`).join('\n');
            response += '\n\n';
          }
          
          response += `üîó <a href="${brandData.link}" target="_blank">VAI ALLE ${brandData.name.toUpperCase()} USATE</a>`;
          
          return response;
        }
      }
      
      return `üöó <b>AUTO USATE</b> su CentroAuto VT\n\n` +
             `üîó <a href="https://www.centroautovt.it/ricerca-auto/usate" target="_blank">VEDI TUTTO LO STOCK</a>`;
    }

    async function searchNewCars(query, detectedModel) {
      try {
        let searchQuery = query;
        
        if (detectedModel) {
          searchQuery = `${detectedModel.brand} ${detectedModel.model} allestimenti ${detectedModel.trims.join(' ')} site:${detectedModel.site}`;
        } else {
          const officialSites = [
            'site:fiat.it/configuratore OR site:fiat.it/gamma',
            'site:jeep-official.it/configuratore OR site:jeep-official.it/gamma',
            'site:alfaromeo.it/configuratore OR site:alfaromeo.it/gamma',
            'site:lancia.it/configuratore OR site:lancia.it/gamma'
          ];
          searchQuery = `${query} allestimenti versioni (${officialSites.join(' OR ')})`;
        }
        
        const response = await fetch(`${BACKEND_SEARCH}?q=${encodeURIComponent(searchQuery)}`);
        if (!response.ok) throw new Error("Errore ricerca");
        
        const data = await response.json();
        
        if (data.results && data.results.length > 0) {
          const allowedDomains = ['fiat.it', 'jeep-official.it', 'alfaromeo.it', 'lancia.it'];
          const validResults = data.results.filter(r => {
            const url = r.url.toLowerCase();
            return allowedDomains.some(domain => url.includes(domain));
          });

          if (validResults.length === 0) return null;

          return validResults.slice(0, 3).map(r => {
            const brand = r.url.includes('fiat') ? 'Fiat' :
                         r.url.includes('jeep') ? 'Jeep' :
                         r.url.includes('alfa') ? 'Alfa Romeo' : 'Lancia';
            
            return `‚îÅ‚îÅ‚îÅ ${brand.toUpperCase()} ‚îÅ‚îÅ‚îÅ\n${r.title}\n\n${r.description}\n\nüîó ${r.url}`;
          }).join('\n\n');
        }
        return null;
      } catch (err) {
        console.error("Errore ricerca nuove:", err);
        return null;
      }
    }

    const SYSTEM_PROMPT_NEW = `Sei un assistente esperto di auto NUOVE (Fiat, Jeep, Alfa Romeo, Lancia) con sistema di auto-apprendimento.

IMPORTANTE: 
- Considera le correzioni apprese dagli operatori
- Usa SEMPRE i dati tecnici ufficiali quando disponibili nel database
- Se hai dati tecnici verificati (dimensioni, peso, prestazioni), citali con precisione

REGOLE:
1. Risposte SCHEMATICHE (max 10 righe)
2. Usa ELENCHI PUNTATI
3. Per dati tecnici: cita le fonti ufficiali
4. Confronta allestimenti chiaramente
5. Basati SOLO sui dati forniti
6. Rispetta le restrizioni apprese

FORMATO:
üî¥ ALLESTIMENTO 1
‚Ä¢ Caratteristica 1
‚Ä¢ Caratteristica 2

üîµ ALLESTIMENTO 2
‚Ä¢ Caratteristica 1
‚Ä¢ Caratteristica 2

üìä DATI TECNICI (se richiesti):
‚Ä¢ Dimensioni: L x W x H mm
‚Ä¢ Peso: X kg
‚Ä¢ Potenza: X CV/kW
‚Ä¢ Prestazioni: 0-100 in X sec

üí° CONSIGLIO: [breve]`;

    async function sendMessage() {
      const userMessage = chatInputField.value.trim();
      if (!userMessage) return;

      lastUserMessage = userMessage;
      addMessage(escapeHtml(userMessage), "user");
      chatInputField.value = "";
      chatSendBtn.disabled = true;

      showTyping();

      try {
        // ‚úÖ STEP 1: √à una domanda TECNICA?
        if (isTechnicalQuery(userMessage)) {
          hideTyping();
          
          // üîç RICERCA GOOGLE DIRETTA
          const googleResults = await searchGoogleDirect(userMessage);
          
          if (googleResults) {
            showTyping();
            
            // üìä ESTRAI DATI TECNICI
            const technicalData = await extractTechnicalData(googleResults, userMessage);
            
            hideTyping();
            
            if (technicalData) {
              lastAiResponse = technicalData;
              
              // Aggiungi link ai risultati
              let responseWithLinks = technicalData + '\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nüìé <b>FONTI:</b>\n';
              googleResults.results.forEach((result, i) => {
                responseWithLinks += `${i+1}. <a href="${result.url}" target="_blank">${result.title}</a>\n`;
              });
              
              addMessage(responseWithLinks, "ai", true);
            } else {
              addMessage('‚ùå Non sono riuscito ad estrarre i dati tecnici. Prova a riformulare la domanda.', "ai");
            }
          } else {
            addMessage('‚ùå Nessun risultato trovato su Google. Prova con termini diversi.', "ai");
          }
          
        } 
        // ‚úÖ STEP 2: √à una richiesta di auto USATE?
        else if (isUsedCarQuery(userMessage)) {
          hideTyping();
          const results = getUsedCarsResponse(userMessage);
          lastAiResponse = results;
          addMessage(results, "ai", true);
        } 
        // ‚úÖ STEP 3: √à una richiesta di auto NUOVE (allestimenti, confronti)
        else {
          const detectedModel = detectNewCarModel(userMessage);
          const searchResults = await searchNewCars(userMessage, detectedModel);
          
          const messages = [
            { role: "system", content: SYSTEM_PROMPT_NEW },
            { role: "user", content: userMessage }
          ];

          if (searchResults) {
            let context = `DATI UFFICIALI:\n\n${searchResults}\n\n`;
            
            if (detectedModel) {
              context += `MODELLO: ${detectedModel.brand} ${detectedModel.model}\n`;
              context += `ALLESTIMENTI: ${detectedModel.trims.join(', ')}\n`;
              
              // Aggiungi DATI TECNICI UFFICIALI se disponibili
              if (detectedModel.technical && Object.keys(detectedModel.technical).length > 0) {
                context += `\nüìä DATI TECNICI UFFICIALI (fonte: ${detectedModel.technical.source || 'configuratore'}):\n`;
                
                if (detectedModel.technical.dimensions) {
                  context += `‚Ä¢ Dimensioni: ${detectedModel.technical.dimensions.length || 'N/A'} x ${detectedModel.technical.dimensions.width || 'N/A'} x ${detectedModel.technical.dimensions.height || 'N/A'} mm\n`;
                }
                if (detectedModel.technical.weight) {
                  context += `‚Ä¢ Peso: ${detectedModel.technical.weight}\n`;
                }
                if (detectedModel.technical.performance) {
                  if (detectedModel.technical.performance.power) {
                    context += `‚Ä¢ Potenza: ${detectedModel.technical.performance.power}\n`;
                  }
                  if (detectedModel.technical.performance.acceleration) {
                    context += `‚Ä¢ Accelerazione: ${detectedModel.technical.performance.acceleration}\n`;
                  }
                  if (detectedModel.technical.performance.top_speed) {
                    context += `‚Ä¢ Velocit√† max: ${detectedModel.technical.performance.top_speed}\n`;
                  }
                }
                if (detectedModel.technical.consumption) {
                  context += `‚Ä¢ Consumi: ${detectedModel.technical.consumption}\n`;
                }
                if (detectedModel.technical.price_from) {
                  context += `‚Ä¢ Prezzo da: ${detectedModel.technical.price_from}\n`;
                }
                
                context += `\nIMPORTANTE: Questi sono i dati UFFICIALI verificati. Usali con precisione.\n`;
              }
              
              // Aggiungi restrizioni apprese
              if (Object.keys(detectedModel.restrictions).length > 0) {
                context += `\nRESTRIZIONI APPRESE:\n`;
                for (const [trim, restriction] of Object.entries(detectedModel.restrictions)) {
                  context += `- ${trim}: ${restriction}\n`;
                }
              }
            }
            
            // Aggiungi ultime correzioni rilevanti
            const relevantCorrections = learningData.corrections?.filter(c => 
              c.userMessage.toLowerCase().includes(userMessage.toLowerCase().split(' ')[0])
            ).slice(-3);
            
            if (relevantCorrections && relevantCorrections.length > 0) {
              context += `\nCORREZIONI OPERATORI APPRESE:\n`;
              relevantCorrections.forEach(c => {
                context += `- ${c.correction}\n`;
              });
            }
            
            context += `\nRispondi in modo SCHEMATICO.`;
            
            messages.push({ role: "system", content: context });
          }

          const response = await fetch(BACKEND_CHAT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ messages }),
          });

          if (!response.ok) throw new Error(`Errore ${response.status}`);

          const data = await response.json();
          hideTyping();

          let aiMessage = data.choices?.[0]?.message?.content || "Scusa, non ho trovato informazioni.";
          aiMessage = escapeHtml(aiMessage);
          lastAiResponse = aiMessage;
          addMessage(aiMessage, "ai", true);
        }

      } catch (error) {
        hideTyping();
        console.error("Errore chat:", error);
        addMessage("‚ùå Errore di connessione. Riprova!", "ai");
      } finally {
        chatSendBtn.disabled = false;
        chatInputField.focus();
      }
    }

    chatSendBtn.addEventListener("click", sendMessage);

    chatInputField.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
  </script>
</body>
</html>
